<div class="evaluacion-container">
  @if (rubrica) {
  <div class="rubrica-table">
    <!-- Encabezado de niveles (solo una vez) -->
    @if (rubrica.criterios.length > 0 && rubrica.criterios[0].nivelesDetalle) {
    <div class="rubrica-row rubrica-header-row">
      <div class="rubrica-cell criterio-label">Criterio</div>
      @for (nivel of rubrica.criterios[0].nivelesDetalle; track nivel.titulo; let j = $index) {
      <div class="rubrica-cell nivel-label"
        [class.nivel-insuficiente]="j === 0"
        [class.nivel-aceptable]="j === 1"
        [class.nivel-excelente]="j >= 2">
        {{ nivel.titulo }}
      </div>
      }
    </div>
    }
    <!-- Filas de criterios -->
    @for (criterio of rubrica.criterios; track criterio.titulo; let i = $index) {
    <div class="rubrica-row criterio-row">
      <div class="rubrica-cell criterio-cell">
        <span class="criterio-titulo">{{ criterio.titulo }}</span>
        <ion-badge color="primary">{{ criterio.peso }}</ion-badge>
      </div>
      @for (nivel of criterio.nivelesDetalle; track nivel.titulo; let j = $index) {
      <div class="rubrica-cell nivel-card"
        role="button"
        tabindex="0"
        [attr.aria-label]="'Seleccionar nivel ' + nivel.titulo + ' (' + nivel.puntos + ' puntos)'"
        [attr.aria-pressed]="estaEnRangoNivel(criterio.titulo, nivel.puntos)"
        [class.selected]="estaEnRangoNivel(criterio.titulo, nivel.puntos)"
        [class.nivel-insuficiente]="j === 0"
        [class.nivel-aceptable]="j === 1"
        [class.nivel-excelente]="j >= 2"
        (click)="onCalificacionChange(criterio.titulo, obtenerPuntosNivel(nivel.puntos))"
        (keydown.enter)="onCalificacionChange(criterio.titulo, obtenerPuntosNivel(nivel.puntos))"
        (keydown.space)="onCalificacionChange(criterio.titulo, obtenerPuntosNivel(nivel.puntos))">
        <div class="nivel-header">
          <ion-badge mode="ios">{{ nivel.puntos }} pts</ion-badge>
          @if (estaEnRangoNivel(criterio.titulo, nivel.puntos)) {
          <span class="check-icon">✓</span>
          }
        </div>
        <p class="nivel-descripcion">{{ nivel.descripcion }}</p>
      </div>
      }
    </div>
    }
  </div>
  } @else {
  <p class="loading-text">Cargando rúbrica...</p>
  }
</div>
