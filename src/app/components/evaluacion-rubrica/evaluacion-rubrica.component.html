<div class="evaluacion-container">

  <!-- DEBUG INFO: Eliminar en producci√≥n -->
  @if (!rubrica) {
  <ion-item color="warning">
    <ion-label>‚ö†Ô∏è Cargando r√∫brica o datos no disponibles...</ion-label>
  </ion-item>
  }

  @if (rubrica) {
  <!-- Criterios de evaluaci√≥n -->
  <div class="criterios-container">
    @for (criterio of rubrica.criterios; track criterio.titulo; let i = $index) {
    <ion-card>
      <ion-card-content>
        <div class="criterio-header">
          <ion-card-title style="font-size: 1.1rem;">{{ criterio.titulo }}</ion-card-title>
          <ion-badge color="primary">Peso: {{ criterio.peso }}</ion-badge>
        </div>

        <!-- Niveles con scroll horizontal (Swipe) -->
        <div class="niveles-scroll-container">
          @if (!criterio.nivelesDetalle || criterio.nivelesDetalle.length === 0) {
          <p>‚ö†Ô∏è No hay niveles definidos para este criterio.</p>
          }

          @for (nivel of criterio.nivelesDetalle; track nivel.titulo) {
          <!-- Tarjeta de Nivel Interactiva -->
          <div class="nivel-card"
            [class.selected]="calificaciones[criterio.titulo] === obtenerPuntosNivel(nivel.puntos)"
            (click)="onCalificacionChange(criterio.titulo, obtenerPuntosNivel(nivel.puntos))">

            <div class="nivel-puntos">
              <ion-badge [color]="obtenerColorNota()" mode="ios">{{ nivel.puntos }} pts</ion-badge>
              <div class="selection-indicator">
                <span>‚úÖ</span>
              </div>
            </div>

            <div class="nivel-titulo">{{ nivel.titulo }}</div>
            <p class="nivel-descripcion">{{ nivel.descripcion }}</p>
          </div>
          }
        </div>

        <!-- Feedback de selecci√≥n (opcional, ya visualmente claro con la tarjeta) -->
        @if (obtenerNivelSeleccionado(criterio)) {
        <div class="ion-text-center ion-padding-top">
          <ion-text color="success" style="font-size: 0.9rem;">
            <small>Seleccionado: <strong>{{ obtenerNivelSeleccionado(criterio).titulo }}</strong> ({{
              calificaciones[criterio.titulo] }} pts)</small>
          </ion-text>
        </div>
        }

      </ion-card-content>
    </ion-card>
    }
  </div>



  <!-- Observaciones -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        üí¨ Observaciones
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-textarea [(ngModel)]="observaciones" placeholder="Comentarios adicionales sobre la evaluaci√≥n..." rows="4"
        fill="outline">
      </ion-textarea>
    </ion-card-content>
  </ion-card>

  <!-- Botones de acci√≥n -->
  <div class="action-buttons">
    <ion-button expand="block" color="primary" size="large" (click)="guardarEvaluacion()">
      üíæ Guardar Evaluaci√≥n
    </ion-button>

    <ion-button expand="block" fill="outline" color="medium" (click)="cerrar()">
      ‚úñ Cancelar
    </ion-button>
  </div>
  } @else {
  <ion-card>
    <ion-card-content>
      <p class="ion-text-center">Cargando r√∫brica...</p>
    </ion-card-content>
  </ion-card>
  }
</div>