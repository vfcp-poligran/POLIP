<ion-content [fullscreen]="true">
  <div class="page-container">
    <div class="tab-content calificaciones-tab-content">

      <!-- Título de la página -->
      <div class="page-title-header">
        <ion-icon name="ribbon"></ion-icon>
        <h2>Calificaciones Canvas</h2>
      </div>

      <!-- Barra de botones de cursos -->
      <div class="cursos-botones-bar">
        @if (cursosConCalificaciones.length > 0) {
          @for (curso of cursosConCalificaciones; track curso.codigo) {
            <button
              class="curso-btn"
              [class.activo]="cursoCalificacionesSeleccionado === curso.codigo"
              (click)="seleccionarCursoCalificaciones(curso.codigo)">
              {{ curso.codigo }}
            </button>
          }
        } @else {
          <div class="no-cursos-msg">
            <ion-icon name="folder"></ion-icon>
            <span>No hay archivos de calificaciones cargados</span>
          </div>
        }
      </div>

      <!-- Header con info del archivo y acciones -->
      @if (cursoCalificacionesSeleccionado && filasCalificaciones.length > 0) {
        <div class="header-selector-cursos">
          <div class="selector-left">
            <span class="selector-label">{{ obtenerNombreCursoSeleccionado() }}</span>
          </div>
          <div class="selector-right">
            <span class="archivo-nombre">
              <ion-icon name="document-text"></ion-icon>
              {{ archivoCalificacionesVisualizacion?.nombre }}
            </span>
            <span class="archivo-fecha">{{ formatearFecha(archivoCalificacionesVisualizacion?.fechaCarga) }}</span>
            <ion-button size="small" fill="solid" color="success"
              (click)="exportarCalificaciones(cursoCalificacionesSeleccionado)">
              <ion-icon name="download" slot="start"></ion-icon>
              Exportar
            </ion-button>
            <ion-button size="small" fill="outline" color="danger"
              (click)="eliminarArchivoCalificacionesCurso(cursoCalificacionesSeleccionado)">
              <ion-icon name="trash" slot="start"></ion-icon>
              Eliminar
            </ion-button>
          </div>
        </div>
      }

      <!-- Área principal: Tabla de calificaciones -->
      <div class="tabla-area">
        @if (cursoCalificacionesSeleccionado && filasCompletas.length > 0) {
          <!-- Info de conteo -->
          <div class="tabla-info-bar">
            <ion-chip color="primary" class="chip-info">
              <ion-icon name="people"></ion-icon>
              <ion-label>{{ filasCompletas.length }} estudiantes</ion-label>
            </ion-chip>
          </div>

          <!-- Tabla con scroll horizontal y vertical -->
          <div class="tabla-wrapper tabla-completa">
            <table class="tabla-calificaciones">
              <thead>
                <tr>
                  <!-- Columna fija: Grupo (del curso) -->
                  <th class="tabla-header col-grupo col-sticky">Grupo</th>
                  <!-- Headers originales del CSV -->
                  @for (col of getHeadersVisibles(); track col.indice) {
                    <th class="tabla-header"
                        [class.col-estudiante]="col.header === 'Student'"
                        [class.col-id]="col.header === 'ID'"
                        [class.col-numeric]="esColumnaEditable(col.indice)"
                        [class.col-editable]="esColumnaEditable(col.indice)">
                      {{ col.header }}
                    </th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (fila of filasCompletas; track fila.filaOriginalIndex; let i = $index; let isOdd = $odd) {
                  <tr [class.fila-par]="!isOdd" [class.fila-impar]="isOdd">
                    <!-- Columna fija: Grupo -->
                    <td class="tabla-cell col-grupo col-sticky">
                      <span class="grupo-badge">{{ fila.grupo }}</span>
                    </td>
                    <!-- Columnas del CSV -->
                    @for (col of getHeadersVisibles(); track col.indice) {
                      <td class="tabla-cell"
                          [class.col-estudiante]="col.header === 'Student'"
                          [class.col-id]="col.header === 'ID'"
                          [class.cell-numeric]="esColumnaEditable(col.indice)"
                          [class.col-editable]="esColumnaEditable(col.indice)"
                          [class.editing]="estaEditandoCelda(i, col.indice)"
                          (click)="esColumnaEditable(col.indice) ? iniciarEdicionCelda(i, col.indice) : null">
                        @if (estaEditandoCelda(i, col.indice)) {
                          <input type="text"
                                 class="edit-input"
                                 placeholder="Valor"
                                 [title]="'Editar ' + col.header"
                                 [(ngModel)]="valorEditando"
                                 (blur)="guardarEdicionCelda()"
                                 (keydown)="onKeyDown($event)"
                                 autofocus />
                        } @else {
                          {{ fila.valores[col.indice] || '-' }}
                        }
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <!-- Empty state -->
          <div class="empty-state">
            <ion-icon name="stats-chart"></ion-icon>
            <p>Selecciona un curso para ver sus calificaciones de Canvas</p>
          </div>
        }
      </div>

    </div>
  </div>
</ion-content>
