<ion-content [fullscreen]="false">

  <!-- ======================================== -->
  <!-- 1. FABs FLOTANTES -->
  <!-- ======================================== -->

  <!-- FAB Crear Curso -->
  @if (!modoEdicion()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 70px" class="ion-hide-md-up">
    <ion-fab-button [color]="BUTTON_CONFIG.CREAR.color" (click)="iniciarCreacionCurso()"
      [attr.aria-label]="BUTTON_CONFIG.CREAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.CREAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }

  <!-- FABs de edición -->
  @if (modoEdicion()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 70px" class="ion-hide-md-up">
    <ion-fab-button [color]="BUTTON_CONFIG.GUARDAR.color" (click)="guardarCurso()"
      [attr.aria-label]="BUTTON_CONFIG.GUARDAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.GUARDAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 134px" class="ion-hide-md-up">
    <ion-fab-button [color]="BUTTON_CONFIG.CANCELAR.color" (click)="cancelarCreacionCurso()"
      [attr.aria-label]="BUTTON_CONFIG.CANCELAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.CANCELAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }

  <div class="page-container" id="main-content" role="main">
    <!-- ======================================== -->
    <!-- 2. HEADER DE PÁGINA -->
    <!-- ======================================== -->
    <div class="page-title-header">
      <div class="title-wrapper">
        <h2>Cursos</h2>
      </div>
      <div class="header-actions">
        @if (!modoEdicion()) {
        <ion-button size="small" fill="solid" color="success" (click)="iniciarCreacionCurso()"
          [attr.aria-label]="BUTTON_CONFIG.CREAR.ariaLabel">
          <ion-icon name="add-circle" slot="start"></ion-icon>
          Crear
        </ion-button>
        @if (cursoSeleccionado()) {
        <ion-button size="small" fill="solid" [color]="BUTTON_CONFIG.EDITAR.color"
          (click)="editarCursoSeleccionadoDesdeHeader()" [attr.aria-label]="BUTTON_CONFIG.EDITAR.ariaLabel">
          <ion-icon [name]="BUTTON_CONFIG.EDITAR.icon" slot="start"></ion-icon>
          {{ BUTTON_CONFIG.EDITAR.label }}
        </ion-button>
        <ion-button size="small" fill="solid" [color]="BUTTON_CONFIG.ELIMINAR.color"
          (click)="eliminarCursoSeleccionadoDesdeHeader()" [attr.aria-label]="BUTTON_CONFIG.ELIMINAR.ariaLabel">
          <ion-icon [name]="BUTTON_CONFIG.ELIMINAR.icon" slot="start"></ion-icon>
          {{ BUTTON_CONFIG.ELIMINAR.label }}
        </ion-button>
        }
        } @else {
        <ion-button size="small" fill="solid" color="primary" (click)="guardarCurso()"
          [attr.aria-label]="BUTTON_CONFIG.GUARDAR.ariaLabel">
          <ion-icon [name]="BUTTON_CONFIG.GUARDAR.icon" slot="start"></ion-icon>
          {{ BUTTON_CONFIG.GUARDAR.label }}
        </ion-button>
        <ion-button size="small" fill="solid" color="warning" (click)="cancelarCreacionCurso()"
          [attr.aria-label]="BUTTON_CONFIG.CANCELAR.ariaLabel">
          {{ BUTTON_CONFIG.CANCELAR.label }}
        </ion-button>
        }
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 3. CONTENEDOR PRINCIPAL DE CURSOS -->
    <!-- ======================================== -->
    @if (cursosDisponibles().length > 0 || (modoEdicion() && !cursoSeleccionado())) {
    <div class="cursos-container" [class.solo-uno]="cursosDisponibles().length === 0 && modoEdicion()">
      <!-- Tabs superiores de selección de curso -->
      <ion-segment
        [value]="cursoSeleccionado() || (modoEdicion() && !cursoSeleccionado() ? 'NUEVO' : cursosDisponibles()[0]?.codigo)"
        (ionChange)="seleccionarCurso($any($event).detail.value)" scrollable layout="icon-top">

        <!-- Tab Virtual de Nuevo Curso -->
        @if (modoEdicion() && !cursoSeleccionado()) {
        <ion-segment-button value="NUEVO">
          <ion-label>Sin Nombre</ion-label>
        </ion-segment-button>
        }

        <!-- Tabs de cursos existentes -->
        @for (curso of cursosDisponibles(); track curso.codigo) {
        <ion-segment-button [value]="curso.codigo" [style.--course-stripe-color]="getCursoColor(curso.codigo)">
          <ion-label class="tab-label-container">
            <div class="tab-content-wrapper">
              <span class="tab-nombre">{{ curso.nombre }}</span>
              <span class="tab-codigo">{{ curso.codigo }}</span>
            </div>
          </ion-label>
        </ion-segment-button>
        }
      </ion-segment>

      <!-- Contenido de la tarjeta del curso seleccionado o en creación -->
      @if (infoParaMostrar(); as info) {
      <ion-card class="curso-card" [class.active]="info.tieneCalificaciones" [class.no-data]="!info.tieneCalificaciones"
        [class.es-nuevo]="info.esNuevo" [style.--curso-color]="info.color">

        <!-- Header sin acciones (movidas al tab) -->
        <div class="curso-card-header">
          <div class="curso-header-info">
            <ion-icon name="information-circle" class="header-icon"></ion-icon>
            <h2 class="header-main-title">Información del Curso</h2>
          </div>
        </div>

        <div class="curso-card-content">
          <!-- Subtabs: Detalle / Integrantes -->
          <ion-segment [value]="subtabActivo()" (ionChange)="subtabActivo.set($any($event).detail.value)" scrollable>
            <ion-segment-button value="detalle">
              <ion-label>Características</ion-label>
            </ion-segment-button>

            <!-- Solo mostrar Integrantes para cursos que ya existen -->
            @if (!info.esNuevo) {
            <ion-segment-button value="integrantes">
              <ion-icon name="people"></ion-icon>
              <ion-label>Integrantes</ion-label>
            </ion-segment-button>
            }
          </ion-segment>

          <!-- SUBTAB: Detalle (Unificado para Lectura/Edición/Creación) -->
          @if (subtabActivo() === 'detalle') {
          <div class="subtab-content detail-compact-layout">
            <ion-card class="compact-info-card"
              [class.editing-view]="modoEdicion() && (codigoCursoEnEdicion === info.claveCurso || info.esNuevo)">

              <!-- VISTA EDICIÓN O CREACIÓN -->
              @if (modoEdicion() && (codigoCursoEnEdicion === info.claveCurso || info.esNuevo)) {
              <div class="compact-form-section editing">
                <div class="form-main-grid">

                  <!-- Columna Arriba/Izquierda: Importación (Prioridad) -->
                  <div class="import-side">
                    <h4 class="section-title">{{ info.esNuevo ? 'Cargar Estudiantes' : 'Actualizar Datos' }}</h4>

                    <div class="import-cloud-grid">
                      <!-- Import Personas -->
                      <div class="import-cloud-item" (click)="importEstudiantesInput.click()">
                        <div class="cloud-icon-wrapper">
                          <ion-icon name="cloud-upload"
                            [style.color]="estudiantesFileName ? 'var(--ion-color-success)' : '#FF00FF'"></ion-icon>
                          <div class="cloud-label">Importar (Personas)</div>
                        </div>
                        <input type="file" #importEstudiantesInput accept=".csv"
                          (change)="onEstudiantesFileSelected($event)" hidden />
                        @if (estudiantesFileName) {
                        <ion-chip color="primary" size="small" (click)="$event.stopPropagation()">
                          <ion-label>{{ estudiantesFileName }}</ion-label>
                          <ion-icon name="close-circle" (click)="limpiarEstudiantes()"></ion-icon>
                        </ion-chip>
                        }
                      </div>

                      <!-- Import Calificaciones -->
                      <div class="import-cloud-item" (click)="importCalificacionesInput.click()">
                        <div class="cloud-icon-wrapper">
                          <ion-icon name="cloud-upload"
                            [style.color]="calificacionesFileName ? 'var(--ion-color-success)' : '#FF00FF'"></ion-icon>
                          <div class="cloud-label">Importar (Calificaciones)</div>
                        </div>
                        <input type="file" #importCalificacionesInput accept=".csv"
                          (change)="onCalificacionesFileSelected($event)" hidden />
                        @if (calificacionesFileName) {
                        <ion-chip color="primary" size="small" (click)="$event.stopPropagation()">
                          <ion-label>{{ calificacionesFileName }}</ion-label>
                          <ion-icon name="close-circle" (click)="limpiarCalificaciones()"></ion-icon>
                        </ion-chip>
                        }
                      </div>
                    </div>
                  </div>

                  <!-- Sección de Características del Curso (independiente) -->
                  @if (cursoParseado) {
                  <ion-grid class="parsed-course-info">
                    <!-- Fila 1: Nombre del Curso (ancho completo) -->
                    <ion-row>
                      <ion-col size="12">
                        <div class="characteristic-item">
                          <h4 class="label">Nombre del Curso</h4>
                          <p class="value">{{ cursoParseado.nombre || info.nombre || '—' }}</p>
                        </div>
                      </ion-col>
                    </ion-row>

                    <!-- Fila 2: Código, Ingreso, Bloque, Modalidad, Año (Suman 12) -->
                    <ion-row>
                      <ion-col size="6" size-md="2">
                        <div class="characteristic-item">
                          <h4 class="label">Código</h4>
                          <p class="value">{{ getDisplayCode(cursoParseado) || info.codigoDisplay }}</p>
                        </div>
                      </ion-col>
                      <ion-col size="6" size-md="2">
                        <div class="characteristic-item">
                          <h4 class="label">Ingreso</h4>
                          <p class="value">{{ cursoParseado.ingreso || info.ingreso || '—' }}</p>
                        </div>
                      </ion-col>
                      <ion-col size="6" size-md="3">
                        <div class="characteristic-item">
                          <h4 class="label">Bloque</h4>
                          <p class="value">{{ (cursoParseado.bloque || info.bloque || '—') | capitalize }}</p>
                        </div>
                      </ion-col>
                      <ion-col size="6" size-md="3">
                        <div class="characteristic-item">
                          <h4 class="label">Modalidad</h4>
                          <p class="value">{{ (cursoParseado.modalidad || info.modalidad || 'Virtual') | capitalize }}
                          </p>
                        </div>
                      </ion-col>
                      <ion-col size="12" size-md="2">
                        <div class="characteristic-item">
                          <h4 class="label">Año</h4>
                          <p class="value">{{ cursoParseado.anio || info.anio || '—' }}</p>
                        </div>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                  } @else {
                  <div class="empty-import-state">
                    <ion-icon name="cloud-upload" color="medium"></ion-icon>
                    <p>Importa un archivo para ver los datos del curso</p>
                  </div>
                  }
                </div>

                <!-- Selector de Color del Curso -->
                <div class="color-selector-section">
                  <!-- Bot\u00f3n para abrir/cerrar color picker -->
                  <button type="button" class="color-toggle-button" (click)="toggleColorPicker()">
                    <div class="color-preview-swatch" [style.background-color]="colorCursoSeleccionado || '#1fb2de'">
                    </div>
                    <span class="color-label">Color del Curso</span>
                    <ion-icon [name]="showColorPicker ? 'chevron-up' : 'chevron-down'"></ion-icon>
                  </button>

                  <!-- Grid de colores (colapsable) -->
                  @if (showColorPicker) {
                  <div class="color-grid">
                    @for (color of coloresDisponibles; track color) {
                    <button type="button" class="color-button" [class.selected]="colorCursoSeleccionado === color"
                      [style.background-color]="color" (click)="seleccionarColorCurso(color)"
                      [attr.aria-label]="'Seleccionar color ' + color">
                      @if (colorCursoSeleccionado === color) {
                      <ion-icon name="checkmark" class="check-icon"></ion-icon>
                      }
                    </button>
                    }
                  </div>
                  }
                </div>

                <!-- Columna Abajo/Derecha: Configuración (solo en edición, no en creación) -->
                @if (!info.esNuevo) {
                <div class="config-side">
                  <h4 class="section-title">Parámetros de Cohorte</h4>
                  <div class="form-grid">
                    <ion-select [(ngModel)]="cohorteForm.ingreso" (ionChange)="onIngresoChange()" label="Ingreso"
                      labelPlacement="stacked" interface="popover" fill="outline">
                      <ion-select-option value="A">A</ion-select-option>
                      <ion-select-option value="B">B</ion-select-option>
                      <ion-select-option value="C">C</ion-select-option>
                    </ion-select>

                    <ion-select [(ngModel)]="cohorteForm.bloque" (ionChange)="onBloqueChange()" label="Bloque"
                      labelPlacement="stacked" interface="popover" fill="outline">
                      <ion-select-option value="PRIMERO">PRIMERO</ion-select-option>
                      <ion-select-option value="SEGUNDO">SEGUNDO</ion-select-option>
                      <ion-select-option value="TRANSVERSAL">TRANSVERSAL</ion-select-option>
                    </ion-select>

                    <ion-select [(ngModel)]="cohorteForm.anio" (ionChange)="onCambioCohorte()" label="Año"
                      labelPlacement="stacked" interface="popover" fill="outline">
                      @for (anio of aniosDisponibles(); track anio) {
                      <ion-select-option [value]="anio.toString()">{{ anio }}</ion-select-option>
                      }
                    </ion-select>
                  </div>
                </div>
                }

              </div>
          </div>
          } @else {
          <!-- VISTA LECTURA -->
          <ion-grid class="parsed-course-info">
            <!-- Fila 1: Nombre del Curso (ancho completo) -->
            <ion-row>
              <ion-col size="12">
                <div class="characteristic-item">
                  <h4 class="label">Nombre del Curso</h4>
                  <p class="value">{{ info.nombre || '—' }}</p>
                </div>
              </ion-col>
            </ion-row>

            <!-- Fila 2: Código, Ingreso, Bloque, Modalidad, Año (Suman 12) -->
            <ion-row>
              <ion-col size="6" size-md="2">
                <div class="characteristic-item">
                  <h4 class="label">Código</h4>
                  <p class="value">{{ info.codigoDisplay }}</p>
                </div>
              </ion-col>
              <ion-col size="6" size-md="2">
                <div class="characteristic-item">
                  <h4 class="label">Ingreso</h4>
                  <p class="value">{{ info.ingreso || '—' }}</p>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="characteristic-item">
                  <h4 class="label">Bloque</h4>
                  <p class="value">{{ (info.bloque || '—') | capitalize }}</p>
                </div>
              </ion-col>
              <ion-col size="6" size-md="3">
                <div class="characteristic-item">
                  <h4 class="label">Modalidad</h4>
                  <p class="value">{{ (info.modalidad || '—') | capitalize }}</p>
                </div>
              </ion-col>
              <ion-col size="12" size-md="2">
                <div class="characteristic-item">
                  <h4 class="label">Año</h4>
                  <p class="value">{{ info.anio || '—' }}</p>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>

          <div class="compact-rubricas-section">
            <h4 class="section-title">Rúbricas asociadas</h4>
            @if (rubricasAsociadas.length > 0) {
            <div class="compact-rubricas-list">
              @for (rubrica of rubricasAsociadas; track rubrica.id) {
              <ion-chip outline="true" size="small">
                <ion-label>{{ rubrica.nombre }}</ion-label>
              </ion-chip>
              }
            </div>
            } @else {
            <p class="no-data">No hay rúbricas</p>
            }
          </div>
          }
      </ion-card>
    </div>
    }

    <!-- SUBTAB: Integrantes -->
    @if (subtabActivo() === 'integrantes') {
    <div class="subtab-content">
      <!-- Tabs de grupos -->
      <ion-segment [value]="grupoActivo()" (ionChange)="grupoActivo.set($any($event).detail.value)" scrollable>
        <ion-segment-button value="todos">
          Todos ({{ estudiantesCurso().length }})
        </ion-segment-button>
        @for (grupo of gruposCurso(); track grupo) {
        <ion-segment-button [value]="grupo">
          {{ grupo }} ({{ contarIntegrantes(grupo) }})
        </ion-segment-button>
        }
      </ion-segment>

      <!-- Lista de estudiantes -->
      @if (estudiantesFiltrados() && estudiantesFiltrados().length > 0) {
      <ion-list>
        @for (est of estudiantesFiltrados(); track est.correo) {
        <ion-item>
          <ion-badge slot="start" color="light">{{ est?.grupo || '-' }}</ion-badge>
          <ion-label>
            <h3>{{ est?.nombres }} {{ est?.apellidos }}</h3>
            <p>{{ est?.correo }}</p>
          </ion-label>
          <ion-note slot="end">
            E1: {{ est?.notas?.e1 || '-' }} | E2: {{ est?.notas?.e2 || '-' }} | EF: {{ est?.notas?.ef || '-' }}
          </ion-note>
        </ion-item>
        }
      </ion-list>
      } @else {
      <div class="empty-state-mini">
        <p>No hay estudiantes en este grupo</p>
      </div>
      }
    </div>
    }
  </div>
  </ion-card>
  }
  </div>
  } @else {
  <!-- Estado vacío (No hay cursos y no estamos creando) -->
  <div class="empty-state">
    <ion-icon name="library"></ion-icon>
    <h3>No hay cursos registrados</h3>
    <p>Presione "Crear" para agregar un nuevo curso</p>
  </div>
  }
  </div>
</ion-content>