<ion-content [fullscreen]="true">
  <!-- FAB flotante para crear curso (móvil/tablet) -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="fab-crear-curso">
    @if (!modoEdicion()) {
    <ion-fab-button color="success" (click)="iniciarCreacionCurso()" aria-label="Crear nuevo curso">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
    }
  </ion-fab>

  <!-- FAB Guardar (móvil/tablet) - Verde, inferior derecha -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="fab-guardar-curso">
    @if (modoEdicion()) {
    <ion-fab-button color="success" (click)="guardarCurso()" aria-label="Guardar curso">
      <ion-icon name="save-outline"></ion-icon>
    </ion-fab-button>
    }
  </ion-fab>

  <!-- FAB Cancelar (móvil/tablet) - Amarillo con X, inferior derecha (más arriba) -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="fab-cancelar-curso">
    @if (modoEdicion()) {
    <ion-fab-button color="warning" (click)="cancelarCreacionCurso()" aria-label="Cancelar">
      <ion-icon name="close-outline"></ion-icon>
    </ion-fab-button>
    }
  </ion-fab>

  <div class="page-container">
    <div class="tab-content cursos-tab-content">

      <!-- Título de la página -->
      <div class="page-title-header">
        <div class="title-wrapper">
          <h2>Cursos</h2>
        </div>
        <div class="header-actions ion-hide-md-down">
          @if (!modoEdicion()) {
          <ion-button size="small" fill="solid" color="success" (click)="iniciarCreacionCurso()" class="btn-add-curso">
            <ion-icon name="add-circle-outline" slot="start"></ion-icon>
            Crear
          </ion-button>
          } @else {
          <ion-button size="small" fill="solid" color="primary" (click)="guardarCurso()">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Guardar
          </ion-button>
          <ion-button size="small" fill="solid" color="warning" (click)="cancelarCreacionCurso()">
            Cancelar
          </ion-button>
          }
        </div>
        <!-- Botones removidos - ahora se usan FABs flotantes -->
      </div>

      @if (modoEdicion()) {
      <!-- ============================================ -->
      <!-- 1. SECCIÓN DE IMPORTACIÓN (Prioridad Visual) -->
      <!-- ============================================ -->
      <div class="upload-wrapper" [class.expanded]="infoExpanded">
        <!-- Mensaje instructivo con icono -->
        <div class="upload-instructions">
          <ion-icon name="information-circle-outline" (click)="toggleInfo()"></ion-icon>
          <span class="info-text">Cargue los archivos en formato CSV de Personas y Calificaciones del LMS Canvas</span>
        </div>

        <!-- Barra de info (Personas y Calificaciones) -->
        <div class="tabla-info-bar">
          <!-- Input oculto para archivo de estudiantes -->
          <input type="file" #estudiantesFileInput accept=".csv" (change)="onEstudiantesFileSelected($event)"
            class="file-input-hidden" aria-label="Cargar archivo CSV de estudiantes" />

          <!-- Input oculto para archivo de calificaciones -->
          <input type="file" #calificacionesFileInput accept=".csv" (change)="onCalificacionesFileSelected($event)"
            class="file-input-hidden" aria-label="Cargar archivo CSV de calificaciones" />

          <div class="upload-section">
            <div class="upload-btn-container" (click)="estudiantesFileInput.click()">
              <ion-icon name="cloud-upload"></ion-icon>
              <span class="btn-label">Personas</span>
            </div>
            @if (estudiantesFileName) {
            <div class="file-loaded-info">
              <div class="file-details">
                <span class="file-full-name">{{ estudiantesFileName }}</span>
                <ion-icon name="close-circle" (click)="limpiarEstudiantes()" class="remove-file"></ion-icon>
              </div>
            </div>
            }
          </div>

          <div class="upload-section">
            <div class="upload-btn-container" (click)="calificacionesFileInput.click()">
              <ion-icon name="cloud-upload"></ion-icon>
              <span class="btn-label">Calificaciones</span>
            </div>
            @if (calificacionesFileName) {
            <div class="file-loaded-info">
              <div class="file-details">
                <span class="file-full-name">{{ calificacionesFileName }}</span>
                <ion-icon name="close-circle" (click)="limpiarCalificaciones()" class="remove-file"></ion-icon>
              </div>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- 2. SECCIÓN DE COLOR DEL CURSO -->
      <!-- ============================================ -->
      <div class="color-selector-section">
        <div class="color-selector-header">
          <ion-icon name="color-palette-outline"></ion-icon>
          <span>Color del curso</span>
        </div>
        <div class="color-picker-grid">
          @for (color of coloresDisponibles; track color) {
          <div class="color-option" [style.background-color]="color" [class.selected]="colorCursoSeleccionado === color"
            (click)="seleccionarColorCurso(color)">
            @if (colorCursoSeleccionado === color) {
            <ion-icon name="checkmark"></ion-icon>
            }
          </div>
          }
        </div>
      </div>

      <!-- ============================================ -->
      <!-- 3. INFORMACIÓN DE COHORTE -->
      <!-- ============================================ -->
      <div class="cohorte-section">
        <div class="cohorte-header">
          <ion-icon name="calendar-outline"></ion-icon>
          <span>Información de Cohorte</span>
          @if (nombreCohorteGenerado()) {
          <ion-badge color="primary" class="cohorte-badge">{{ nombreCohorteGenerado() }}</ion-badge>
          }
        </div>

        <div class="cohorte-form-grid">
          <ion-item lines="none" class="cohorte-input-item">
            <ion-label position="stacked">Año</ion-label>
            <ion-datetime [(ngModel)]="cohorteForm.anio" (ionChange)="onCambioCohorte()" presentation="year"
              locale="es-ES">
            </ion-datetime>
          </ion-item>

          <ion-item lines="none" class="cohorte-input-item">
            <ion-label position="stacked">Ingreso (Opcional)</ion-label>
            <ion-select [(ngModel)]="cohorteForm.ingreso" (ionChange)="onCambioCohorte(); onIngresoChange()"
              placeholder="Seleccionar" interface="popover">
              <ion-select-option value="A">A (~120 días)</ion-select-option>
              <ion-select-option value="B">B (~132 días)</ion-select-option>
              <ion-select-option value="C">C (~105 días)</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item lines="none" class="cohorte-input-item">
            <ion-label position="stacked">Fecha Inicio</ion-label>
            <ion-datetime [(ngModel)]="cohorteForm.fechaInicio" (ionChange)="onFechaInicioChange()" presentation="date"
              locale="es-ES">
            </ion-datetime>
          </ion-item>

          <ion-item lines="none" class="cohorte-input-item">
            <ion-label position="stacked">Fecha Fin</ion-label>
            <ion-datetime [(ngModel)]="cohorteForm.fechaFin" (ionChange)="onFechaFinManualChange()" presentation="date"
              locale="es-ES">
            </ion-datetime>
          </ion-item>
        </div>
      </div>


      }

      <!-- Área principal: Tarjetas de cursos -->
      <div class="cards-area">
        @if (cursosDisponibles().length > 0) {
        <ion-list class="curso-list">
          @for (curso of cursosDisponibles(); track curso.codigo) {
          <ion-item-sliding>
            <ion-item class="curso-card-item" [class.selected]="cursoSeleccionado() === curso.codigo"
              (click)="seleccionarCurso(curso.codigo)" button>
              <div class="curso-card-content" slot="start">
                <div class="curso-card-header">
                  <div class="curso-card-top">
                    <ion-chip class="estado-chip" [color]="curso.tieneCalificaciones ? 'success' : 'warning'">
                      <ion-icon
                        [name]="curso.tieneCalificaciones ? 'checkmark-circle-outline' : 'ellipse-outline'"></ion-icon>
                    </ion-chip>
                    <ion-chip class="color-indicator" [style.background]="getCursoColor(curso.codigo)"></ion-chip>
                  </div>
                  <div class="curso-info">
                    <h3 class="curso-nombre">{{ curso.nombre }}</h3>
                    <p class="curso-codigo-label">{{ curso.codigo }}</p>
                  </div>
                </div>
              </div>
              <div class="curso-actions-right" slot="end">
                <ion-button size="small" fill="clear" color="primary"
                  (click)="editarCurso(curso); $event.stopPropagation()" title="Editar curso">
                  <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                </ion-button>
                <ion-button size="small" fill="clear" color="danger"
                  (click)="confirmarEliminarCurso(curso); $event.stopPropagation()" title="Eliminar curso">
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-item>

            <ion-item-options side="end">
              <ion-item-option color="primary" (click)="editarCurso(curso)">
                <ion-icon slot="icon-only" name="create-outline"></ion-icon>
              </ion-item-option>
              <ion-item-option color="danger" (click)="confirmarEliminarCurso(curso)">
                <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>
          }
        </ion-list>

        @if (cursoSeleccionadoInfo()) {
        <ion-card class="curso-detail-card">
          <ion-card-header>
            <ion-card-title>Detalle de {{ cursoSeleccionadoInfo()!.nombre }}</ion-card-title>
            <ion-chip class="estado-chip"
              [color]="cursoSeleccionadoInfo()!.tieneCalificaciones ? 'success' : 'warning'">
              <ion-icon
                [name]="cursoSeleccionadoInfo()!.tieneCalificaciones ? 'checkmark-circle-outline' : 'ellipse-outline'"></ion-icon>
              {{ cursoSeleccionadoInfo()!.tieneCalificaciones ? 'Activo' : 'Sin datos' }}
            </ion-chip>
          </ion-card-header>
          <ion-card-content>
            <div class="detalle-grid">
              <div class="detalle-item">
                <span class="detalle-label">Código base</span>
                <span class="detalle-value">{{ cursoSeleccionadoInfo()!.codigoBase || '—' }}</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Bloque</span>
                <span class="detalle-value">{{ cursoSeleccionadoInfo()!.bloque || '—' }}</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Color</span>
                <span class="detalle-value color-dot"
                  [style.background]="getCursoColor(cursoSeleccionadoInfo()!.codigo)"></span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Estudiantes</span>
                <span class="detalle-value">{{ estudiantesCurso().length }}</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Grupos</span>
                <span class="detalle-value">{{ gruposCurso().length }}</span>
              </div>
            </div>

            <!-- Sección de Grupos como Tabs -->
            <div class="grupos-tabs-section">
              <div class="grupos-tabs-header">
                <h4>
                  <ion-icon name="people-outline"></ion-icon>
                  Integrantes del Curso ({{ estudiantesCurso().length }} estudiantes, {{ gruposCurso().length }} grupos)
                </h4>
              </div>

              @if (estudiantesCurso().length > 0) {
              <!-- Tabs de grupos -->
              <div class="grupos-tabs-bar">
                <button type="button" class="grupo-tab" [class.active]="vistaActiva() === 'general'"
                  (click)="seleccionarVista('general')">
                  <ion-icon name="apps-outline"></ion-icon>
                  <span>Todos</span>
                  <span class="badge">{{ estudiantesCurso().length }}</span>
                </button>
                @for (grupo of gruposCurso(); track grupo) {
                <button type="button" class="grupo-tab" [class.active]="vistaActiva() === grupo"
                  (click)="seleccionarVista(grupo)">
                  <span class="grupo-numero">{{ grupo }}</span>
                  <span class="badge">{{ contarIntegrantes(grupo) }}</span>
                </button>
                }
              </div>

              <!-- Contenido del tab seleccionado -->
              <div class="grupo-tab-content">
                <div class="tab-content-header">
                  @if (vistaActiva() === 'general') {
                  <ion-icon name="list-outline"></ion-icon>
                  <span>Todos los estudiantes ({{ estudiantesCurso().length }})</span>
                  } @else {
                  <ion-icon name="people"></ion-icon>
                  <span>Grupo {{ vistaActiva() }} - {{ integrantesGrupo().length }} integrantes</span>
                  }
                </div>

                <!-- Lista de integrantes -->
                @if (integrantesGrupo().length > 0) {
                <div class="tabla-wrapper tabla-completa">
                  <table class="tabla-calificaciones">
                    <thead>
                      <tr>
                        <th class="tabla-header col-grupo col-sticky">Grupo</th>
                        <th class="tabla-header col-estudiante">Estudiante</th>
                        <th class="tabla-header col-id">ID</th>
                        <th class="tabla-header col-numeric">E1</th>
                        <th class="tabla-header col-numeric">E2</th>
                        <th class="tabla-header col-numeric">EF</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (estudiante of integrantesGrupo(); track estudiante.correo; let isOdd = $odd) {
                      <tr [class.fila-par]="!isOdd" [class.fila-impar]="isOdd">
                        <td class="tabla-cell col-grupo col-sticky">
                          <ion-badge color="light" class="grupo-badge">{{ estudiante.grupo }}</ion-badge>
                        </td>
                        <td class="tabla-cell col-estudiante">
                          <div class="integrante-info-table">
                            <span class="nombre">{{ estudiante.nombres }} {{ estudiante.apellidos }}</span>
                            <span class="correo">{{ estudiante.correo }}</span>
                          </div>
                        </td>
                        <td class="tabla-cell col-id">{{ estudiante.canvasUserId || '-' }}</td>
                        <td class="tabla-cell col-numeric" [class.low]="estudiante.notas?.e1 < 3"
                          [class.empty]="!estudiante.notas?.e1">
                          {{ estudiante.notas?.e1 || '-' }}
                        </td>
                        <td class="tabla-cell col-numeric" [class.low]="estudiante.notas?.e2 < 3"
                          [class.empty]="!estudiante.notas?.e2">
                          {{ estudiante.notas?.e2 || '-' }}
                        </td>
                        <td class="tabla-cell col-numeric" [class.low]="estudiante.notas?.ef < 3"
                          [class.empty]="!estudiante.notas?.ef">
                          {{ estudiante.notas?.ef || '-' }}
                        </td>
                      </tr>
                      }
                    </tbody>
                  </table>
                </div>
                } @else {
                <div class="empty-tab-content">
                  <ion-icon name="people-outline"></ion-icon>
                  <p>No hay estudiantes en este grupo</p>
                </div>
                }
              </div>
              } @else {
              <div class="empty-tab-content">
                <ion-icon name="cloud-upload-outline"></ion-icon>
                <p>Este curso no tiene estudiantes cargados</p>
                <p class="hint">Cargue un archivo de calificaciones para ver los integrantes</p>
              </div>
              }
            </div>

            <div class="detalle-rubricas">
              <div class="detalle-section-header">
                <h4>Rúbricas asociadas</h4>
                <ion-button fill="clear" size="small" color="medium" (click)="deseleccionarCurso()">
                  <ion-icon slot="start" name="close-outline"></ion-icon>
                  Cerrar detalle
                </ion-button>
              </div>
              @if (rubricasAsociadas.length > 0) {
              <div class="rubricas-chip-list">
                @for (rubrica of rubricasAsociadas; track rubrica.id) {
                <ion-chip>
                  <ion-icon name="document-text-outline"></ion-icon>
                  <ion-label>{{ rubrica.nombre }}</ion-label>
                </ion-chip>
                }
              </div>
              } @else {
              <p class="detalle-empty">No hay rúbricas asociadas a este curso.</p>
              }
            </div>
          </ion-card-content>
        </ion-card>
        }

        } @else {
        <!-- Empty state -->
        <div class="empty-state">
          <h3>No hay Cursos Registrados</h3>
          <p>Seleccione "Crear" para agregar un nuevo curso</p>
        </div>
        }
      </div>

    </div>
  </div>
</ion-content>