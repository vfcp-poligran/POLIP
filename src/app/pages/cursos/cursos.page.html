<ion-content [fullscreen]="true">
  <!-- Skip link para accesibilidad -->
  <a href="#main-content" class="skip-link">Saltar al contenido principal</a>

  <!-- ======================================== -->
  <!-- 1. FABs FLOTANTES -->
  <!-- ======================================== -->

  <!-- FAB Crear Curso -->
  @if (!modoEdicion()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button [color]="BUTTON_CONFIG.CREAR.color" (click)="iniciarCreacionCurso()"
      [attr.aria-label]="BUTTON_CONFIG.CREAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.CREAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }

  <!-- FABs de edición -->
  @if (modoEdicion()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 16px">
    <ion-fab-button [color]="BUTTON_CONFIG.GUARDAR.color" (click)="guardarCurso()"
      [attr.aria-label]="BUTTON_CONFIG.GUARDAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.GUARDAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 80px">
    <ion-fab-button [color]="BUTTON_CONFIG.CANCELAR.color" (click)="cancelarCreacionCurso()"
      [attr.aria-label]="BUTTON_CONFIG.CANCELAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.CANCELAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }

  <div class="page-container" id="main-content" role="main">
    <!-- ======================================== -->
    <!-- 2. HEADER DE PÁGINA -->
    <!-- ======================================== -->
    <div class="page-header">
      <h2>Cursos</h2>
      <div class="header-actions">
        @if (!modoEdicion()) {
        <ion-button size="small" [color]="BUTTON_CONFIG.CREAR.color" (click)="iniciarCreacionCurso()"
          [attr.aria-label]="BUTTON_CONFIG.CREAR.ariaLabel">
          <ion-icon [name]="BUTTON_CONFIG.CREAR.icon" slot="start"></ion-icon>
          {{ BUTTON_CONFIG.CREAR.label }}
        </ion-button>
        } @else {
        <ion-button size="small" [color]="BUTTON_CONFIG.GUARDAR.color" (click)="guardarCurso()"
          [attr.aria-label]="BUTTON_CONFIG.GUARDAR.ariaLabel">
          <ion-icon [name]="BUTTON_CONFIG.GUARDAR.icon" slot="start"></ion-icon>
          {{ BUTTON_CONFIG.GUARDAR.label }}
        </ion-button>
        <ion-button size="small" [color]="BUTTON_CONFIG.CANCELAR.color" (click)="cancelarCreacionCurso()"
          [attr.aria-label]="BUTTON_CONFIG.CANCELAR.ariaLabel">
          {{ BUTTON_CONFIG.CANCELAR.label }}
        </ion-button>
        }
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 3. SECCIÓN DE EDICIÓN/CREACIÓN -->
    <!-- ======================================== -->
    @if (modoEdicion()) {
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ codigoCursoEnEdicion ? 'Editar Curso' : 'Nuevo Curso' }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Inputs ocultos para archivos -->
        <input type="file" #estudiantesFileInput accept=".csv" (change)="onEstudiantesFileSelected($event)" hidden />
        <input type="file" #calificacionesFileInput accept=".csv" (change)="onCalificacionesFileSelected($event)"
          hidden />

        <!-- Botones de importación -->
        <div class="import-buttons">
          <ion-button fill="outline" (click)="estudiantesFileInput.click()">
            <ion-icon name="people-outline" slot="start"></ion-icon>
            Importar Estudiantes
          </ion-button>
          @if (estudiantesFileName) {
          <ion-chip color="success">
            <ion-icon name="checkmark-circle"></ion-icon>
            <ion-label>{{ estudiantesFileName }}</ion-label>
            <ion-icon name="close-circle" (click)="limpiarEstudiantes()"></ion-icon>
          </ion-chip>
          }

          <ion-button fill="outline" (click)="calificacionesFileInput.click()">
            <ion-icon name="stats-chart-outline" slot="start"></ion-icon>
            Importar Calificaciones
          </ion-button>
          @if (calificacionesFileName) {
          <ion-chip color="success">
            <ion-icon name="checkmark-circle"></ion-icon>
            <ion-label>{{ calificacionesFileName }}</ion-label>
            <ion-icon name="close-circle" (click)="limpiarCalificaciones()"></ion-icon>
          </ion-chip>
          }
        </div>

        <!-- Configuración de Cohorte -->
        <div class="cohorte-config">
          <h4>Configuración de Cohorte</h4>
          @if (nombreCohorteGenerado()) {
          <ion-badge color="primary">{{ nombreCohorteGenerado() }}</ion-badge>
          }

          <div class="config-row">
            <!-- Color -->
            <div class="color-picker">
              <button [style.background]="colorCursoSeleccionado" id="color-trigger"
                (click)="showColorPicker = !showColorPicker">
                <ion-icon name="color-palette"></ion-icon>
              </button>
              <ion-popover trigger="color-trigger" [isOpen]="showColorPicker" (didDismiss)="showColorPicker = false">
                <ng-template>
                  <div class="color-grid">
                    @for (color of coloresDisponibles; track color) {
                    <div class="color-option" [style.background-color]="color"
                      [class.selected]="colorCursoSeleccionado === color"
                      (click)="seleccionarColorCurso(color); showColorPicker = false">
                      @if (colorCursoSeleccionado === color) {
                      <ion-icon name="checkmark"></ion-icon>
                      }
                    </div>
                    }
                  </div>
                </ng-template>
              </ion-popover>
            </div>

            <!-- Año -->
            <ion-select [(ngModel)]="cohorteForm.anio" (ionChange)="onCambioCohorte()" interface="popover"
              placeholder="Año">
              <ion-select-option value="2024">2024</ion-select-option>
              <ion-select-option value="2025">2025</ion-select-option>
              <ion-select-option value="2026">2026</ion-select-option>
            </ion-select>

            <!-- Ingreso -->
            <ion-radio-group [(ngModel)]="cohorteForm.ingreso" (ionChange)="onCambioCohorte(); onIngresoChange()">
              <ion-radio value="A">A</ion-radio>
              <ion-radio value="B">B</ion-radio>
              <ion-radio value="C">C</ion-radio>
            </ion-radio-group>

            <!-- Fecha Inicio -->
            <ion-datetime-button datetime="fecha-inicio"></ion-datetime-button>
            <ion-popover [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime id="fecha-inicio" [(ngModel)]="cohorteForm.fechaInicio"
                  (ionChange)="onFechaInicioChange()" presentation="date" locale="es-ES"
                  [showDefaultButtons]="true"></ion-datetime>
              </ng-template>
            </ion-popover>

            <!-- Fecha Fin -->
            <ion-datetime-button datetime="fecha-fin"></ion-datetime-button>
            <ion-popover [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime id="fecha-fin" [(ngModel)]="cohorteForm.fechaFin" (ionChange)="onFechaFinManualChange()"
                  presentation="date" locale="es-ES" [showDefaultButtons]="true"></ion-datetime>
              </ng-template>
            </ion-popover>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
    }

    <!-- ======================================== -->
    <!-- 4. LISTA DE CURSOS (TABS) -->
    <!-- ======================================== -->
    @if (cursosDisponibles().length > 0) {
    <div class="cursos-container">
      <!-- Tabs principales de cursos -->
      <ion-segment [value]="cursoSeleccionado() || cursosDisponibles()[0]?.codigo"
        (ionChange)="seleccionarCurso($any($event).detail.value)" scrollable>
        @for (curso of cursosDisponibles(); track curso.codigo) {
        <ion-segment-button [value]="curso.codigo">
          <ion-label>{{ curso.nombre }}</ion-label>
        </ion-segment-button>
        }
      </ion-segment>

      <!-- Contenido del curso seleccionado -->
      @if (cursoSeleccionadoInfo(); as info) {
      <ion-card class="curso-card" [class.active]="info.tieneCalificaciones" [class.no-data]="!info.tieneCalificaciones"
        [style.--curso-color]="info.color">

        <!-- Header con título y acciones -->
        <div class="curso-card-header">
          <div class="curso-title-row">
            <h3 class="curso-nombre">{{ info.nombre }}</h3>
            <ion-chip class="curso-status-chip" [color]="info.tieneCalificaciones ? 'success' : 'warning'" size="small">
              <ion-icon [name]="info.tieneCalificaciones ? 'checkmark-circle' : 'alert-circle'" size="small"></ion-icon>
              <ion-label>{{ info.tieneCalificaciones ? 'Activo' : 'Sin datos' }}</ion-label>
            </ion-chip>
          </div>

          <!-- Información secundaria -->
          <div class="curso-info-row">
            <div class="info-item">
              <ion-icon name="code-slash"></ion-icon>
              <span><strong>Código:</strong> {{ info.codigo }}</span>
            </div>
            @if (info.bloque) {
            <div class="info-item">
              <ion-icon name="calendar"></ion-icon>
              <span><strong>Bloque:</strong> {{ info.bloque }}</span>
            </div>
            }
          </div>

          <!-- Estadísticas -->
          <div class="curso-stats">
            <div class="stat-item">
              <ion-icon name="people"></ion-icon>
              <div>
                <div class="stat-value">{{ estudiantesCurso().length }}</div>
                <div class="stat-label">Estudiantes</div>
              </div>
            </div>
            <div class="stat-item">
              <ion-icon name="grid"></ion-icon>
              <div>
                <div class="stat-value">{{ gruposCurso().length }}</div>
                <div class="stat-label">Grupos</div>
              </div>
            </div>
          </div>

          <!-- Acciones -->
          <div class="card-actions">
            <ion-button size="small" fill="clear" [color]="BUTTON_CONFIG.EDITAR.color" (click)="editarCurso(info)"
              [attr.aria-label]="BUTTON_CONFIG.EDITAR.ariaLabel" [attr.data-tooltip]="BUTTON_CONFIG.EDITAR.label">
              <ion-icon slot="icon-only" [name]="BUTTON_CONFIG.EDITAR.icon"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" [color]="BUTTON_CONFIG.ELIMINAR.color"
              (click)="confirmarEliminarCurso(info)" [attr.aria-label]="BUTTON_CONFIG.ELIMINAR.ariaLabel"
              [attr.data-tooltip]="BUTTON_CONFIG.ELIMINAR.label">
              <ion-icon slot="icon-only" [name]="BUTTON_CONFIG.ELIMINAR.icon"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div class="curso-card-content">
          <!-- Subtabs: Detalle / Integrantes / Importar -->
          <ion-segment [value]="subtabActivo()" (ionChange)="subtabActivo.set($any($event).detail.value)" scrollable>
            <ion-segment-button value="detalle">
              <ion-icon name="information-circle-outline"></ion-icon>
              <ion-label>Detalle</ion-label>
            </ion-segment-button>
            <ion-segment-button value="integrantes">
              <ion-icon name="people-outline"></ion-icon>
              <ion-label>Integrantes</ion-label>
            </ion-segment-button>
            <ion-segment-button value="importar">
              <ion-icon name="cloud-upload-outline"></ion-icon>
              <ion-label>Importar</ion-label>
            </ion-segment-button>
          </ion-segment>

          <!-- SUBTAB: Detalle -->
          @if (subtabActivo() === 'detalle') {
          <div class="subtab-content">
            <ion-list>
              <ion-item>
                <ion-label>Código</ion-label>
                <ion-note slot="end">{{ info.codigo }}</ion-note>
              </ion-item>
              <ion-item>
                <ion-label>Código Base</ion-label>
                <ion-note slot="end">{{ info.codigoBase || '—' }}</ion-note>
              </ion-item>
              <ion-item>
                <ion-label>Bloque</ion-label>
                <ion-note slot="end">{{ info.bloque || '—' }}</ion-note>
              </ion-item>
              <ion-item>
                <ion-label>Estudiantes</ion-label>
                <ion-note slot="end">{{ estudiantesCurso().length }}</ion-note>
              </ion-item>
              <ion-item>
                <ion-label>Grupos</ion-label>
                <ion-note slot="end">{{ gruposCurso().length }}</ion-note>
              </ion-item>
            </ion-list>

            <!-- Rúbricas asociadas -->
            <h4>Rúbricas asociadas</h4>
            @if (rubricasAsociadas.length > 0) {
            <div class="rubricas-list">
              @for (rubrica of rubricasAsociadas; track rubrica.id) {
              <ion-chip>
                <ion-icon name="document-text-outline"></ion-icon>
                <ion-label>{{ rubrica.nombre }}</ion-label>
              </ion-chip>
              }
            </div>
            } @else {
            <p>No hay rúbricas asociadas</p>
            }
          </div>
          }

          <!-- SUBTAB: Integrantes -->
          @if (subtabActivo() === 'integrantes') {
          <div class="subtab-content">
            <!-- Tabs de grupos -->
            <ion-segment [value]="grupoActivo()" (ionChange)="grupoActivo.set($any($event).detail.value)" scrollable>
              <ion-segment-button value="todos">
                Todos ({{ estudiantesCurso().length }})
              </ion-segment-button>
              @for (grupo of gruposCurso(); track grupo) {
              <ion-segment-button [value]="grupo">
                Grupo {{ grupo }} ({{ contarIntegrantes(grupo) }})
              </ion-segment-button>
              }
            </ion-segment>

            <!-- Lista de estudiantes -->
            @if (estudiantesFiltrados() && estudiantesFiltrados().length > 0) {
            <ion-list>
              @for (est of estudiantesFiltrados(); track est.correo) {
              <ion-item>
                <ion-badge slot="start" color="light">{{ est?.grupo || '-' }}</ion-badge>
                <ion-label>
                  <h3>{{ est?.nombres }} {{ est?.apellidos }}</h3>
                  <p>{{ est?.correo }}</p>
                </ion-label>
                <ion-note slot="end">
                  E1: {{ est?.notas?.e1 || '-' }} | E2: {{ est?.notas?.e2 || '-' }} | EF: {{ est?.notas?.ef || '-' }}
                </ion-note>
              </ion-item>
              }
            </ion-list>
            } @else {
            <p>No hay estudiantes en este grupo</p>
            }
          </div>
          }

          <!-- SUBTAB: Importar -->
          @if (subtabActivo() === 'importar') {
          <div class="subtab-content">
            <input type="file" #importEstudiantesInput accept=".csv" (change)="onEstudiantesFileSelected($event)"
              hidden />
            <input type="file" #importCalificacionesInput accept=".csv" (change)="onCalificacionesFileSelected($event)"
              hidden />

            <ion-button expand="block" fill="outline" (click)="importEstudiantesInput.click()">
              <ion-icon name="people-outline" slot="start"></ion-icon>
              Importar Estudiantes (CSV)
            </ion-button>

            <ion-button expand="block" fill="outline" (click)="importCalificacionesInput.click()">
              <ion-icon name="stats-chart-outline" slot="start"></ion-icon>
              Importar Calificaciones (CSV)
            </ion-button>
          </div>
          }
          </ion-card-content>
      </ion-card>
      }
    </div>
    } @else {
    <!-- Empty state -->
    <div class="empty-state">
      <ion-icon name="folder-open-outline"></ion-icon>
      <h3>No hay cursos registrados</h3>
      <p>Presione "Crear" para agregar un nuevo curso</p>
    </div>
    }
  </div>
</ion-content>