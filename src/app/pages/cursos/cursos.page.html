<ion-content [fullscreen]="false">

  <!-- ======================================== -->
  <!-- 1. FABs FLOTANTES -->
  <!-- ======================================== -->

  <!-- FAB Crear Curso -->
  @if (!modoEdicion()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="ion-hide-md-up">
    <ion-fab-button [color]="BUTTON_CONFIG.CREAR.color" (click)="iniciarCreacionCurso()"
      [attr.aria-label]="BUTTON_CONFIG.CREAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.CREAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }

  <!-- FABs de edición -->
  @if (modoEdicion()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 16px" class="ion-hide-md-up">
    <ion-fab-button [color]="BUTTON_CONFIG.GUARDAR.color" (click)="guardarCurso()"
      [attr.aria-label]="BUTTON_CONFIG.GUARDAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.GUARDAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 80px" class="ion-hide-md-up">
    <ion-fab-button [color]="BUTTON_CONFIG.CANCELAR.color" (click)="cancelarCreacionCurso()"
      [attr.aria-label]="BUTTON_CONFIG.CANCELAR.ariaLabel">
      <ion-icon [name]="BUTTON_CONFIG.CANCELAR.icon"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }

  <div class="page-container" id="main-content" role="main">
    <!-- ======================================== -->
    <!-- 2. HEADER DE PÁGINA -->
    <!-- ======================================== -->
    <div class="page-title-header">
      <div class="title-wrapper">
        <h2>Cursos</h2>
      </div>
      <div class="header-actions ion-hide-md-down">
        @if (!modoEdicion()) {
        <ion-button size="small" fill="solid" color="success" (click)="iniciarCreacionCurso()"
          [attr.aria-label]="BUTTON_CONFIG.CREAR.ariaLabel">
          <ion-icon name="add-circle-outline" slot="start"></ion-icon>
          Crear
        </ion-button>
        } @else {
        <ion-button size="small" fill="solid" color="primary" (click)="guardarCurso()"
          [attr.aria-label]="BUTTON_CONFIG.GUARDAR.ariaLabel">
          <ion-icon [name]="BUTTON_CONFIG.GUARDAR.icon" slot="start"></ion-icon>
          {{ BUTTON_CONFIG.GUARDAR.label }}
        </ion-button>
        <ion-button size="small" fill="solid" color="warning" (click)="cancelarCreacionCurso()"
          [attr.aria-label]="BUTTON_CONFIG.CANCELAR.ariaLabel">
          {{ BUTTON_CONFIG.CANCELAR.label }}
        </ion-button>
        }
      </div>
    </div>

    <!-- ======================================== -->
    <!-- 3. CONTENEDOR PRINCIPAL DE CURSOS -->
    <!-- ======================================== -->
    @if (cursosDisponibles().length > 0 || (modoEdicion() && !cursoSeleccionado())) {
    <div class="cursos-container" [class.solo-uno]="cursosDisponibles().length === 0 && modoEdicion()">
      <!-- Tabs superiores de selección de curso -->
      <ion-segment
        [value]="cursoSeleccionado() || (modoEdicion() && !cursoSeleccionado() ? 'NUEVO' : cursosDisponibles()[0]?.codigo)"
        (ionChange)="seleccionarCurso($any($event).detail.value)" scrollable layout="icon-top">

        <!-- Tab Virtual de Nuevo Curso -->
        @if (modoEdicion() && !cursoSeleccionado()) {
        <ion-segment-button value="NUEVO">
          <ion-label>Sin Nombre</ion-label>
        </ion-segment-button>
        }

        <!-- Tabs de cursos existentes -->
        @for (curso of cursosDisponibles(); track curso.codigo) {
        <ion-segment-button [value]="curso.codigo">
          <ion-label class="tab-label-container">
            <span class="tab-nombre">{{ curso.nombre }}</span>
            <span class="tab-codigo">{{ getStandardizedCode(curso) }}</span>
          </ion-label>
        </ion-segment-button>
        }
      </ion-segment>

      <!-- Contenido de la tarjeta del curso seleccionado o en creación -->
      @if (infoParaMostrar(); as info) {
      <ion-card class="curso-card" [class.active]="info.tieneCalificaciones" [class.no-data]="!info.tieneCalificaciones"
        [class.es-nuevo]="info.esNuevo" [style.--curso-color]="info.color">

        <!-- Header con acciones -->
        <div class="curso-card-header">
          <div class="curso-header-info">
            <ion-icon name="information-circle-outline" class="header-icon"></ion-icon>
            <h2 class="header-main-title">Información del Curso</h2>
            <!-- Labels moved to detail section below imports -->
          </div>

          <div class="card-actions">
            @if (!info.esNuevo) {
            <ion-button size="small" fill="clear" [color]="BUTTON_CONFIG.EDITAR.color" (click)="editarCurso(info)"
              [attr.aria-label]="BUTTON_CONFIG.EDITAR.ariaLabel" [attr.data-tooltip]="BUTTON_CONFIG.EDITAR.label">
              <ion-icon slot="icon-only" [name]="BUTTON_CONFIG.EDITAR.icon"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" [color]="BUTTON_CONFIG.ELIMINAR.color"
              (click)="confirmarEliminarCurso(info)" [attr.aria-label]="BUTTON_CONFIG.ELIMINAR.ariaLabel"
              [attr.data-tooltip]="BUTTON_CONFIG.ELIMINAR.label">
              <ion-icon slot="icon-only" [name]="BUTTON_CONFIG.ELIMINAR.icon"></ion-icon>
            </ion-button>
            }
          </div>
        </div>

        <div class="curso-card-content">
          <!-- Subtabs: Detalle / Integrantes -->
          <ion-segment [value]="subtabActivo()" (ionChange)="subtabActivo.set($any($event).detail.value)" scrollable>
            <ion-segment-button value="detalle">
              <ion-label>Características</ion-label>
            </ion-segment-button>

            <!-- Solo mostrar Integrantes para cursos que ya existen -->
            @if (!info.esNuevo) {
            <ion-segment-button value="integrantes">
              <ion-icon name="people-outline"></ion-icon>
              <ion-label>Integrantes</ion-label>
            </ion-segment-button>
            }
          </ion-segment>

          <!-- SUBTAB: Detalle (Unificado para Lectura/Edición/Creación) -->
          @if (subtabActivo() === 'detalle') {
          <div class="subtab-content detail-compact-layout">
            <ion-card class="compact-info-card"
              [class.editing-view]="modoEdicion() && (codigoCursoEnEdicion === info.codigo || info.esNuevo)">

              <!-- VISTA EDICIÓN O CREACIÓN -->
              @if (modoEdicion() && (codigoCursoEnEdicion === info.codigo || info.esNuevo)) {
              <div class="compact-form-section editing">
                <div class="form-main-grid">

                  <!-- Columna Arriba/Izquierda: Importación (Prioridad) -->
                  <div class="import-side">
                    <h4 class="section-title">{{ info.esNuevo ? 'Cargar Estudiantes' : 'Actualizar Datos' }}</h4>

                    <div class="import-cloud-grid">
                      <!-- Import Personas -->
                      <div class="import-cloud-item" (click)="importEstudiantesInput.click()">
                        <div class="cloud-icon-wrapper">
                          <ion-icon name="cloud-upload"
                            [style.color]="estudiantesFileName ? 'var(--ion-color-success)' : '#FF00FF'"></ion-icon>
                          <div class="cloud-label">Importar (Personas)</div>
                        </div>
                        <input type="file" #importEstudiantesInput accept=".csv"
                          (change)="onEstudiantesFileSelected($event)" hidden />
                        @if (estudiantesFileName) {
                        <ion-chip color="primary" size="small" (click)="$event.stopPropagation()">
                          <ion-label>{{ estudiantesFileName }}</ion-label>
                          <ion-icon name="close-circle" (click)="limpiarEstudiantes()"></ion-icon>
                        </ion-chip>
                        }
                      </div>

                      <!-- Import Calificaciones -->
                      <div class="import-cloud-item" (click)="importCalificacionesInput.click()">
                        <div class="cloud-icon-wrapper">
                          <ion-icon name="cloud-upload"
                            [style.color]="calificacionesFileName ? 'var(--ion-color-success)' : '#FF00FF'"></ion-icon>
                          <div class="cloud-label">Importar (Calificaciones)</div>
                        </div>
                        <input type="file" #importCalificacionesInput accept=".csv"
                          (change)="onCalificacionesFileSelected($event)" hidden />
                        @if (calificacionesFileName) {
                        <ion-chip color="primary" size="small" (click)="$event.stopPropagation()">
                          <ion-label>{{ calificacionesFileName }}</ion-label>
                          <ion-icon name="close-circle" (click)="limpiarCalificaciones()"></ion-icon>
                        </ion-chip>
                        }
                      </div>
                    </div>

                    <!-- Datos del curso (mismo formato que vista lectura) -->
                    @if (cursoParseado) {
                    <ion-list lines="none" class="parsed-course-info">
                      <ion-item>
                        <ion-icon name="school-outline" slot="start" color="primary"></ion-icon>
                        <ion-label>
                          <p>Nombre del Curso</p>
                          <h3>{{ cursoParseado.nombre }}</h3>
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-icon name="code-slash" slot="start" color="primary"></ion-icon>
                        <ion-label>
                          <p>Código</p>
                          <h3>{{ getStandardizedCode(cursoParseado) }}</h3>
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-icon name="pricetag-outline" slot="start" color="primary"></ion-icon>
                        <ion-label>
                          <p>Ingreso</p>
                          <h3>{{ cursoParseado.ingreso || '—' }}</h3>
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                        <ion-label>
                          <p>Bloque</p>
                          <h3>{{ cursoParseado.bloque || '—' }}</h3>
                        </ion-label>
                      </ion-item>
                      <ion-item>
                        <ion-icon name="desktop-outline" slot="start" color="primary"></ion-icon>
                        <ion-label>
                          <p>Modalidad</p>
                          <h3>{{ cursoParseado.modalidad || 'Virtual' }}</h3>
                        </ion-label>
                      </ion-item>
                    </ion-list>
                    } @else {
                    <div class="empty-import-state">
                      <ion-icon name="cloud-upload-outline" color="medium"></ion-icon>
                      <p>Importa un archivo para ver los datos del curso</p>
                    </div>
                    }
                  </div>

                  <!-- Columna Abajo/Derecha: Configuración (solo en edición, no en creación) -->
                  @if (!info.esNuevo) {
                  <div class="config-side">
                    <h4 class="section-title">Parámetros de Cohorte</h4>
                    <div class="form-grid">
                      <ion-select [(ngModel)]="cohorteForm.ingreso" (ionChange)="onIngresoChange()" label="Ingreso"
                        labelPlacement="stacked" interface="popover" fill="outline">
                        <ion-select-option value="A">A</ion-select-option>
                        <ion-select-option value="B">B</ion-select-option>
                        <ion-select-option value="C">C</ion-select-option>
                      </ion-select>

                      <ion-select [(ngModel)]="cohorteForm.bloque" (ionChange)="onBloqueChange()" label="Bloque"
                        labelPlacement="stacked" interface="popover" fill="outline">
                        <ion-select-option value="PRIMERO">PRIMERO</ion-select-option>
                        <ion-select-option value="SEGUNDO">SEGUNDO</ion-select-option>
                        <ion-select-option value="TRANSVERSAL">TRANSVERSAL</ion-select-option>
                      </ion-select>
                    </div>
                  </div>
                  }

                </div>
              </div>
              } @else {
              <!-- VISTA LECTURA -->
              <ion-list lines="none">
                <ion-item>
                  <ion-icon name="code-slash" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Código</p>
                    <h3>{{ info.codigoEstandarizado }}</h3>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Bloque</p>
                    <h3>{{ info.bloque || '—' }}</h3>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-icon name="pricetag-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Ingreso</p>
                    <h3>{{ info.ingreso || '—' }}</h3>
                  </ion-label>
                </ion-item>
                <ion-item>
                  <ion-icon name="desktop-outline" slot="start" color="primary"></ion-icon>
                  <ion-label>
                    <p>Modalidad</p>
                    <h3>{{ info.modalidad || '—' }}</h3>
                  </ion-label>
                </ion-item>
              </ion-list>

              <div class="compact-rubricas-section">
                <h4 class="section-title">Rúbricas asociadas</h4>
                @if (rubricasAsociadas.length > 0) {
                <div class="compact-rubricas-list">
                  @for (rubrica of rubricasAsociadas; track rubrica.id) {
                  <ion-chip outline="true" size="small">
                    <ion-label>{{ rubrica.nombre }}</ion-label>
                  </ion-chip>
                  }
                </div>
                } @else {
                <p class="no-data">No hay rúbricas</p>
                }
              </div>
              }
            </ion-card>
          </div>
          }

          <!-- SUBTAB: Integrantes -->
          @if (subtabActivo() === 'integrantes') {
          <div class="subtab-content">
            <!-- Tabs de grupos -->
            <ion-segment [value]="grupoActivo()" (ionChange)="grupoActivo.set($any($event).detail.value)" scrollable>
              <ion-segment-button value="todos">
                Todos ({{ estudiantesCurso().length }})
              </ion-segment-button>
              @for (grupo of gruposCurso(); track grupo) {
              <ion-segment-button [value]="grupo">
                Grupo {{ grupo }} ({{ contarIntegrantes(grupo) }})
              </ion-segment-button>
              }
            </ion-segment>

            <!-- Lista de estudiantes -->
            @if (estudiantesFiltrados() && estudiantesFiltrados().length > 0) {
            <ion-list>
              @for (est of estudiantesFiltrados(); track est.correo) {
              <ion-item>
                <ion-badge slot="start" color="light">{{ est?.grupo || '-' }}</ion-badge>
                <ion-label>
                  <h3>{{ est?.nombres }} {{ est?.apellidos }}</h3>
                  <p>{{ est?.correo }}</p>
                </ion-label>
                <ion-note slot="end">
                  E1: {{ est?.notas?.e1 || '-' }} | E2: {{ est?.notas?.e2 || '-' }} | EF: {{ est?.notas?.ef || '-' }}
                </ion-note>
              </ion-item>
              }
            </ion-list>
            } @else {
            <div class="empty-state-mini">
              <p>No hay estudiantes en este grupo</p>
            </div>
            }
          </div>
          }
        </div>
      </ion-card>
      }
    </div>
    } @else {
    <!-- Estado vacío (No hay cursos y no estamos creando) -->
    <div class="empty-state">
      <ion-icon name="library"></ion-icon>
      <h3>No hay cursos registrados</h3>
      <p>Presione "Crear" para agregar un nuevo curso</p>
    </div>
    }
  </div>
</ion-content>