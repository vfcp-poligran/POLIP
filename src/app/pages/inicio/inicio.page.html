<ion-content class="mobile-optimized" [fullscreen]="true">
  <!-- FAB nativo de Ionic para móvil portrait -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="fab-menu-container ion-hide-md-up">
    <ion-fab-button color="primary" aria-label="Menú de navegación">
      <ion-icon name="ellipsis-vertical-outline"></ion-icon>
    </ion-fab-button>

    <ion-fab-list side="top">
      <!-- Navegación de grupo anterior -->
      <ion-fab-button color="primary" [disabled]="!grupoAnteriorDisponible" (click)="retrocederGrupo()"
        data-desc="Grupo anterior" aria-label="Grupo anterior">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-fab-button>

      <!-- Navegación de grupo siguiente -->
      <ion-fab-button color="primary" [disabled]="!grupoSiguienteDisponible" (click)="avanzarGrupo()"
        data-desc="Grupo siguiente" aria-label="Grupo siguiente">
        <ion-icon name="arrow-forward-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

  <div class="layout" [ngStyle]="layoutStyles">
    <div class="page-container">
      <!-- 1. Barra de búsqueda global con sección de información -->
      @if (cursosDisponibles.length > 0 && searchBarVisible) {
      <div class="search-info-container">
        <div class="search-bar-wrapper">
          <div class="search-with-results">
            <ion-searchbar #searchbarElement [(ngModel)]="busquedaGeneral" (ionInput)="onBusquedaChange($event)"
              placeholder="Buscar" debounce="300" mode="ios" class="main-searchbar">
            </ion-searchbar>

            <!-- Resultados de búsqueda -->
            @if (resultadosBusqueda.length > 0 && busquedaGeneral.trim()) {
            <div class="search-results-dropdown">
              @for (resultado of resultadosBusqueda; track resultado.correo) {
              <div class="search-result-item" (click)="toggleSeleccionResultado(resultado, $event)">
                <ion-checkbox [checked]="isEstudianteSeleccionado(resultado.correo)"
                  (ionChange)="toggleSeleccionResultado(resultado, $event)" (click)="$event.stopPropagation()">
                </ion-checkbox>
                <div class="result-info">
                  <div class="result-name">{{ resultado.nombres }} {{ resultado.apellidos }}</div>
                  <div class="result-meta">{{ resultado.curso ? getCodigoCorto(resultado.curso) : '' }} - Grupo {{
                    resultado.grupo }}</div>
                </div>
              </div>
              }
            </div>
            }
          </div>
        </div>
        <div class="info-section">
          <!-- Sección de información - Estudiantes seleccionados -->
          <div class="info-content">
            @if (estudiantesSeleccionadosBusqueda.size > 0) {
            <div class="seleccionados-chips">
              @for (correo of Array.from(estudiantesSeleccionadosBusqueda); track correo) {
              <div class="estudiante-chip">
                <span class="chip-text">{{ obtenerNombreEstudiante(correo) }}</span>
                <ion-icon name="close-circle" class="chip-remove" (click)="removerSeleccionado(correo)"
                  aria-label="Eliminar">
                </ion-icon>
              </div>
              }
            </div>
            <!-- Botón Registrar -->
            <button type="button" class="btn-registrar" (click)="registrarEstudiantes()"
              aria-label="Registrar estudiantes seleccionados">
              <ion-icon name="add-circle-outline"></ion-icon>
              <span>Registrar</span>
            </button>
            } @else {
            <div class="info-placeholder">
              <ion-icon name="information-circle-outline"></ion-icon>
            </div>
            }
          </div>
        </div>

        <!-- Lista de estudiantes registrados (derecha) -->
        @if (estudiantesRegistrados.length > 0) {
        <div class="registrados-panel">
          <ion-list class="registrados-list">
            <ion-list-header>
              <ion-label>Estudiantes Registrados ({{ estudiantesRegistrados.length }})</ion-label>
              <ion-icon name="trash-outline" class="btn-limpiar" (click)="limpiarRegistrados()" title="Limpiar lista"
                aria-label="Limpiar lista">
              </ion-icon>
            </ion-list-header>
            @for (est of estudiantesRegistrados; track est.correo) {
            <ion-item lines="inset" class="registrado-item">
              <ion-label>
                <h3>{{ est.nombre }}</h3>
                <p>{{ est.curso }} - G{{ est.grupo }}</p>
              </ion-label>
              <ion-icon name="close-circle-outline" slot="end" class="btn-eliminar"
                (click)="eliminarRegistrado(est.correo)" aria-label="Eliminar">
              </ion-icon>
            </ion-item>
            }
          </ion-list>
        </div>
        }
      </div>
      }

      <!-- 2. Barra con Vista General + Selectores de curso -->
      <div class="page-title-header">
        <div class="header-course-selector">
          <!-- Botón Vista General -->
          <button type="button" class="vista-general-toggle-btn" [class.activo]="vistaGeneralActiva()"
            (click)="irAVistaGeneral()" title="Vista General de todos los cursos" aria-label="Vista General">
            <ion-icon name="apps"></ion-icon>
          </button>

          <!-- Selectores de curso -->
          @if (cursosDisponibles.length > 0) {
          <ion-segment [scrollable]="true" [value]="cursoActivo ?? undefined" (ionChange)="onCursoChange($event)"
            class="course-segment">
            @for (curso of cursosDisponibles; track curso) {
            <ion-segment-button [value]="curso" [style.--course-color]="getCourseColor(curso)"
              class="course-segment-button">
              <div class="segment-button-content">
                <ion-label class="segment-label">
                  <span class="course-name">{{ getCursoNombre(curso) }}</span>
                  <span class="course-code">{{ getCodigoCorto(curso) }}</span>
                </ion-label>
                <ion-icon name="ellipsis-vertical" class="segment-menu-icon"
                  (click)="abrirMenuColor($event, curso); $event.stopPropagation()"
                  [attr.aria-label]="'Opciones de ' + curso"></ion-icon>
              </div>
            </ion-segment-button>
            }
          </ion-segment>
          }
          @else {
          <!-- Mensaje debug cuando no hay cursos -->
          <div class="no-cursos-message">
            Sin cursos disponibles
          </div>
          }
        </div>
      </div>

      <!-- Popover para cambiar color (Ionic nativo) - Botón 3 puntos -->
      <ion-popover [isOpen]="menuColorVisible" [event]="colorPopoverEvent" (didDismiss)="cerrarMenuColor()" size="auto"
        alignment="start" class="color-picker-popover-wrapper" role="dialog" aria-label="Selector de color para curso">
        <ng-template>
          <div class="color-picker-popover">
            <div class="color-picker-header">
              <span role="heading" aria-level="2">Color del curso</span>
              <ion-icon name="close-outline" (click)="cerrarMenuColor()" aria-label="Cerrar"></ion-icon>
            </div>
            <div class="color-picker-content">
              <!-- Grid de colores predefinidos - clic aplica directamente -->
              <div class="color-picker-grid" role="radiogroup" aria-label="Colores disponibles">
                @for (color of coloresDisponibles; track color) {
                <div role="radio" aria-checked="false"
                  [attr.aria-checked]="cursoParaCambiarColor ? (getCourseColor(cursoParaCambiarColor) === color ? 'true' : 'false') : 'false'"
                  [attr.aria-label]="'Color ' + color" class="color-option" [style.background-color]="color"
                  [class.selected]="cursoParaCambiarColor && getCourseColor(cursoParaCambiarColor) === color"
                  [title]="color" tabindex="0" (click)="aplicarColorDirecto(color)"
                  (keydown.enter)="aplicarColorDirecto(color)"
                  (keydown.space)="aplicarColorDirecto(color); $event.preventDefault()">
                  @if (cursoParaCambiarColor && getCourseColor(cursoParaCambiarColor) === color) {
                  <ion-icon name="checkmark-circle" aria-hidden="true"></ion-icon>
                  }
                </div>
                }
              </div>
            </div>
          </div>
        </ng-template>
      </ion-popover>

      <!-- Mensaje si no hay cursos -->
      @if (cursosDisponibles.length === 0) {
      <div class="empty-state-fullscreen">
        <div class="empty-state-content">
          <h3>No hay información disponible</h3>
          <p>Gestione la información a través de las opciones <strong><ion-icon name="library"
                class="icon-menu"></ion-icon> Cursos</strong> y <strong><ion-icon name="speedometer"
                class="icon-menu"></ion-icon> Rúbricas</strong></p>
        </div>
      </div>
      }

      <!-- ==================== -->
      <!-- VISTA GENERAL (Multi-curso) -->
      <!-- ==================== -->
      @if (vistaGeneralActiva() && cursosDisponibles.length > 0) {
      <div class="vista-general-section">
        <div class="vista-general-grid">
          @for (seccion of vistaGeneralSecciones; track seccion.id) {
          <ion-card class="vista-general-card">
            <ion-card-content class="vista-general-content">
              <div class="vista-general-placeholder">
                <div class="placeholder-icon-badge">
                  <ion-icon [name]="seccion.icono"></ion-icon>
                </div>
                <p class="placeholder-title">{{ seccion.titulo }}</p>
                <p class="placeholder-description">{{ seccion.descripcion }}</p>
                <span class="hint">Sección en construcción</span>
              </div>
            </ion-card-content>
          </ion-card>
          }
        </div>
      </div>
      }

      <!-- Lista de Estudiantes (Vista de curso específico) -->
      @if (!vistaGeneralActiva() && cursoActivo && estudiantesActuales.length > 0) {
      <div class="estudiantes-section">

        <!-- Panel General -->
        <ion-card class="dashboard-options">
          <!-- Barra de título del curso -->
          <ion-card-header class="header-con-toggle">
            <div class="breadcrumb-navigation">
              @if (cursoActivo) {
              <span class="breadcrumb-item curso-name" [title]="cursoActivo">
                {{ getNombreCompletoConGrupo(cursoActivo) }}
              </span>
              @if (filtroGrupo !== 'todos') {
              <ion-icon name="chevron-forward-outline" class="breadcrumb-separator"></ion-icon>
              <span class="breadcrumb-item grupo-name" [style.color]="getCourseColor(cursoActivo)">Grupo {{ filtroGrupo
                }}</span>
              @if (entregaEvaluando) {
              <ion-icon name="chevron-forward-outline" class="breadcrumb-separator"></ion-icon>
              <span class="breadcrumb-item entrega-name">{{ entregaEvaluando }}</span>
              }
              }
              }
            </div>
          </ion-card-header>

          <!-- Botones de filtro de grupo - DEBAJO del título - Usando ion-segment scrollable -->
          @if (gruposDisponibles.length > 0) {
          <ion-segment [scrollable]="true" [value]="filtroGrupo" (ionChange)="onGrupoSegmentChange($event)"
            class="grupos-segment-bar">
            <ion-segment-button value="todos" class="grupo-segment-btn grupo-segment-all">
              <ion-icon name="grid-outline"></ion-icon>
              <ion-label>Todos</ion-label>
            </ion-segment-button>
            @for (grupo of gruposDisponibles; track grupo) {
            <ion-segment-button [value]="grupo" class="grupo-segment-btn">
              <ion-label>{{ grupo }}</ion-label>
            </ion-segment-button>
            }
          </ion-segment>
          }

          <ion-card-content>

            <!-- Vista: Todos los grupos (Vista General del Curso) -->
            @if (filtroGrupo === 'todos') {

            <!-- Vista de Grupos del Curso con Tabs -->
            <div class="grupos-tabs-section">
              <div class="grupos-tabs-header">
                <h4>
                  <ion-icon name="people-outline"></ion-icon>
                  {{ estudiantesActuales.length }} estudiantes en {{ gruposDisponibles.length }} grupos
                </h4>
              </div>

              @if (estudiantesActuales.length > 0) {
              <!-- Tabs de grupos -->
              <div class="grupos-tabs-bar">
                <button type="button" class="grupo-tab" [class.active]="vistaGrupoActiva === 'general'"
                  (click)="seleccionarVistaGrupo('general')">
                  <ion-icon name="apps-outline"></ion-icon>
                  <span>Vista General</span>
                  <span class="badge">{{ estudiantesActuales.length }}</span>
                </button>
                @for (grupo of gruposDisponibles; track grupo) {
                <button type="button" class="grupo-tab" [class.active]="vistaGrupoActiva === grupo"
                  (click)="seleccionarVistaGrupo(grupo)">
                  <span class="grupo-numero">{{ grupo }}</span>
                  <span class="badge">{{ contarIntegrantesGrupo(grupo) }}</span>
                </button>
                }
              </div>

              <!-- Contenido del tab seleccionado -->
              <div class="grupo-tab-content">
                <div class="tab-content-header">
                  @if (vistaGrupoActiva === 'general') {
                  <ion-icon name="list-outline"></ion-icon>
                  <span>Vista general del curso - {{ estudiantesActuales.length }} estudiantes</span>
                  } @else {
                  <ion-icon name="people"></ion-icon>
                  <span>Grupo {{ vistaGrupoActiva }} - {{ obtenerIntegrantesVistaActual().length }} integrantes</span>
                  }
                </div>

                <!-- Lista de integrantes -->
                @if (vistaGrupoActiva === 'general') {
                <div class="curso-general-placeholder">
                  <ion-icon name="construct-outline"></ion-icon>
                  <h5>Vista general en construcción</h5>
                  <p>
                    Aquí se mostrarán los indicadores y resúmenes del curso
                    {{ cursoActivo ? getCodigoCorto(cursoActivo) : '' }}.
                  </p>
                  <small>Utiliza los botones numerados para revisar cada grupo.</small>
                </div>
                } @else if (obtenerIntegrantesVistaActual().length > 0) {
                <div class="integrantes-grid">
                  @for (estudiante of obtenerIntegrantesVistaActual(); track estudiante.correo) {
                  <div class="integrante-card">
                    <div class="integrante-avatar">
                      <ion-icon name="person"></ion-icon>
                    </div>
                    <div class="integrante-data">
                      <span class="nombre">{{ estudiante.nombres }} {{ estudiante.apellidos }}</span>
                      <span class="correo">{{ estudiante.correo }}</span>
                    </div>
                    <div class="grupo-badge">G{{ estudiante.grupo }}</div>
                  </div>
                  }
                </div>
                } @else {
                <div class="empty-tab-content">
                  <ion-icon name="people-outline"></ion-icon>
                  <p>No hay estudiantes en este grupo</p>
                </div>
                }
              </div>
              } @else {
              <div class="empty-tab-content">
                <ion-icon name="cloud-upload-outline"></ion-icon>
                <p>Este curso no tiene estudiantes cargados</p>
                <p class="hint">Cargue un archivo de calificaciones para ver los integrantes</p>
              </div>
              }
            </div>

            } @else {
            <!-- Vista: Grupo específico seleccionado -->
            <div class="grupo-detail-content">

              @if (obtenerIntegrantesGrupo().length > 0) {
              <!-- Mensaje informativo - el seguimiento se hace en el panel lateral -->
              <div class="grupo-info-placeholder">
                <ion-icon name="information-circle-outline" color="medium"></ion-icon>
                <ion-text color="medium">
                  <p>Use el panel de seguimiento lateral para gestionar los integrantes del grupo <strong>{{ filtroGrupo
                      }}</strong></p>
                  <small>{{ obtenerIntegrantesGrupo().length }} integrantes</small>
                </ion-text>
              </div>
              } @else {
              <ion-item lines="none">
                <ion-icon name="alert-circle" slot="start" color="medium"></ion-icon>
                <ion-label color="medium">
                  <p>No hay integrantes en este grupo</p>
                </ion-label>
              </ion-item>
              }
            </div>
            }

          </ion-card-content>
        </ion-card>
      </div>
      }
    </div>
  </div>
</ion-content>