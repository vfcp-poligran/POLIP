<!-- Menu para tipos eliminado (sera un select o chips en el modal) -->

<ion-content id="main-content" class="inicio-content" [fullscreen]="true">
    <div class="page-container">

        <!-- CONTENIDO PRINCIPAL: GRID DE 3 COLUMNAS -->
        <div class="main-content-grid">
            <!-- Dynamic Group Buttons (appears when course selected - ABOVE ALL COLUMNS) -->


            <ion-grid>
                <ion-row class="main-layout-row">
                    <!-- COLUMNA 1: HISTORIAL (Izquierda) -->
                    <ion-col size="12" size-lg="3" class="column-container column-placeholder">
                        <div class="column-header-tabs">
                            <div class="tab-item" [class.active]="tabHistorial() === 'historial'"
                                (click)="tabHistorial.set('historial')">
                                <ion-icon name="time-outline"></ion-icon>
                                <span>Historia</span>
                            </div>
                            <div class="tab-item" [class.active]="tabHistorial() === 'sesiones'"
                                (click)="tabHistorial.set('sesiones')">
                                <ion-icon name="list-outline"></ion-icon>
                                <span>Sesiones</span>
                                @if (novedadService.sesionesBorrador().length > 0) {
                                <ion-badge color="warning">{{ novedadService.sesionesBorrador().length
                                    }}</ion-badge>
                                }
                            </div>
                        </div>

                        <div class="historial-tab-content">
                            @if (tabHistorial() === 'historial') {
                            <!-- SUB-TABS: Estudiante vs Grupal -->
                            <div class="historial-sub-tabs">
                                <div class="sub-tab" [class.active]="modoVisualizacionHistorial() === 'estudiante'"
                                    (click)="modoVisualizacionHistorial.set('estudiante')">Estudiante</div>
                                <div class="sub-tab" [class.active]="modoVisualizacionHistorial() === 'grupal'"
                                    (click)="modoVisualizacionHistorial.set('grupal')">Grupal</div>
                            </div>

                            <div class="historial-novedades-list">
                                @if (historialAgrupado().length > 0) {
                                @for (novedad of historialAgrupado(); track novedad.id) {
                                <div class="historial-item" [class.grupo]="modoVisualizacionHistorial() === 'grupal'">
                                    <div class="historial-consecutivo">
                                        <ion-icon
                                            [name]="modoVisualizacionHistorial() === 'grupal' ? 'people' : 'person'"></ion-icon>
                                    </div>
                                    <div class="historial-info">
                                        <span class="historial-estudiante">
                                            @if (modoVisualizacionHistorial() === 'grupal') {
                                            Grupo {{ novedad.grupo }} <small>({{ novedad.estudiantesCount }}
                                                est.)</small>
                                            } @else {
                                            {{ novedad.estudianteNombre }} <small>G{{ novedad.grupo }}</small>
                                            }
                                        </span>
                                        <div class="historial-meta">
                                            <ion-chip size="small"
                                                [style.--background]="getTipoColor(novedad.tipoNovedadId)"
                                                class="mini-chip">
                                                {{ novedad.tipoNovedadNombre }}
                                            </ion-chip>
                                            <span class="historial-fecha">{{ novedad.fechaRegistro |
                                                date:'HH:mm' }}</span>
                                        </div>
                                    </div>
                                    <ion-button fill="clear" size="small" color="danger" class="delete-btn"
                                        (click)="eliminarNovedadItem(novedad.id)">
                                        <ion-icon name="trash-outline"></ion-icon>
                                    </ion-button>
                                </div>
                                }
                                } @else {
                                <div class="empty-state-mini">
                                    <ion-icon name="document-text-outline"></ion-icon>
                                    <p>Sin novedades recientes</p>
                                </div>
                                }
                            </div>
                            } @else {
                            <div class="sesiones-list">
                                @if (novedadService.sesiones().length > 0) {
                                @for (s of novedadService.sesiones(); track s.id) {
                                <div class="sesion-item" [class.activo]="s.estado === 'activo'"
                                    [class.borrador]="s.estado === 'borrador'">
                                    <div class="sesion-main">
                                        <div class="sesion-status-indicator" [title]="s.estado"></div>
                                        <div class="sesion-details">
                                            <span class="sesion-name">{{ s.nombre }}</span>
                                            <span class="sesion-meta">
                                                {{ s.fechaInicio | date:'dd/MM' }} ‚Ä¢ {{ s.cursoId }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="sesion-actions">
                                        <ion-button fill="clear" size="small" color="primary"
                                            (click)="sesionDetalle.set(s)">
                                            <ion-icon name="information-circle-outline"></ion-icon>
                                        </ion-button>
                                        @if (s.estado === 'borrador') {
                                        <ion-button fill="clear" size="small" color="success"
                                            (click)="reanudarRevision(s)" title="Iniciar">
                                            <ion-icon name="play-circle"></ion-icon>
                                        </ion-button>
                                        }
                                        @if (s.estado === 'activo') {
                                        <ion-button fill="clear" size="small" color="medium" (click)="pausarRevision()"
                                            title="Pausar">
                                            <ion-icon slot="icon-only" name="stop-circle-outline"></ion-icon>
                                        </ion-button>
                                        <ion-button fill="clear" size="small" color="danger" (click)="cerrarRevision()"
                                            title="Cerrar">
                                            <ion-icon slot="icon-only" name="checkmark-done-outline"></ion-icon>
                                        </ion-button>
                                        }
                                        <ion-button fill="clear" size="small" color="danger"
                                            (click)="eliminarSesion(s.id)">
                                            <ion-icon name="trash-outline"></ion-icon>
                                        </ion-button>
                                    </div>
                                </div>
                                }
                                } @else {
                                <div class="empty-state-mini">
                                    <ion-icon name="list-outline"></ion-icon>
                                    <p>No hay sesiones registradas</p>
                                </div>
                                }
                            </div>
                            }
                        </div>
                    </ion-col>

                    <!-- COLUMNA 2: NOVEDAD (Centro) -->
                    <ion-col size="12" size-lg="6" class="column-container column-registration">
                        <div class="column-header">
                            <ion-icon name="checkmark-circle-outline"></ion-icon>
                            <h2>Novedad</h2>
                            <ion-badge [color]="estudiantesRegistrados().length > 0 ? 'primary' : 'medium'">
                                {{ estudiantesRegistrados().length }}
                            </ion-badge>
                        </div>

                        <!-- Configuraci√≥n de Sesi√≥n Mejorada -->
                        <div class="session-config-section">
                            <div class="session-header">
                                <ion-icon name="calendar-outline"></ion-icon>
                                <h3>Configuraci√≥n de Sesi√≥n</h3>
                            </div>

                            <div class="session-datetime-row">
                                <div class="datetime-field">
                                    <label>Inicio</label>
                                    <ion-datetime-button datetime="datetime-inicio"></ion-datetime-button>
                                    <ion-modal [keepContentsMounted]="true">
                                        <ng-template>
                                            <ion-datetime id="datetime-inicio" presentation="date-time"
                                                [value]="sesionInicio()" (ionChange)="onSesionInicioChange($event)"
                                                locale="es-ES">
                                            </ion-datetime>
                                        </ng-template>
                                    </ion-modal>
                                </div>
                                <div class="datetime-field">
                                    <label>Fin</label>
                                    <ion-datetime-button datetime="datetime-fin"></ion-datetime-button>
                                    <ion-modal [keepContentsMounted]="true">
                                        <ng-template>
                                            <ion-datetime id="datetime-fin" presentation="date-time"
                                                [value]="sesionFin()" (ionChange)="onSesionFinChange($event)"
                                                locale="es-ES">
                                            </ion-datetime>
                                        </ng-template>
                                    </ion-modal>
                                </div>
                            </div>

                            <ion-button expand="block" size="small" color="primary" (click)="iniciarRevision()"
                                [disabled]="!sesionInicio() || !sesionFin()">
                                <ion-icon slot="start" name="play-outline"></ion-icon>
                                {{ sesionActiva() ? 'Sesi√≥n Activa' : 'Iniciar Sesi√≥n' }}
                            </ion-button>
                        </div>

                        <!-- Secci√≥n de Alertas -->
                        @if (alertasSesion().length > 0) {
                        <div class="alerts-section">
                            <div class="alerts-header">
                                <ion-icon name="notifications-outline"></ion-icon>
                                <span>Alertas</span>
                                <ion-badge color="warning">{{ alertasSesion().length }}</ion-badge>
                            </div>
                            <div class="alerts-list">
                                @for (alerta of alertasSesion(); track alerta.id) {
                                <div class="alert-item" [class]="'alert-' + alerta.tipo">
                                    <ion-icon
                                        [name]="alerta.tipo === 'info' ? 'information-circle' : 
                                                      alerta.tipo === 'warning' ? 'warning' : 'alert-circle'"></ion-icon>
                                    <span>{{ alerta.mensaje }}</span>
                                    <ion-button fill="clear" size="small" (click)="descartarAlerta(alerta.id)">
                                        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                                    </ion-button>
                                </div>
                                }
                            </div>
                        </div>
                        }

                        <div class="registration-control-pane">
                            <div class="registration-actions-top">
                                <div class="selection-tools">
                                    @if (estudiantesRegistrados().length > 0) {
                                    <ion-button fill="clear" size="small" (click)="toggleSeleccionarTodos()">
                                        <ion-icon slot="start"
                                            [name]="seleccionadosIndices().size === estudiantesRegistrados().length ? 'checkbox' : 'square-outline'"></ion-icon>
                                        {{ seleccionadosIndices().size === estudiantesRegistrados().length ?
                                        'Deseleccionar' : 'Todos' }}
                                    </ion-button>
                                    <ion-button fill="clear" size="small" color="danger" (click)="limpiarRegistrados()">
                                        <ion-icon slot="start" name="trash-outline"></ion-icon>
                                        Limpiar
                                    </ion-button>
                                    }
                                </div>
                            </div>

                            @if (estudiantesRegistrados().length > 0) {
                            <!-- ADAPTIVE LAYOUT: TABLE (Desktop) vs GRID (Mobile) -->
                            <div class="novedades-adaptive-container">
                                @if (isDesktop()) {
                                <!-- DESKTOP VIEW: Data Table with CLICKABLE HEADERS -->
                                <table class="novedades-table desktop-only-table">
                                    <thead>
                                        <tr>
                                            <th class="student-col">Estudiante</th>
                                            <th class="novedad-col novedad-header-clickable"
                                                title="Click para aplicar a todos: Trabaja Solo"
                                                (click)="aplicarNovedadASeleccionados('trabaja_solo')">üë§</th>
                                            <th class="novedad-col novedad-header-clickable"
                                                title="Click para aplicar a todos: Grupo Bien"
                                                (click)="aplicarNovedadASeleccionados('grupo_bien')">üë•</th>
                                            <th class="novedad-col novedad-header-clickable"
                                                title="Click para aplicar a todos: Ausente"
                                                (click)="aplicarNovedadASeleccionados('ausente')">‚ùå</th>
                                            <th class="novedad-col novedad-header-clickable"
                                                title="Click para aplicar a todos: Incumplimiento"
                                                (click)="aplicarNovedadASeleccionados('aporte_nulo')">‚ö†Ô∏è</th>
                                            <th class="actions-col"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (est of estudiantesRegistrados(); track est.correo; let i = $index) {
                                        <tr class="student-row" [@itemAnimation]="i">
                                            <td class="student-info-cell">
                                                <div class="student-name">{{ est.nombre }}</div>
                                                <div class="student-meta">{{ getCodigoCorto(est.curso) }} - G{{
                                                    est.grupo }}</div>
                                            </td>
                                            <td class="novedad-cell">
                                                <button class="novedad-checkbox"
                                                    [class.checked]="tieneNovedad(est.correo, 'trabaja_solo')"
                                                    (click)="toggleNovedad(est.correo, 'trabaja_solo'); $event.stopPropagation()"
                                                    title="Trabaja Solo">
                                                    <ion-icon
                                                        [name]="tieneNovedad(est.correo, 'trabaja_solo') ? 'checkbox' : 'square-outline'"></ion-icon>
                                                </button>
                                            </td>
                                            <td class="novedad-cell">
                                                <button class="novedad-checkbox"
                                                    [class.checked]="tieneNovedad(est.correo, 'grupo_bien')"
                                                    (click)="toggleNovedad(est.correo, 'grupo_bien'); $event.stopPropagation()"
                                                    title="El grupo est√° trabajando bien">
                                                    <ion-icon
                                                        [name]="tieneNovedad(est.correo, 'grupo_bien') ? 'checkbox' : 'square-outline'"></ion-icon>
                                                </button>
                                            </td>
                                            <td class="novedad-cell">
                                                <button class="novedad-checkbox"
                                                    [class.checked]="tieneNovedad(est.correo, 'ausente')"
                                                    (click)="toggleNovedad(est.correo, 'ausente'); $event.stopPropagation()"
                                                    title="Ausente">
                                                    <ion-icon
                                                        [name]="tieneNovedad(est.correo, 'ausente') ? 'checkbox' : 'square-outline'"></ion-icon>
                                                </button>
                                            </td>
                                            <td class="novedad-cell">
                                                <button class="novedad-checkbox"
                                                    [class.checked]="tieneNovedad(est.correo, 'aporte_nulo')"
                                                    (click)="toggleNovedad(est.correo, 'aporte_nulo'); $event.stopPropagation()"
                                                    title="Incumplimiento de aportes">
                                                    <ion-icon
                                                        [name]="tieneNovedad(est.correo, 'aporte_nulo') ? 'checkbox' : 'square-outline'"></ion-icon>
                                                </button>
                                            </td>
                                            <td class="actions-cell">
                                                <ion-button fill="clear" size="small" color="danger"
                                                    (click)="removerRegistrado(i); $event.stopPropagation()">
                                                    <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                                                </ion-button>
                                            </td>
                                        </tr>
                                        }
                                    </tbody>
                                </table>

                                } @else {
                                <!-- MOBILE/TABLET VIEW: Card Grid -->
                                <div class="mobile-student-grid">
                                    @for (est of estudiantesRegistrados(); track est.correo; let i = $index) {
                                    <ion-card class="student-card-mobile" [@itemAnimation]="i">
                                        <div class="card-mobile-header">
                                            <div class="student-details">
                                                <span class="name">{{ est.nombre }}</span>
                                                <span class="meta">{{ getCodigoCorto(est.curso) }} ‚Ä¢ G{{
                                                    est.grupo }}</span>
                                            </div>
                                            <ion-button fill="clear" color="medium" size="small"
                                                (click)="removerRegistrado(i)" class="remove-btn-mobile">
                                                <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                                            </ion-button>
                                        </div>

                                        <div class="novedad-toggles-grid">
                                            <button class="novedad-toggle-btn"
                                                [class.active]="tieneNovedad(est.correo, 'trabaja_solo')"
                                                (click)="toggleNovedad(est.correo, 'trabaja_solo')">
                                                <ion-icon
                                                    [name]="tieneNovedad(est.correo, 'trabaja_solo') ? 'person' : 'person-outline'"></ion-icon>
                                                <span>Solo</span>
                                            </button>

                                            <button class="novedad-toggle-btn"
                                                [class.active]="tieneNovedad(est.correo, 'grupo_bien')"
                                                (click)="toggleNovedad(est.correo, 'grupo_bien')">
                                                <ion-icon
                                                    [name]="tieneNovedad(est.correo, 'grupo_bien') ? 'people' : 'people-outline'"></ion-icon>
                                                <span>Bien</span>
                                            </button>

                                            <button class="novedad-toggle-btn"
                                                [class.active]="tieneNovedad(est.correo, 'ausente')"
                                                (click)="toggleNovedad(est.correo, 'ausente')">
                                                <ion-icon
                                                    [name]="tieneNovedad(est.correo, 'ausente') ? 'close-circle' : 'close-circle-outline'"></ion-icon>
                                                <span>Ausente</span>
                                            </button>

                                            <button class="novedad-toggle-btn"
                                                [class.active]="tieneNovedad(est.correo, 'aporte_nulo')"
                                                (click)="toggleNovedad(est.correo, 'aporte_nulo')">
                                                <ion-icon
                                                    [name]="tieneNovedad(est.correo, 'aporte_nulo') ? 'warning' : 'warning-outline'"></ion-icon>
                                                <span>Incump.</span>
                                            </button>
                                        </div>
                                    </ion-card>
                                    }
                                </div>
                                }
                            </div>

                            <!-- RESUMEN DE NOVEDADES (Parte inferior) -->
                            @if (tieneNovedadesPendientes()) {
                            <div class="novedades-resumen-section">
                                <div class="resumen-header">
                                    <ion-icon name="document-text-outline"></ion-icon>
                                    <h4>Resumen de Novedades</h4>
                                    <ion-badge color="primary">{{ getResumenNovedades().length }}</ion-badge>
                                </div>

                                <div class="resumen-lista">
                                    @for (item of getResumenNovedades(); track item.correo) {
                                    <div class="resumen-item">
                                        <span class="resumen-nombre">{{ item.nombre }}</span>
                                        <div class="resumen-novedades">
                                            @for (novedad of item.novedades; track novedad) {
                                            <ion-chip size="small" [color]="novedad === 'trabaja_solo' ? 'warning' : 
                                                         novedad === 'grupo_bien' ? 'success' : 
                                                         novedad === 'ausente' ? 'danger' : 'secondary'">
                                                <ion-label>
                                                    {{ novedad === 'trabaja_solo' ? 'üë§ Solo' :
                                                    novedad === 'grupo_bien' ? 'üë• Bien' :
                                                    novedad === 'ausente' ? '‚ùå Ausente' : '‚ö†Ô∏è Incump.' }}
                                                </ion-label>
                                                <ion-icon name="close-circle"
                                                    (click)="removerNovedadItem(item.correo, novedad)"></ion-icon>
                                            </ion-chip>
                                            }
                                        </div>
                                    </div>
                                    }
                                </div>

                                <!-- √Årea de comentarios -->
                                <div class="comentarios-section">
                                    <ion-textarea [(ngModel)]="descripcionNovedad"
                                        placeholder="Comentarios adicionales (opcional)..." rows="2"
                                        class="comentarios-textarea">
                                    </ion-textarea>
                                </div>

                                <!-- Bot√≥n Guardar -->
                                <div class="guardar-section">
                                    <ion-button expand="block" color="primary" (click)="guardarNovedades()">
                                        <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                                        Guardar Novedades ({{ getResumenNovedades().length }})
                                    </ion-button>
                                </div>
                            </div>
                            }

                            } @else {
                            <div class="empty-state registration-empty">
                                <ion-icon name="person-add-outline"></ion-icon>
                                <p>No hay estudiantes seleccionados</p>
                                <small>Usa el buscador arriba para agregar estudiantes a esta lista.</small>
                            </div>
                            }
                        </div>
                    </ion-col>

                    <!-- COLUMNA 3: PANORAMA DE CURSOS (Derecha) -->
                    <ion-col size="12" size-lg="3" class="column-container column-courses">
                        <div class="courses-card-list" [@listAnimation]="cursosResumen().length">
                            @if (isLoading()) {
                            <!-- Skeleton loaders durante la carga -->
                            @for (i of [1, 2, 3]; track i) {
                            <ion-card class="course-card-premium skeleton-card">
                                <div class="card-color-strip" style="background: #e0e0e0;"></div>
                                <ion-card-header>
                                    <ion-card-title>
                                        <ion-skeleton-text [animated]="true" style="width: 60%;"></ion-skeleton-text>
                                    </ion-card-title>
                                    <ion-card-subtitle>
                                        <ion-skeleton-text [animated]="true" style="width: 80%;"></ion-skeleton-text>
                                    </ion-card-subtitle>
                                </ion-card-header>
                            </ion-card>
                            }
                            } @else if (cursosResumen().length === 0) {
                            <div class="empty-state">
                                <ion-icon name="school-outline"></ion-icon>
                                <p>No hay cursos cargados</p>
                            </div>
                            } @else {
                            @for (curso of cursosResumen(); track curso.codigo) {
                            <ion-card class="course-card-premium"
                                [class.selected]="cursoSeleccionado() === curso.codigo"
                                [style.--course-color]="curso.color" (click)="toggleCursoSeleccion(curso.codigo)"
                                @itemAnimation>
                                <div class="card-color-strip" [style.background]="curso.color"></div>

                                <!-- Mobile selection mode indicator (only on mobile) -->
                                @if (!isDesktop()) {
                                <div class="card-mobile-mode-icon">
                                    @if (gruposSeleccionados().size > 1) {
                                    <ion-icon name="pin-outline" [style.color]="curso.color"></ion-icon>
                                    } @else if (gruposSeleccionados().size === 1) {
                                    <ion-icon name="lock-open-outline" [style.color]="curso.color"></ion-icon>
                                    }
                                </div>
                                }

                                <!-- Desktop selection indicator -->
                                @if (isDesktop()) {
                                <div class="card-selection-indicator">
                                    @if (cursoSeleccionado() === curso.codigo) {
                                    <ion-icon name="checkmark-circle" color="primary"></ion-icon>
                                    }
                                </div>
                                }

                                <ion-card-header>
                                    <ion-card-title>{{ getCodigoCorto(curso.codigo) }}</ion-card-title>
                                </ion-card-header>
                            </ion-card>
                            }
                            }
                        </div>

                        <!-- Dynamic Group Buttons (Moved below courses) -->
                        @if (cursoSeleccionado()) {
                        <div class="grupos-selector-bar-global">
                            <div class="grupos-selector-header">
                                <div class="grupos-selector-label">
                                    <ion-icon name="people-outline"></ion-icon>
                                    <span>Grupos de {{ getCodigoCorto(cursoSeleccionado()!) }}</span>
                                </div>
                            </div>
                            <ion-grid class="grupos-buttons-grid">
                                <ion-row>
                                    @for (grupo of gruposDelCursoSeleccionado(); track grupo) {
                                    <ion-col size="6" size-sm="4" size-md="3" size-lg="2.4">
                                        <ion-button [fill]="'clear'" size="small" expand="block"
                                            class="grupo-dynamic-btn"
                                            [class.selected]="gruposSeleccionados().has(grupo)"
                                            [style.--color]="colorDelCursoSeleccionado()"
                                            (click)="toggleGrupoSeleccion(grupo, $event)">
                                            @if (gruposSeleccionados().has(grupo)) {
                                            <ion-icon slot="start" name="checkmark-circle"></ion-icon>
                                            }
                                            G{{ grupo }}
                                        </ion-button>
                                    </ion-col>
                                    }
                                </ion-row>
                            </ion-grid>
                            <div class="hint-text">
                                <ion-icon name="information-circle-outline"></ion-icon>
                                <span>Ctrl/Cmd + Click para seleccionar m√∫ltiples grupos</span>
                            </div>
                        </div>
                        }

                        <!-- SECTION: Group Members List (Available to Select) -->
                        @if (estudiantesDeGruposSeleccionados().length > 0) {
                        <div class="group-members-section">
                            <div class="section-header">
                                <div class="actions-row">
                                    <ion-button fill="clear" size="small" (click)="seleccionarTodosGrupo()">
                                        <ion-icon slot="start" name="checkbox-outline"></ion-icon>
                                        Todos
                                    </ion-button>
                                    <ion-button fill="clear" size="small" color="medium"
                                        (click)="deseleccionarTodosGrupo()">
                                        <ion-icon slot="start" name="square-outline"></ion-icon>
                                        Ninguno
                                    </ion-button>
                                </div>
                            </div>

                            <div class="members-list-grid">
                                @for (est of estudiantesDeGruposSeleccionados(); track est.correo) {
                                <div class="member-item" [class.selected]="isEstudianteGrupoSeleccionado(est.correo)"
                                    (click)="toggleSeleccionEstudianteGrupo(est.correo)">
                                    <ion-checkbox [checked]="isEstudianteGrupoSeleccionado(est.correo)"
                                        (click)="$event.stopPropagation()"></ion-checkbox>
                                    <div class="member-info">
                                        <span class="name">{{ est.nombre }}</span>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                        }
                    </ion-col>
                </ion-row>
            </ion-grid>
        </div>



        <!-- FAB B√∫squeda (Todos los Viewports) -->
        <ion-fab slot="fixed" vertical="bottom" horizontal="start" style="bottom: 70px" class="fab-search">
            <ion-fab-button color="primary" (click)="toggleSearchModal()">
                <ion-icon name="search"></ion-icon>
            </ion-fab-button>
        </ion-fab>

        <!-- FAB Registrar (Solo M√≥vil) -->
        <ion-fab slot="fixed" vertical="bottom" horizontal="end" style="bottom: 70px" class="ion-hide-lg-up"
            *ngIf="estudiantesSeleccionados().length > 0">
            <ion-fab-button color="primary" (click)="registrarEnLista()">
                <ion-icon name="add"></ion-icon>
            </ion-fab-button>
            <ion-badge color="danger" class="fab-badge"
                style="position: absolute; top: -5px; right: -5px; border-radius: 50%;">{{
                estudiantesSeleccionados().length }}</ion-badge>
        </ion-fab>

        <!-- MODAL DE REGISTRO DE NOVEDAD -->
        <ion-modal [isOpen]="isModalRegistroVisible()" (didDismiss)="cerrarModalRegistro()" class="registration-modal"
            @modalAnimation>
            <ng-template>
                <ion-header>
                    <ion-toolbar color="primary">
                        <ion-title>Registrar Novedad</ion-title>
                        <ion-buttons slot="end">
                            <ion-button (click)="cerrarModalRegistro()">
                                <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                            </ion-button>
                        </ion-buttons>
                    </ion-toolbar>
                </ion-header>
                <ion-content class="ion-padding">
                    <div class="modal-form-container">
                        <!-- Resumen de seleccionados -->
                        <div class="form-section">
                            <label class="section-label">Estudiantes Seleccionados ({{ seleccionadosIndices().size
                                }})</label>
                            <div class="selected-summary-chips">
                                @for (idx of Array.from(seleccionadosIndices()); track idx) {
                                @if (estudiantesRegistrados()[idx]) {
                                <ion-chip outline color="primary">
                                    <ion-label>{{ estudiantesRegistrados()[idx].nombre.split(' ')[0] }}</ion-label>
                                </ion-chip>
                                }
                                }
                            </div>
                        </div>

                        <!-- Tipo de novedad -->
                        <div class="form-section">
                            <label class="section-label">Tipo de Novedad</label>
                            <div class="tipo-selector-grid">
                                @for (tipo of tiposNovedad(); track tipo.id) {
                                <div class="tipo-option-card" [class.active]="tipoNovedadSeleccionado()?.id === tipo.id"
                                    (click)="tipoNovedadSeleccionado.set(tipo)" [style.--tipo-color]="tipo.color">
                                    <ion-icon [name]="tipo.icono"></ion-icon>
                                    <span>{{ tipo.nombre }}</span>
                                    @if (tipoNovedadSeleccionado()?.id === tipo.id) {
                                    <div class="check-badge"><ion-icon name="checkmark-outline"></ion-icon></div>
                                    }
                                </div>
                                }
                            </div>
                        </div>

                        <!-- Origen -->
                        <div class="form-section">
                            <label class="section-label">Canal de Origen</label>
                            <div class="origen-selector-row">
                                @for (origen of ['teams', 'canvas', 'foro', 'email', 'presencial']; track origen) {
                                <div class="origen-option" [class.active]="origenSeleccionado() === origen"
                                    (click)="origenSeleccionado.set($any(origen))" [title]="getOrigenLabel(origen)">
                                    <ion-icon [name]="getOrigenIcon(origen)"
                                        [style.color]="getOrigenColor(origen)"></ion-icon>
                                    @if (origenSeleccionado() === origen) {
                                    <span class="origen-label">{{ getOrigenLabel(origen) }}</span>
                                    }
                                </div>
                                }
                            </div>
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="form-section">
                            <label class="section-label">Notas Adicionales (Opcional)</label>
                            <ion-textarea [value]="descripcionNovedad()"
                                (ionInput)="descripcionNovedad.set($any($event.target).value)"
                                placeholder="Ej: El estudiante inform√≥ por chat..." rows="3" class="custom-textarea">
                            </ion-textarea>
                        </div>

                        <div class="form-actions-footer">
                            <ion-button expand="block" color="primary" class="confirm-btn"
                                [disabled]="!tipoNovedadSeleccionado()" (click)="registrarNovedadConfirmada()">
                                <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                                Confirmar Registro
                            </ion-button>
                        </div>
                    </div>
                </ion-content>
            </ng-template>
        </ion-modal>

        <!-- MODAL DE DETALLES DE SESI√ìN -->
        <ion-modal [isOpen]="!!sesionDetalle()" (didDismiss)="sesionDetalle.set(null)" class="details-modal">
            <ng-template>
                <ion-header>
                    <ion-toolbar>
                        <ion-title>{{ sesionDetalle()?.nombre }}</ion-title>
                        <ion-buttons slot="end">
                            <ion-button (click)="sesionDetalle.set(null)">Cerrar</ion-button>
                        </ion-buttons>
                    </ion-toolbar>
                </ion-header>
                <ion-content class="ion-padding">
                    <div class="session-details-content">
                        <div class="detail-header">
                            <div class="detail-meta">
                                <span>{{ sesionDetalle()?.cursoId }}</span>
                                <span>{{ sesionDetalle()?.fechaInicio | date:'dd/MM/yyyy HH:mm' }}</span>
                            </div>
                            <ion-badge [color]="sesionDetalle()?.estado === 'cerrado' ? 'success' : 'warning'">
                                {{ sesionDetalle()?.estado }}
                            </ion-badge>
                        </div>

                        <div class="novelties-details-list">
                            <h3>Novedades en esta sesi√≥n ({{ novedadesDeSesion().length }})</h3>
                            @if (novedadesDeSesion().length > 0) {
                            @for (n of novedadesDeSesion(); track n.id) {
                            <div class="novelty-detail-card" [class.grupal]="n.esNovedadGrupal">
                                <div class="n-header">
                                    <span class="estudiante">{{ n.estudianteNombre }}</span>
                                    <span class="grupo">G{{ n.grupo }}</span>
                                </div>
                                <div class="n-body">
                                    <ion-chip size="small" [style.--background]="getTipoColor(n.tipoNovedadId)">
                                        {{ n.tipoNovedadNombre }}
                                    </ion-chip>
                                    @if (n.descripcion) {
                                    <p class="description">{{ n.descripcion }}</p>
                                    }
                                </div>
                            </div>
                            }
                            } @else {
                            <div class="empty-state-mini">
                                <p>No hay novedades guardadas en esta sesi√≥n.</p>
                            </div>
                            }
                        </div>
                    </div>
                </ion-content>
            </ng-template>
        </ion-modal>

        <!-- MODAL DE B√öSQUEDA Y REGISTRO -->
        <ion-modal [isOpen]="isSearchModalVisible()" (didDismiss)="closeSearchModal()" class="search-modal">
            <ng-template>
                <ion-header>
                    <ion-toolbar color="primary">
                        <ion-title>Registrar Novedad</ion-title>
                        <ion-buttons slot="end">
                            <ion-button (click)="closeSearchModal()">
                                <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                            </ion-button>
                        </ion-buttons>
                    </ion-toolbar>
                </ion-header>
                <ion-content class="ion-padding relative-content">

                    <!-- Barra de b√∫squeda -->
                    <ion-searchbar [value]="busquedaTermino()" (ionInput)="onBusquedaChange($event)"
                        placeholder="Buscar estudiante... (#C cursos, #G grupo)" mode="ios" class="modal-searchbar">
                    </ion-searchbar>

                    <!-- CAJ√ìN DE RESULTADOS (B√öSQUEDA ACTIVA) -->
                    @if (busquedaTermino().length > 0) {
                    <div class="search-results-list">
                        @if (resultadosBusqueda().length > 0) {
                        @for (resultado of resultadosBusqueda(); track resultado.correo) {
                        <div class="search-result-item"
                            [class.selected]="isEstudianteSeleccionadoModal(resultado.correo)"
                            (click)="toggleEstudianteSeleccionModal(resultado, resultado.curso!)">
                            <ion-icon
                                [name]="isEstudianteSeleccionadoModal(resultado.correo) ? 'checkmark-circle' : 'person-outline'"
                                [class.selected-icon]="isEstudianteSeleccionadoModal(resultado.correo)"></ion-icon>
                            <div class="result-info">
                                <div class="main-text">{{ resultado.nombre }}</div>
                                <div class="sub-text">
                                    <span>{{ resultado.correo }}</span>
                                    <span class="meta-tag">{{ resultado.curso }}</span>
                                    <span class="meta-tag">G{{ resultado.grupo }}</span>
                                </div>
                            </div>
                        </div>
                        }
                        } @else {
                        <div class="empty-state-mini">
                            <p>No se encontraron resultados</p>
                        </div>
                        }
                    </div>
                    } @else {
                    <!-- ACORDEONES DE CURSOS (B√öSQUEDA INACTIVA) -->
                    <div class="accordion-list">
                        <ion-accordion-group>
                            @for (curso of cursosResumen(); track curso.codigo) {
                            <ion-accordion [value]="curso.codigo">
                                <ion-item slot="header" color="light">
                                    <ion-label>
                                        <h2>{{ curso.nombre }}</h2>
                                        <p>{{ curso.codigo }} ‚Ä¢ {{ curso.estudiantes }} estudiantes</p>
                                    </ion-label>
                                </ion-item>
                                <div slot="content">
                                    <ion-accordion-group>
                                        @for (grupo of curso.grupos; track grupo) {
                                        <ion-accordion [value]="curso.codigo + '-' + grupo">
                                            <ion-item slot="header">
                                                <ion-checkbox slot="start"
                                                    [checked]="isGrupoSeleccionadoModal(curso.codigo, grupo)"
                                                    (click)="$event.stopPropagation(); toggleGrupoSeleccionModal(curso.codigo, grupo)">
                                                </ion-checkbox>
                                                <ion-label>Grupo {{ grupo }}</ion-label>
                                            </ion-item>
                                            <div slot="content">
                                                @for (est of getEstudiantesGrupo(curso.codigo, grupo); track est.correo)
                                                {
                                                <ion-item lines="full">
                                                    <ion-checkbox slot="start"
                                                        [checked]="isEstudianteSeleccionadoModal(est.correo)"
                                                        (click)="toggleEstudianteSeleccionModal(est, curso.codigo)">
                                                    </ion-checkbox>
                                                    <ion-label>
                                                        <h3>{{ est.nombres }} {{ est.apellidos }}</h3>
                                                        <p>{{ est.correo }}</p>
                                                    </ion-label>
                                                </ion-item>
                                                }
                                            </div>
                                        </ion-accordion>
                                        }
                                    </ion-accordion-group>
                                </div>
                            </ion-accordion>
                            }
                        </ion-accordion-group>
                    </div>
                    }

                    <!-- FAB AGREGAR AL BUFFER -->
                    @if (estudiantesSeleccionados().length > 0) {
                    <ion-fab slot="fixed" vertical="bottom" horizontal="end">
                        <ion-fab-button (click)="agregarAlBuffer()" color="success">
                            <ion-icon name="checkmark"></ion-icon>
                        </ion-fab-button>
                        <ion-badge color="danger" style="position: absolute; top: -5px; right: -5px; z-index: 10;">
                            {{ estudiantesSeleccionados().length }}
                        </ion-badge>
                    </ion-fab>
                    }
                </ion-content>
            </ng-template>
        </ion-modal>
    </div><!-- /page-container -->
</ion-content>