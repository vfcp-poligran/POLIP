<ion-content class="mobile-optimized" [fullscreen]="true">
  <!-- FAB nativo de Ionic para móvil portrait -->
  <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="fab-menu-container">
    <ion-fab-button color="primary">
      <ion-icon name="ellipsis-vertical-outline"></ion-icon>
    </ion-fab-button>

    <ion-fab-list side="top">
      <!-- Navegación de grupo anterior -->
      <ion-fab-button color="primary" [disabled]="!grupoAnteriorDisponible" (click)="retrocederGrupo()"
        data-desc="Grupo anterior">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-fab-button>

      <!-- Navegación de grupo siguiente -->
      <ion-fab-button color="primary" [disabled]="!grupoSiguienteDisponible" (click)="avanzarGrupo()"
        data-desc="Grupo siguiente">
        <ion-icon name="arrow-forward-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>

  <div class="layout" [ngStyle]="layoutStyles">
    <div class="page-container">
      <!-- Barra de navegación común: Botón Vista General + Selectores de curso -->
      @if (cursosDisponibles.length > 0) {
      <div class="page-title-header">
        <div class="header-course-selector">
          <!-- Botón Vista General -->
          <button type="button"
                  class="vista-general-toggle-btn"
                  [class.activo]="vistaGeneralActiva"
                  (click)="irAVistaGeneral()"
                  title="Vista General">
            <ion-icon name="apps"></ion-icon>
          </button>
          <ion-segment
            [scrollable]="true"
            [value]="cursoActivo"
            (ionChange)="onCursoChange($event)"
            class="course-segment">
            @for (curso of cursosDisponibles; track curso) {
            <ion-segment-button
              [value]="curso"
              [style.--course-color]="getCourseColor(curso)"
              class="course-segment-button">
              <div class="segment-button-content">
                <ion-label class="segment-label">
                  <span class="course-name">{{ getCodigoCorto(curso) }}</span>
                </ion-label>
                <ion-icon
                  name="ellipsis-vertical"
                  class="segment-menu-icon"
                  (click)="abrirMenuColor($event, curso); $event.stopPropagation()"
                  [attr.aria-label]="'Opciones de ' + curso"></ion-icon>
              </div>
            </ion-segment-button>
            }
          </ion-segment>
        </div>
      </div>
      }

      <!-- Barra de búsqueda global -->
      @if (cursosDisponibles.length > 0) {
      <div class="search-bar-container">
        <ion-searchbar
          [(ngModel)]="busquedaGeneral"
          (ionInput)="onBusquedaChange($event)"
          placeholder="Buscar estudiante..."
          debounce="300"
          mode="ios"
          class="main-searchbar">
        </ion-searchbar>
      </div>
      }

      <!-- Popover para cambiar color (Ionic nativo) - Botón 3 puntos -->
      <ion-popover
        [isOpen]="menuColorVisible"
        [event]="colorPopoverEvent"
        (didDismiss)="cerrarMenuColor()"
        size="auto"
        alignment="start"
        class="color-picker-popover-wrapper"
        role="dialog"
        aria-label="Selector de color para curso">
        <ng-template>
          <div class="color-picker-popover">
            <div class="color-picker-header">
              <span role="heading" aria-level="2">Color del curso</span>
              <ion-icon name="close-outline" (click)="cerrarMenuColor()" aria-label="Cerrar"></ion-icon>
            </div>
            <div class="color-picker-content">
              <!-- Grid de colores predefinidos - clic aplica directamente -->
              <div class="color-picker-grid" role="radiogroup" aria-label="Colores disponibles">
                @for (color of coloresDisponibles; track color) {
                <div
                  role="radio"
                  aria-checked="false"
                  [attr.aria-checked]="cursoParaCambiarColor ? (getCourseColor(cursoParaCambiarColor) === color ? 'true' : 'false') : 'false'"
                  [attr.aria-label]="'Color ' + color"
                  class="color-option"
                  [style.background-color]="color"
                  [class.selected]="cursoParaCambiarColor && getCourseColor(cursoParaCambiarColor) === color"
                  [title]="color"
                  tabindex="0"
                  (click)="aplicarColorDirecto(color)"
                  (keydown.enter)="aplicarColorDirecto(color)"
                  (keydown.space)="aplicarColorDirecto(color); $event.preventDefault()">
                  @if (cursoParaCambiarColor && getCourseColor(cursoParaCambiarColor) === color) {
                  <ion-icon name="checkmark-circle" aria-hidden="true"></ion-icon>
                  }
                </div>
                }
              </div>
            </div>
          </div>
        </ng-template>
      </ion-popover>

      <!-- Mensaje si no hay cursos -->
      @if (cursosDisponibles.length === 0) {
      <div class="empty-state-fullscreen">
        <div class="empty-state-content">
          <h3>No hay información disponible</h3>
          <p>Gestione la información a través de las opciones <strong><ion-icon name="library" class="icon-menu"></ion-icon> Cursos</strong> y <strong><ion-icon name="speedometer" class="icon-menu"></ion-icon> Rúbricas</strong></p>
        </div>
      </div>
      }

      <!-- ==================== -->
      <!-- VISTA GENERAL (Multi-curso) -->
      <!-- ==================== -->
      @if (vistaGeneralActiva && cursosDisponibles.length > 0) {
      <div class="vista-general-section">
        <ion-card class="vista-general-card">
          <ion-card-content class="vista-general-content">
            <!-- Contenido de Vista General - Se irá agregando -->
            <div class="vista-general-placeholder">
              <ion-icon name="construct-outline" class="placeholder-icon"></ion-icon>
              <p>Sección en construcción</p>
              <span class="hint">Aquí se mostrarán las herramientas de gestión multi-curso</span>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
      }

      <!-- Lista de Estudiantes (Vista de curso específico) -->
      @if (!vistaGeneralActiva && cursoActivo && estudiantesActuales.length > 0) {
      <div class="estudiantes-section">

        <!-- Panel General -->
        <ion-card class="dashboard-options">
          <ion-card-header class="header-con-toggle">
            <!-- Breadcrumb de navegación -->
            <div class="breadcrumb-navigation">
              <ion-icon name="home-outline" class="breadcrumb-icon"></ion-icon>
              @if (cursoActivo) {
                <span class="breadcrumb-item curso-name" [title]="cursoActivo">
                  {{ getNombreCompletoConGrupo(cursoActivo) }}
                </span>
                @if (filtroGrupo !== 'todos') {
                  <ion-icon name="chevron-forward-outline" class="breadcrumb-separator"></ion-icon>
                  <span class="breadcrumb-item grupo-name" [style.color]="getCourseColor(cursoActivo)">Grupo {{ filtroGrupo }}</span>
                  @if (entregaEvaluando) {
                    <ion-icon name="chevron-forward-outline" class="breadcrumb-separator"></ion-icon>
                    <span class="breadcrumb-item entrega-name">{{ entregaEvaluando }}</span>
                  }
                }
              }
            </div>
          </ion-card-header>
          <ion-card-content>

            <!-- Barra de navegación de grupos - ÚNICA -->
            <div class="grupos-nav-bar">
              <div class="grupos-buttons">
                <!-- Botón Vista General (todos) -->
                <button type="button"
                        class="grupo-nav-btn grupo-nav-btn-dashboard"
                        [class.activo]="filtroGrupo === 'todos'"
                        (click)="volverAMatriz()"
                        title="Vista general - Todos los grupos">
                  <ion-icon name="grid"></ion-icon>
                </button>
                <!-- Ícono de grupos - siempre visible -->
                <ion-icon name="people-circle-outline" class="grupos-icon"></ion-icon>
                <!-- Números de grupos -->
                @for (grupo of gruposDisponibles; track grupo) {
                  <button type="button"
                          class="grupo-nav-btn"
                          [class.activo]="filtroGrupo === grupo"
                          (click)="navegarAGrupo(grupo)"
                          [title]="'Ver detalle del Grupo ' + grupo">
                    {{ grupo }}
                  </button>
                }
              </div>
            </div>

            <!-- Vista: Todos los grupos -->
            @if (filtroGrupo === 'todos') {

            <!-- Panel de Resumen Grupal -->
            <div class="entregas-resumen-panel">

              <!-- Tabla de Entregas -->
              <table class="entregas-tabla">
                <thead>
                  <tr>
                    <th class="col-entrega">Entrega</th>
                    <th class="col-evaluados">
                      <ion-icon name="checkmark-done-circle"></ion-icon>
                      Evaluados
                    </th>
                    <th class="col-pendientes">
                      <ion-icon name="hourglass-outline"></ion-icon>
                      Por calificar
                    </th>
                    <th class="col-atencion">
                      <ion-icon name="warning"></ion-icon>
                      Atención
                    </th>
                  </tr>
                </thead>
                <tbody>
                  @let statsE1 = getEstadisticasEntrega('E1');
                  @let statsE2 = getEstadisticasEntrega('E2');
                  @let statsEF = getEstadisticasEntrega('EF');
                  <tr class="fila-entrega" (click)="filtroEntregaDinamica = 'E1'" [class.activa]="filtroEntregaDinamica === 'E1'">
                    <td class="col-entrega">
                      <span class="entrega-nombre">Primera</span>
                    </td>
                    <td class="col-evaluados">{{ statsE1.evaluados }}</td>
                    <td class="col-pendientes">{{ statsE1.porCalificar }}</td>
                    <td class="col-atencion" [class.con-atencion]="statsE1.atencionEspecial > 0">
                      @if (statsE1.atencionEspecial > 0) {
                        <ion-icon name="warning"></ion-icon>
                      }
                      {{ statsE1.atencionEspecial }}
                    </td>
                  </tr>
                  <tr class="fila-entrega" (click)="filtroEntregaDinamica = 'E2'" [class.activa]="filtroEntregaDinamica === 'E2'">
                    <td class="col-entrega">
                      <span class="entrega-nombre">Segunda</span>
                    </td>
                    <td class="col-evaluados">{{ statsE2.evaluados }}</td>
                    <td class="col-pendientes">{{ statsE2.porCalificar }}</td>
                    <td class="col-atencion" [class.con-atencion]="statsE2.atencionEspecial > 0">
                      @if (statsE2.atencionEspecial > 0) {
                        <ion-icon name="warning"></ion-icon>
                      }
                      {{ statsE2.atencionEspecial }}
                    </td>
                  </tr>
                  <tr class="fila-entrega" (click)="filtroEntregaDinamica = 'EF'" [class.activa]="filtroEntregaDinamica === 'EF'">
                    <td class="col-entrega">
                      <span class="entrega-nombre">Final</span>
                    </td>
                    <td class="col-evaluados">{{ statsEF.evaluados }}</td>
                    <td class="col-pendientes">{{ statsEF.porCalificar }}</td>
                    <td class="col-atencion" [class.con-atencion]="statsEF.atencionEspecial > 0">
                      @if (statsEF.atencionEspecial > 0) {
                        <ion-icon name="warning"></ion-icon>
                      }
                      {{ statsEF.atencionEspecial }}
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Resumen total -->
              <div class="resumen-total">
                @let resumenTotal = getResumenTotalCurso();
                <div class="total-item">
                  <ion-icon name="people"></ion-icon>
                  <span class="total-valor">{{ resumenTotal.totalEstudiantes }}</span>
                  <span class="total-label">Estudiantes</span>
                </div>
                <div class="total-item">
                  <ion-icon name="albums"></ion-icon>
                  <span class="total-valor">{{ resumenTotal.totalGrupos }}</span>
                  <span class="total-label">Grupos</span>
                </div>
                <div class="total-item atencion" [class.visible]="resumenTotal.gruposAtencion > 0">
                  <ion-icon name="alert-circle"></ion-icon>
                  <span class="total-valor">{{ resumenTotal.gruposAtencion }}</span>
                  <span class="total-label">Requieren atención</span>
                </div>
              </div>
            </div>

            } @else {
            <!-- Vista: Grupo específico seleccionado -->
            <div class="grupo-detail-content">

                @if (obtenerIntegrantesGrupo().length > 0) {
                <!-- Mensaje informativo - el seguimiento se hace en el panel lateral -->
                <div class="grupo-info-placeholder">
                  <ion-icon name="information-circle-outline" color="medium"></ion-icon>
                  <ion-text color="medium">
                    <p>Use el panel de seguimiento lateral para gestionar los integrantes del grupo <strong>{{ filtroGrupo }}</strong></p>
                    <small>{{ obtenerIntegrantesGrupo().length }} integrantes</small>
                  </ion-text>
                </div>
                } @else {
                <ion-item lines="none">
                  <ion-icon name="alert-circle" slot="start" color="medium"></ion-icon>
                  <ion-label color="medium">
                    <p>No hay integrantes en este grupo</p>
                  </ion-label>
                </ion-item>
                }
            </div>
            }

          </ion-card-content>
        </ion-card>
      </div>
      }
    </div>
  </div>
</ion-content>
