<ion-content [fullscreen]="true">
  <div class="page-container">
    <div class="tab-content rubricas-tab-content">

      <!-- Título de la página -->
      <div class="page-title-header">
        <div class="title-wrapper">
          <h2>Rúbricas</h2>
        </div>
        <div class="header-actions">
          @if (!modoEdicion) {
            <ion-button size="small" fill="solid" color="success" (click)="nuevaRubrica()" class="btn-add-rubrica">
              <ion-icon name="add-circle-outline" slot="start"></ion-icon>
              Crear
            </ion-button>
          } @else {
            <ion-button size="small" fill="solid" color="primary" (click)="guardarRubricaEditada()">
              <ion-icon name="save-outline" slot="start"></ion-icon>
              Guardar
            </ion-button>
            <ion-button size="small" fill="solid" color="warning" (click)="cancelarEdicion()">
              Cancelar
            </ion-button>
          }
        </div>
      </div>

      @if (modoEdicion) {
        <!-- Contenedor de carga de archivo de rúbrica -->
        <div class="upload-wrapper" [class.expanded]="infoExpanded">
          <!-- Mensaje instructivo con icono -->
          <div class="upload-instructions">
            <ion-icon name="information-circle-outline" (click)="toggleInfo()"></ion-icon>
            <span class="info-text">Cargue un archivo de rúbrica en formato TXT con la estructura definida</span>
          </div>

          <!-- Barra de carga de archivo -->
          <div class="tabla-info-bar">
            <input
              type="file"
              #rubricaFileInput
              accept=".txt"
              (change)="onRubricaFileSelected($event)"
              class="file-input-hidden"
              aria-label="Cargar archivo TXT de rúbrica"
            />

            <div class="upload-section">
              <div class="upload-btn-container" (click)="rubricaFileInput.click()">
                <ion-icon name="cloud-upload"></ion-icon>
                <span class="btn-label">Rúbrica TXT</span>
              </div>
              @if (rubricaFileName) {
                <div class="file-loaded-info">
                  <div class="file-details">
                    <span class="file-full-name">{{ rubricaFileName }}</span>
                    <ion-icon name="close-circle" (click)="limpiarRubrica()" class="remove-file"></ion-icon>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }

      <!-- Área principal: Tabla de rúbricas -->
      <div class="tabla-area">
        @if (rubricas.length > 0) {

          <!-- Vista Desktop: Tabla tradicional -->
          <div class="tabla-wrapper tabla-completa desktop-only">
            <table class="tabla-rubricas">
              <thead>
                <tr>
                  <th class="tabla-header col-nombre">Nombre de Rúbrica</th>
                  <th class="tabla-header col-tipo">Tipo</th>
                  <th class="tabla-header col-entrega">Entrega</th>
                  <th class="tabla-header col-criterios">Criterios</th>
                  <th class="tabla-header col-puntos">Puntos</th>
                  <th class="tabla-header col-fecha">Fecha Creación</th>
                  <th class="tabla-header col-acciones">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (rubrica of rubricas; track rubrica.id; let i = $index; let isOdd = $odd) {
                  <tr [class.fila-par]="!isOdd" [class.fila-impar]="isOdd">
                    <td class="tabla-cell col-nombre">{{ rubrica.nombre }}</td>
                    <td class="tabla-cell col-tipo">
                      <span class="tipo-badge" [class.tipo-grupal]="rubrica.tipoRubrica === 'PG'" [class.tipo-individual]="rubrica.tipoRubrica === 'PI'">
                        {{ rubrica.tipoRubrica === 'PG' ? 'Grupal' : 'Individual' }}
                      </span>
                    </td>
                    <td class="tabla-cell col-entrega">
                      <span class="entrega-badge">{{ rubrica.tipoEntrega || '—' }}</span>
                    </td>
                    <td class="tabla-cell col-criterios">{{ rubrica.criterios.length || 0 }}</td>
                    <td class="tabla-cell col-puntos">{{ rubrica.puntuacionTotal || 0 }}</td>
                    <td class="tabla-cell col-fecha">{{ rubrica.fechaCreacion || '—' }}</td>
                    <td class="tabla-cell col-acciones">
                      <ion-button size="small" fill="clear" color="primary" (click)="editarRubrica(rubrica)">
                        <ion-icon name="create-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                      <ion-button size="small" fill="clear" color="danger" (click)="confirmarEliminarRubrica(rubrica)">
                        <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                      </ion-button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Vista Móvil: Cards con componentes Ionic -->
          <ion-list class="mobile-only rubrica-cards">
            @for (rubrica of rubricas; track rubrica.id) {
              <ion-item lines="none" class="rubrica-card">
                <ion-card>
                  <ion-card-header>
                    <ion-card-title>
                      <span class="rubrica-nombre-mobile">{{ rubrica.nombre }}</span>
                    </ion-card-title>
                  </ion-card-header>

                  <ion-card-content>
                    <ion-grid>
                      <ion-row>
                        <ion-col size="6">
                          <div class="info-item">
                            <ion-icon name="people-outline"></ion-icon>
                            <span class="info-label">Tipo:</span>
                            <span class="info-value">{{ rubrica.tipoRubrica === 'PG' ? 'Grupal' : 'Individual' }}</span>
                          </div>
                        </ion-col>
                        <ion-col size="6">
                          <div class="info-item">
                            <ion-icon name="document-outline"></ion-icon>
                            <span class="info-label">Entrega:</span>
                            <span class="info-value">{{ rubrica.tipoEntrega || '—' }}</span>
                          </div>
                        </ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size="6">
                          <div class="info-item">
                            <ion-icon name="list-outline"></ion-icon>
                            <span class="info-label">Criterios:</span>
                            <span class="info-value">{{ rubrica.criterios.length || 0 }}</span>
                          </div>
                        </ion-col>
                        <ion-col size="6">
                          <div class="info-item">
                            <ion-icon name="trophy-outline"></ion-icon>
                            <span class="info-label">Puntos:</span>
                            <span class="info-value">{{ rubrica.puntuacionTotal || 0 }}</span>
                          </div>
                        </ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size="12">
                          <div class="badges-wrapper">
                            <ion-chip [color]="rubrica.tipoRubrica === 'PG' ? 'primary' : 'tertiary'">
                              <ion-icon name="people"></ion-icon>
                              <ion-label>{{ rubrica.tipoRubrica === 'PG' ? 'Grupal' : 'Individual' }}</ion-label>
                            </ion-chip>
                            @if (rubrica.tipoEntrega) {
                              <ion-chip color="secondary">
                                <ion-icon name="document-text"></ion-icon>
                                <ion-label>{{ rubrica.tipoEntrega }}</ion-label>
                              </ion-chip>
                            }
                          </div>
                        </ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size="12">
                          <div class="acciones-mobile">
                            <ion-button expand="block" fill="outline" color="primary" (click)="editarRubrica(rubrica)">
                              <ion-icon name="create-outline" slot="start"></ion-icon>
                              Editar
                            </ion-button>
                            <ion-button expand="block" fill="outline" color="danger" (click)="confirmarEliminarRubrica(rubrica)">
                              <ion-icon name="trash-outline" slot="start"></ion-icon>
                              Eliminar
                            </ion-button>
                          </div>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
              </ion-item>
            }
          </ion-list>

        } @else {
          <!-- Empty state -->
          <div class="empty-state">
            <h3>No hay Rúbricas Registradas</h3>
            <p>Seleccione "Crear" para agregar una nueva rúbrica</p>
          </div>
        }
      </div>

    </div>
  </div>
</ion-content>
