<ion-content [fullscreen]="true">

  <div class="page-container">
    <div class="grid-principal-responsive" [class.with-detalle]="rubricaSeleccionada">
      <!-- Sección de Rúbricas -->
      <ion-card class="cuadrante-card rubricas-card">
        <ion-card-header>
          <ion-grid class="ion-no-padding">
            <ion-row class="ion-align-items-start">
              <!-- Sección izquierda: Título -->
              <ion-col size="12" sizeMd="" class="ion-align-self-start">
                <ion-card-title class="title-no-margin">
                  <ion-icon name="clipboard"></ion-icon>
                  Rúbricas
                </ion-card-title>
              </ion-col>

              <!-- Sección de Importar en modo edición -->
              @if (modoEdicion) {
              <ion-col size="12" sizeMd="" class="ion-padding-vertical">
                <div class="import-container">
                  <div class="import-item" [class.has-file]="rubricaFileName" (click)="fileInput.click()">
                    <input #fileInput type="file" accept=".txt,text/plain" aria-label="Importar Rúbrica"
                      (change)="onRubricaFileSelected($event)" class="display-none">
                    <div class="import-top">
                      <ion-icon name="document-text"></ion-icon>
                      <span>Rúbrica</span>
                      <ion-icon name="cloud-upload" class="upload-icon"></ion-icon>
                    </div>
                    <div class="import-bottom">
                      @if (rubricaFileName) {
                      <span class="filename">{{ rubricaFileName }}</span>
                      <ion-icon name="close-circle" (click)="desvincularArchivoRubrica(); $event.stopPropagation()"
                        class="close-icon-small"></ion-icon>
                      } @else {
                      <span class="no-file">Cargar Archivo</span>
                      }
                    </div>
                  </div>
                </div>
              </ion-col>
              }

              <!-- Barra de acciones a la derecha -->
              <ion-col size="12" sizeMd="auto" class="ion-align-self-center">
                <div class="action-bar">
                  @if (!modoEdicion) {
                  <ion-button class="action-btn-square" (click)="nuevaRubrica()">
                    <ion-icon slot="start" name="add-circle"></ion-icon>
                    Crear
                  </ion-button>
                  } @else {
                  <ion-button class="action-btn-square" color="medium" (click)="cancelarEdicion()">
                    <ion-icon slot="start" name="close"></ion-icon>
                    Cancelar
                  </ion-button>
                  @if (rubricaSeleccionada) {
                  <ion-button class="action-btn-square" color="success" (click)="guardarRubrica(rubricaSeleccionada)">
                    <ion-icon slot="start" name="save"></ion-icon>
                    Guardar
                  </ion-button>
                  }
                  }
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-card-header>
        <ion-card-content>

          <!-- Contenedor de Rúbricas Disponibles -->
          <div class="rubricas-container" [class.two-column-layout]="rubricaSeleccionada && !modoEdicion">

            @if (rubricas.length === 0) {
            <div class="empty-state">
              <p>No hay rúbricas disponibles</p>
            </div>
            } @else {

            <!-- Vista Desktop: Lista Ionic con sliding -->
            <ion-list lines="full" [class.list-compact]="rubricaSeleccionada && !modoEdicion" class="desktop-only">
              @for (rubrica of rubricas; track rubrica.id) {
              <ion-item-sliding>
                <ion-item [class.item-selected]="rubricaSeleccionada?.id === rubrica.id" button
                  (click)="seleccionarRubrica(rubrica)">
                  <ion-label>
                    <div class="rubrica-info-wrapper">
                      <div class="rubrica-main-info">
                        <h2>{{ rubrica.nombre }}</h2>
                      </div>
                      <div class="rubrica-meta-row">
                        <p class="rubrica-fecha">
                          <ion-icon name="calendar" size="small"></ion-icon>
                          {{ rubrica.fechaCreacion | date: 'dd/MM/yyyy' }}
                        </p>
                        <p class="rubrica-curso">{{ obtenerNombreCursoAsociado(rubrica) }}</p>
                        <ion-badge color="success" class="puntos-badge">
                          {{ rubrica.puntuacionTotal }} pts
                        </ion-badge>
                        <ion-badge color="tertiary">
                          {{ rubrica.criterios.length }} criterios
                        </ion-badge>
                      </div>
                    </div>
                  </ion-label>
                </ion-item>

                <ion-item-options side="end">
                  <ion-item-option color="warning" (click)="seleccionarRubrica(rubrica); editarRubricaSeleccionada()">
                    <ion-icon slot="icon-only" name="pencil"></ion-icon>
                  </ion-item-option>
                  <ion-item-option color="danger" (click)="eliminarRubrica(rubrica, $event)">
                    <ion-icon slot="icon-only" name="trash"></ion-icon>
                  </ion-item-option>
                </ion-item-options>
              </ion-item-sliding>
              }
            </ion-list>

            <!-- Vista Móvil: Cards con componentes Ionic -->
            <ion-list class="mobile-only rubrica-cards">
              @for (rubrica of rubricas; track rubrica.id) {
              <ion-item lines="none" class="rubrica-card">
                <ion-card (click)="seleccionarRubrica(rubrica)">
                  <ion-card-header>
                    <ion-card-title>
                      <span class="rubrica-nombre-mobile">{{ rubrica.nombre }}</span>
                    </ion-card-title>
                  </ion-card-header>

                  <ion-card-content>
                    <ion-grid>
                      <ion-row>
                        <ion-col size="6">
                          <div class="info-item">
                            <ion-icon name="calendar-outline"></ion-icon>
                            <span class="info-label">Fecha:</span>
                            <span class="info-value">{{ rubrica.fechaCreacion | date: 'dd/MM/yyyy' }}</span>
                          </div>
                        </ion-col>
                        <ion-col size="6">
                          <div class="info-item">
                            <ion-icon name="school-outline"></ion-icon>
                            <span class="info-label">Curso:</span>
                            <span class="info-value">{{ obtenerNombreCursoAsociado(rubrica) }}</span>
                          </div>
                        </ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size="12">
                          <div class="badges-wrapper">
                            <ion-chip color="success">
                              <ion-icon name="trophy-outline"></ion-icon>
                              <ion-label>{{ rubrica.puntuacionTotal }} pts</ion-label>
                            </ion-chip>
                            <ion-chip color="tertiary">
                              <ion-icon name="list-outline"></ion-icon>
                              <ion-label>{{ rubrica.criterios.length }} criterios</ion-label>
                            </ion-chip>
                          </div>
                        </ion-col>
                      </ion-row>
                      <ion-row>
                        <ion-col size="12">
                          <div class="acciones-mobile">
                            <ion-button expand="block" fill="outline" color="primary" (click)="seleccionarRubrica(rubrica); $event.stopPropagation()">
                              <ion-icon name="eye-outline" slot="start"></ion-icon>
                              Ver
                            </ion-button>
                            <ion-button expand="block" fill="outline" color="warning" (click)="seleccionarRubrica(rubrica); editarRubricaSeleccionada(); $event.stopPropagation()">
                              <ion-icon name="pencil-outline" slot="start"></ion-icon>
                              Editar
                            </ion-button>
                            <ion-button expand="block" fill="outline" color="danger" (click)="eliminarRubrica(rubrica, $event); $event.stopPropagation()">
                              <ion-icon name="trash-outline" slot="start"></ion-icon>
                              Eliminar
                            </ion-button>
                          </div>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
              </ion-item>
              }
            </ion-list>

            }

          </div>
        </ion-card-content>
      </ion-card>

      <!-- Sección de Detalle de Rúbrica Seleccionada - VISTA DE SOLO LECTURA -->
      @if (rubricaSeleccionada && !modoEdicion) {
      <ion-card class="cuadrante-card detalle-rubrica-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="information-circle"></ion-icon>
            {{ rubricaSeleccionada.nombre }}
          </ion-card-title>
        </ion-card-header>

        <ion-card-content class="detalle-content">

          <!-- Información General -->
          <ion-grid class="info-general-compact" fixed>
            <ion-row class="info-row">
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Tipo:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                @if (rubricaSeleccionada.tipoRubrica) {
                <ion-badge [color]="rubricaSeleccionada.tipoRubrica === 'PG' ? 'primary' : 'secondary'">
                  {{ rubricaSeleccionada.tipoRubrica === 'PG' ? 'Grupal' : 'Individual' }}
                </ion-badge>
                } @else {
                <ion-badge color="medium">Sin definir</ion-badge>
                }
              </ion-col>
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Entrega:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                @if (rubricaSeleccionada.tipoEntrega) {
                <ion-badge color="tertiary">{{ rubricaSeleccionada.tipoEntrega }}</ion-badge>
                } @else {
                <ion-badge color="medium">N/A</ion-badge>
                }
              </ion-col>
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Criterios:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                <ion-text color="dark"><strong>{{ rubricaSeleccionada.criterios.length }}</strong></ion-text>
              </ion-col>
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Puntos:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                <ion-text color="success"><strong>{{ rubricaSeleccionada.puntuacionTotal }}</strong></ion-text>
              </ion-col>
            </ion-row>
            <ion-row class="info-row">
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Creación:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                <ion-text color="medium">{{ rubricaSeleccionada.fechaCreacion ? (rubricaSeleccionada.fechaCreacion | date:'dd/MM/yyyy') : '-' }}</ion-text>
              </ion-col>
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Hora:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                <ion-text color="medium">{{ rubricaSeleccionada.fechaCreacion ? (rubricaSeleccionada.fechaCreacion | date:'HH:mm') : '-' }}</ion-text>
              </ion-col>
              <ion-col size="auto" class="info-cell">
                <ion-label class="info-label">Cursos Asignados:</ion-label>
              </ion-col>
              <ion-col class="info-cell">
                <ion-text color="dark"><strong>{{ getCursosAsignados(rubricaSeleccionada).length }}</strong></ion-text>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- Asignación de Cursos -->
          <div class="cursos-section">
            <h3>
              <ion-icon name="school-outline"></ion-icon>
              Cursos Asignados
            </h3>

            @if (cursosDisponibles.length === 0) {
            <div class="no-cursos-message">
              <ion-icon name="school" class="no-cursos-icon"></ion-icon>
              <p class="no-cursos">No hay cursos disponibles.</p>
              <p class="no-cursos-hint">Vaya a la opción de <ion-icon name="library"></ion-icon>
                <strong>Cursos</strong> para crear un nuevo curso.
              </p>
            </div>
            } @else {
            <div class="cursos-grid-columns">
              @for (curso of cursosDisponibles; track curso.codigo) {
              @if (isCursoAsignado(curso.codigo, rubricaSeleccionada)) {
              <div class="curso-column-card">
                <div class="curso-codigo">{{ curso.nombreAbreviado }}</div>
                <div class="curso-nombre">{{ curso.nombre }}</div>
              </div>
              }
              }
              @if (getCursosAsignados(rubricaSeleccionada).length === 0) {
              <div class="no-cursos-asignados">
                Sin cursos asignados
              </div>
              }
            </div>
            }
          </div>

          <!-- Escala de Calificación -->
          <div class="escala-section">
            <h3>
              <ion-icon name="bar-chart-outline"></ion-icon>
              Escala de Calificación
            </h3>
            <ion-grid class="escala-grid-horizontal">
              <ion-row class="ion-nowrap">
                @for (escala of rubricaSeleccionada.escalaCalificacion; track escala.rango; let i = $index) {
                <ion-col>
                  <div class="escala-card" [class.escala-danger]="i === 0" [class.escala-warning]="i === 1" [class.escala-success]="i === 2">
                    <div class="escala-rango">{{ escala.rango }}</div>
                    <div class="escala-descripcion">{{ escala.descripcion }}</div>
                  </div>
                </ion-col>
                }
              </ion-row>
            </ion-grid>
          </div>

          <!-- Tabla de Rúbrica -->
          <div class="tabla-section">
            <h3>
              <ion-icon name="list-outline"></ion-icon>
              Tabla de Evaluación
            </h3>
            <div class="tabla-rubrica-container">
              <table class="tabla-rubrica">
                <thead>
                  <tr>
                    <th class="criterio-column">Criterio</th>
                    <th class="peso-column">Peso</th>
                    @for (nivel of rubricaSeleccionada.criterios[0]?.nivelesDetalle; track nivel.titulo) {
                    <th [class]="'nivel-column nivel-' + nivel.color">
                      {{ nivel.titulo }}
                    </th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (criterio of rubricaSeleccionada.criterios; track criterio.titulo; let i = $index) {
                  <tr>
                    <td class="criterio-cell">
                      <div class="criterio-nombre">
                        <ion-icon name="checkbox-outline"></ion-icon>
                        <strong>{{ criterio.titulo }}</strong>
                      </div>
                    </td>
                    <td class="peso-cell">
                      <ion-chip color="primary" size="small">
                        {{ criterio.peso }}
                      </ion-chip>
                    </td>
                    @for (nivel of criterio.nivelesDetalle; track nivel.titulo) {
                    <td [class]="'nivel-cell nivel-' + nivel.color">
                      <div class="nivel-content">
                        <div class="nivel-puntos">
                          <ion-badge
                            [color]="nivel.color === 'danger' ? 'danger' : nivel.color === 'warning' ? 'warning' : 'success'">
                            {{ nivel.puntos }} pts
                          </ion-badge>
                        </div>
                        <p class="nivel-descripcion">{{ nivel.descripcion }}</p>
                      </div>
                    </td>
                    }
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>

        </ion-card-content>
      </ion-card>
      }

      <!-- Sección de Detalle de Rúbrica Seleccionada - MODO EDICIÓN -->
      @if (rubricaSeleccionada && modoEdicion) {
      <ion-card class="cuadrante-card detalle-rubrica-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="pencil"></ion-icon>
            Editando: {{ rubricaSeleccionada.nombre }}
          </ion-card-title>
        </ion-card-header>

        <ion-card-content class="detalle-content">

          <!-- Información General Editable -->
          <div class="info-general-editable">
            <ion-item>
              <ion-label position="stacked">Tipo de Rúbrica</ion-label>
              <ion-select [(ngModel)]="rubricaSeleccionada.tipoRubrica" interface="popover"
                placeholder="Seleccionar tipo">
                <ion-select-option value="PG">Grupal (PG)</ion-select-option>
                <ion-select-option value="PI">Individual (PI)</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="stacked">Tipo de Entrega</ion-label>
              <ion-select [(ngModel)]="rubricaSeleccionada.tipoEntrega" interface="popover"
                placeholder="Seleccionar entrega">
                <ion-select-option value="E1">Entrega 1 (E1)</ion-select-option>
                <ion-select-option value="E2">Entrega 2 (E2)</ion-select-option>
                <ion-select-option value="EF">Entrega Final (EF)</ion-select-option>
              </ion-select>
            </ion-item>

            <div class="info-stats">
              <div class="stat-item">
                <ion-icon name="list"></ion-icon>
                <span>{{ rubricaSeleccionada.criterios.length }} criterios</span>
              </div>
              <div class="stat-item">
                <ion-icon name="trophy"></ion-icon>
                <span>{{ rubricaSeleccionada.puntuacionTotal }} puntos</span>
              </div>
            </div>
          </div>

          <!-- Asignación de Cursos - EDITABLE -->
          <div class="cursos-section">
            <h3>Asignar a Cursos</h3>

            @if (cursosDisponibles.length === 0) {
            <div class="no-cursos-message">
              <ion-icon name="school" class="no-cursos-icon"></ion-icon>
              <p class="no-cursos">No hay cursos disponibles.</p>
              <p class="no-cursos-hint">Vaya a la opción de <ion-icon name="library"></ion-icon>
                <strong>Cursos</strong> para crear un nuevo curso.
              </p>
            </div>
            } @else {
            <div class="cursos-checkboxes">
              @for (curso of cursosDisponibles; track curso.codigo) {
              <ion-item lines="none" class="curso-checkbox-item">
                <ion-checkbox slot="start" [checked]="isCursoAsignado(curso.codigo, rubricaSeleccionada)"
                  (ionChange)="toggleCursoAsignacion(curso.codigo, rubricaSeleccionada, $event)">
                </ion-checkbox>
                <ion-label>
                  <h3>{{ curso.nombre }}</h3>
                  <p><strong>{{ curso.codigo }}</strong> - {{ curso.nombreAbreviado }}</p>
                </ion-label>
              </ion-item>
              }
            </div>
            }
          </div>

          <!-- Escala de Calificación -->
          <div class="escala-section">
            <h3>Escala de Calificación</h3>
            <ion-grid class="escala-grid">
              <ion-row>
                @for (escala of rubricaSeleccionada.escalaCalificacion; track escala.rango) {
                <ion-col size="12" sizeMd="4">
                  <ion-chip color="primary" class="escala-chip-full">
                    <ion-label>{{ escala.rango }}: {{ escala.descripcion }}</ion-label>
                  </ion-chip>
                </ion-col>
                }
              </ion-row>
            </ion-grid>
          </div>

          <!-- Tabla de Rúbrica - Solo lectura en edición (la estructura no se modifica aquí) -->
          <div class="tabla-section">
            <h3>Tabla de Evaluación</h3>
            <p class="tabla-nota">La estructura de criterios y niveles se define al importar la rúbrica.</p>
            <div class="tabla-rubrica-container">
              <table class="tabla-rubrica">
                <thead>
                  <tr>
                    <th class="criterio-column">Criterio</th>
                    <th class="peso-column">Peso</th>
                    @for (nivel of rubricaSeleccionada.criterios[0]?.nivelesDetalle; track nivel.titulo) {
                    <th [class]="'nivel-column nivel-' + nivel.color">
                      {{ nivel.titulo }}
                    </th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (criterio of rubricaSeleccionada.criterios; track criterio.titulo; let i = $index) {
                  <tr>
                    <td class="criterio-cell">
                      <div class="criterio-nombre">
                        <ion-icon name="checkbox-outline"></ion-icon>
                        <strong>{{ criterio.titulo }}</strong>
                      </div>
                    </td>
                    <td class="peso-cell">
                      <ion-chip color="primary" size="small">
                        {{ criterio.peso }}
                      </ion-chip>
                    </td>
                    @for (nivel of criterio.nivelesDetalle; track nivel.titulo) {
                    <td [class]="'nivel-cell nivel-' + nivel.color">
                      <div class="nivel-content">
                        <div class="nivel-puntos">
                          <ion-badge
                            [color]="nivel.color === 'danger' ? 'danger' : nivel.color === 'warning' ? 'warning' : 'success'">
                            {{ nivel.puntos }} pts
                          </ion-badge>
                        </div>
                        <p class="nivel-descripcion">{{ nivel.descripcion }}</p>
                      </div>
                    </td>
                    }
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>

        </ion-card-content>
      </ion-card>
      }

    </div>
  </div>
</ion-content>
