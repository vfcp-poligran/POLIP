<ion-menu side="end" menuId="tipos-menu" contentId="main-content">
    <ion-header>
        <ion-toolbar color="primary">
            <ion-title>Tipo de Novedad</ion-title>
        </ion-toolbar>
    </ion-header>
    <ion-content>
        <ion-list>
            @for (tipo of tiposNovedad(); track tipo.id) {
            <ion-item (click)="seleccionarTipoDesdeMenu(tipo)" button detail="false">
                <ion-icon [name]="tipo.icono" slot="start" [style.color]="tipo.color"></ion-icon>
                <ion-label>{{ tipo.nombre }}</ion-label>
                @if (tipoNovedadSeleccionado()?.id === tipo.id) {
                <ion-icon name="checkmark-outline" slot="end" color="primary"></ion-icon>
                }
            </ion-item>
            }
        </ion-list>
    </ion-content>
</ion-menu>

<ion-content id="main-content" class="inicio-draft-content" [fullscreen]="true">

    <!-- HEADER CON BÚSQUEDA -->
    <div class="page-header">
        <div class="header-top">
            <div class="header-title">
                <ion-icon name="home-outline"></ion-icon>
                <h1>Panel de Control</h1>
                @if (!isOnline()) {
                <ion-chip color="warning" class="offline-chip">
                    <ion-icon name="cloud-offline-outline"></ion-icon>
                    <ion-label>Offline</ion-label>
                </ion-chip>
                }
            </div>
            <div class="header-actions">
                @if (pendientesCount() > 0) {
                <ion-badge color="warning" class="pending-badge">
                    {{ pendientesCount() }} pendientes
                </ion-badge>
                }
            </div>
        </div>

        <!-- Barra de búsqueda + Chips de tipos -->
        <div class="search-tipos-row">
            <div class="search-container">
                <ion-searchbar [value]="busquedaTermino()" (ionInput)="onBusquedaChange($event)"
                    placeholder="Buscar estudiante... (#C cursos, #G1 grupo)" mode="ios" class="student-searchbar">
                </ion-searchbar>

                <!-- Resultados de búsqueda -->
                @if (resultadosBusqueda().length > 0) {
                <div class="search-results-dropdown">
                    <div class="dropdown-actions">
                        <span class="dropdown-hint">Click para seleccionar/deseleccionar</span>
                        <ion-button fill="clear" size="small" (click)="limpiarBusqueda()">
                            <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                        </ion-button>
                    </div>
                    @for (resultado of resultadosBusqueda(); track resultado.correo) {
                    <div class="search-result-item" [class.selected]="isEstudianteSeleccionado(resultado.correo)"
                        (click)="seleccionarEstudiante(resultado)">
                        <ion-icon
                            [name]="isEstudianteSeleccionado(resultado.correo) ? 'checkmark-circle' : 'person-outline'"
                            [class.selected-icon]="isEstudianteSeleccionado(resultado.correo)"></ion-icon>
                        <div class="result-info">
                            <span class="result-name">{{ resultado.nombre }}</span>
                            <span class="result-meta">{{ getCodigoCorto(resultado.curso) }} - Grupo {{ resultado.grupo
                                }}</span>
                        </div>
                        <ion-icon
                            [name]="isEstudianteSeleccionado(resultado.correo) ? 'checkmark-outline' : 'add-outline'"
                            class="add-icon"></ion-icon>
                    </div>
                    }
                </div>
                }

                <!-- Dropdown de cursos para comando #C -->
                @if (sugerenciasCursos().length > 0) {
                <div class="search-results-dropdown cursos-dropdown">
                    <div class="dropdown-header">
                        <ion-icon name="school-outline"></ion-icon>
                        <span>Seleccionar curso</span>
                    </div>
                    @for (curso of sugerenciasCursos(); track curso.codigo) {
                    <div class="search-result-item curso-item" (click)="seleccionarCursoFiltro(curso)">
                        <div class="curso-color-dot" [style.background]="curso.color"></div>
                        <div class="result-info">
                            <span class="result-name">{{ getCodigoCorto(curso.codigo) }}</span>
                            <span class="result-meta">{{ curso.estudiantes }} estudiantes</span>
                        </div>
                        <ion-icon name="chevron-forward-outline" class="add-icon"></ion-icon>
                    </div>
                    }
                </div>
                }
            </div>

            <!-- Chips de estudiantes seleccionados -->
            @if (estudiantesSeleccionados().length > 0) {
            <div class="selected-students-bar">
                <div class="selected-chips">
                    @for (est of estudiantesSeleccionados(); track est.correo) {
                    <ion-chip class="student-chip" [style.--chip-color]="'#4a90e2'">
                        <ion-label>{{ est.nombre.split(' ')[0] }}</ion-label>
                        <ion-icon name="close-outline" (click)="removerEstudiante(est.correo)"></ion-icon>
                    </ion-chip>
                    }
                </div>
                <ion-button fill="solid" color="primary" size="small" (click)="registrarEnLista()">
                    <ion-icon name="add-outline" slot="start"></ion-icon>
                    Registrar ({{ estudiantesSeleccionados().length }})
                </ion-button>
            </div>
            }
        </div>

        <!-- Chips de tipos de novedad (Desktop) -->
        @if (isDesktop()) {
        <div class="tipos-filtro-chips">
            @for (tipo of tiposNovedad(); track tipo.id) {
            <ion-chip [class.selected]="isTipoFiltroActivo(tipo.id)" [style.--chip-color]="tipo.color"
                (click)="toggleTipoFiltro(tipo.id)">
                <ion-icon [name]="tipo.icono"></ion-icon>
                <ion-label>{{ tipo.nombre }}</ion-label>
            </ion-chip>
            }
        </div>
        }
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-content">

        <!-- SECCIÓN: Panorama de Cursos -->
        <section class="cursos-panorama">
            <div class="section-header">
                <ion-icon name="apps-outline"></ion-icon>
                <h2>Cursos</h2>
                <ion-badge color="medium">{{ cursosResumen().length }}</ion-badge>
            </div>

            @if (cursosResumen().length === 0) {
            <div class="empty-state">
                <ion-icon name="school-outline"></ion-icon>
                <p>No hay cursos cargados</p>
                <small>Vaya a la sección Cursos para importar datos</small>
            </div>
            } @else {
            <ion-accordion-group [value]="cursoExpandido()" (ionChange)="onAccordionChange($event)"
                class="cursos-accordion">
                @for (curso of cursosResumen(); track curso.codigo) {
                <ion-accordion [value]="curso.codigo" class="curso-accordion">
                    <ion-item slot="header" class="curso-accordion-header" [style.--border-color]="curso.color">
                        <div class="curso-color-indicator" [style.background]="curso.color"></div>
                        <ion-label>
                            <h3>{{ getCodigoCorto(curso.codigo) }}</h3>
                            <p>{{ curso.estudiantes }} estudiantes</p>
                        </ion-label>
                        @if (curso.novedadesPendientes > 0) {
                        <ion-badge slot="end" color="warning">{{ curso.novedadesPendientes }}</ion-badge>
                        }
                    </ion-item>
                    <div slot="content" class="curso-grupos-content">
                        <div class="grupos-buttons">
                            @for (grupo of curso.grupos; track grupo) {
                            <ion-button fill="outline" size="small" class="grupo-btn"
                                [style.--border-color]="curso.color" [style.--color]="curso.color"
                                (click)="seleccionarGrupo(curso, grupo)">
                                G{{ grupo }}
                            </ion-button>
                            }
                        </div>
                    </div>
                </ion-accordion>
                }
            </ion-accordion-group>
            }
        </section>

        <!-- SECCIÓN: Novedades Registradas (Tabla) -->
        <section class="novedades-registradas">
            <div class="section-header">
                <ion-icon name="checkmark-done-circle-outline"></ion-icon>
                <h2>Novedades Registradas</h2>
                <ion-badge [color]="pendientesCount() > 0 ? 'warning' : 'success'">
                    {{ pendientesCount() }}
                </ion-badge>
            </div>

            @if (novedadesPendientes().length === 0) {
            <div class="empty-state success">
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                <p>No hay nuevas novedades registradas por sincronizar</p>
            </div>
            } @else {
            <div class="table-container">
                <table class="custom-table novedades-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Estudiante</th>
                            <th class="hide-mobile">Curso / Grupo</th>
                            <th class="hide-mobile">Origen</th>
                            <th class="hide-mobile">Fecha</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (novedad of novedadesPendientes(); track novedad.id) {
                        <tr>
                            <td>
                                <div class="tipo-cell">
                                    <div class="tipo-dot" [style.background]="getTipoColor(novedad.tipoNovedadId)">
                                    </div>
                                    <ion-icon [name]="getTipoIcon(novedad.tipoNovedadId)"
                                        [style.color]="getTipoColor(novedad.tipoNovedadId)"></ion-icon>
                                    <span>{{ novedad.tipoNovedadNombre }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="student-cell">
                                    <span class="name">{{ novedad.estudianteNombre || novedad.estudianteCorreo }}</span>
                                    <span class="email hide-desktop">{{ novedad.estudianteCorreo }}</span>
                                </div>
                            </td>
                            <td class="hide-mobile">
                                <ion-chip class="mini-chip">
                                    {{ getCodigoCorto(novedad.cursoId) }} G{{ novedad.grupo }}
                                </ion-chip>
                            </td>
                            <td class="hide-mobile">
                                <div class="origen-cell">
                                    <ion-icon [name]="getOrigenIcon(novedad.origen)"
                                        [style.color]="getOrigenColor(novedad.origen)"></ion-icon>
                                    <span>{{ getOrigenLabel(novedad.origen) }}</span>
                                </div>
                            </td>
                            <td class="hide-mobile">
                                <span class="fecha-text">{{ formatFecha(novedad.fechaRegistro) }}</span>
                            </td>
                            <td>
                                <div class="actions-cell">
                                    <ion-button fill="clear" color="success" size="small"
                                        (click)="confirmarNovedad(novedad)" title="Confirmar">
                                        <ion-icon slot="icon-only" name="checkmark-circle-outline"></ion-icon>
                                    </ion-button>
                                    <ion-button fill="clear" color="primary" size="small"
                                        (click)="editarNovedad(novedad)" title="Editar">
                                        <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                                    </ion-button>
                                    <ion-button fill="clear" color="danger" size="small"
                                        (click)="descartarNovedad(novedad)" title="Eliminar">
                                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                                    </ion-button>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
        </section>

        <!-- SECCIÓN: Lista de Novedades (Grilla de Selección) -->
        @if (estudiantesRegistrados().length > 0) {
        <section class="estudiantes-registrados novedades-section">
            <div class="section-header">
                <ion-icon name="document-text-outline"></ion-icon>
                <h2>Estudiantes para Novedad</h2>
                <ion-badge color="primary">{{ estudiantesRegistrados().length }}</ion-badge>
                <div class="header-actions">
                    <ion-button fill="clear" size="small" color="medium" (click)="toggleSeleccionarTodos()"
                        title="Seleccionar todos">
                        <ion-icon slot="icon-only" name="checkmark-done-outline"></ion-icon>
                    </ion-button>
                    <ion-button fill="clear" size="small" color="danger" (click)="limpiarRegistrados()"
                        title="Limpiar lista">
                        <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                    </ion-button>
                </div>
            </div>

            <ion-grid class="novedades-grid">
                <ion-row>
                    @for (est of estudiantesRegistrados(); track $index) {
                    <ion-col size="12" size-sm="6" size-md="4" size-lg="3">
                        <div class="novedad-card-selectable" [class.selected]="isNovedadSelected($index)"
                            (click)="toggleSeleccionNovedad($index)">
                            <div class="card-selection-check">
                                <ion-checkbox [checked]="isNovedadSelected($index)" (click)="$event.stopPropagation()"
                                    (ionChange)="toggleSeleccionNovedad($index)"></ion-checkbox>
                            </div>
                            <div class="card-info">
                                <span class="student-name">{{ est.nombre }}</span>
                                <div class="student-meta">
                                    <ion-chip class="mini-chip">
                                        {{ getCodigoCorto(est.curso) }} G{{ est.grupo }}
                                    </ion-chip>
                                </div>
                            </div>
                            <ion-button fill="clear" color="danger" size="small" class="btn-remove"
                                (click)="$event.stopPropagation(); removerRegistrado($index)">
                                <ion-icon slot="icon-only" name="close-outline"></ion-icon>
                            </ion-button>
                        </div>
                    </ion-col>
                    }
                </ion-row>
            </ion-grid>
        </section>
        }

        <!-- SECCIÓN: Opciones de Registro (Desktop) -->
        <!-- SECCIÓN: Asignar Novedad (Panel Avanzado Desktop) -->
        @if (isDesktop()) {
        <section class="registro-opciones-desktop panel-asignacion">
            <div class="section-header">
                <ion-icon name="add-circle-outline"></ion-icon>
                <h2>Asignar Novedad Grupal</h2>
                <ion-badge color="tertiary" class="codigo-novedad-badge">{{ codigoNovedad() }}</ion-badge>
            </div>

            <div class="asignacion-content">
                <ion-grid>
                    <ion-row>
                        <!-- Alias y Fecha -->
                        <ion-col size="12" size-md="6">
                            <div class="input-group">
                                <label>Nombre / Alias de la Novedad</label>
                                <ion-item lines="none" class="custom-input-item">
                                    <ion-input [(ngModel)]="aliasNovedad"
                                        placeholder="Ej: Falta masiva, Retraso Teams..."></ion-input>
                                </ion-item>
                            </div>
                        </ion-col>
                        <ion-col size="12" size-md="6">
                            <div class="input-group">
                                <label>Fecha y Hora</label>
                                <ion-item lines="none" class="custom-input-item datetime-item">
                                    <ion-datetime-button datetime="datetime"></ion-datetime-button>
                                    <ion-modal [keepContentsMounted]="true">
                                        <ng-template>
                                            <ion-datetime id="datetime" [(ngModel)]="fechaHoraNovedad"></ion-datetime>
                                        </ng-template>
                                    </ion-modal>
                                </ion-item>
                            </div>
                        </ion-col>

                        <!-- Tipos (Multi-select) -->
                        <ion-col size="12">
                            <div class="input-group">
                                <label>Tipos de Novedad (Selección múltiple)</label>
                                <div class="chips-container multi-select-grid">
                                    @for (tipo of tiposNovedad(); track tipo.id) {
                                    <ion-chip [class.selected]="isTipoSeleccionado(tipo.id)"
                                        [style.--chip-color]="tipo.color" (click)="toggleTipoSeleccionado(tipo.id)">
                                        <ion-icon [name]="tipo.icono"></ion-icon>
                                        <ion-label>{{ tipo.nombre }}</ion-label>
                                        @if (isTipoSeleccionado(tipo.id)) {
                                        <ion-icon name="checkmark-circle"></ion-icon>
                                        }
                                    </ion-chip>
                                    }
                                </div>
                            </div>
                        </ion-col>

                        <!-- Origen (Multi-select) -->
                        <ion-col size="12">
                            <div class="input-group">
                                <label>Orígenes del Mensaje</label>
                                <div class="chips-container">
                                    @for (origen of ['teams', 'canvas', 'foro', 'email', 'presencial']; track origen) {
                                    <ion-chip [class.selected]="isOrigenSeleccionado(origen)"
                                        [style.--chip-color]="getOrigenColor(origen)"
                                        (click)="toggleOrigenSeleccionado(origen)">
                                        <ion-icon [name]="getOrigenIcon(origen)"></ion-icon>
                                        <ion-label>{{ getOrigenLabel(origen) }}</ion-label>
                                        @if (isOrigenSeleccionado(origen)) {
                                        <ion-icon name="checkmark-circle"></ion-icon>
                                        }
                                    </ion-chip>
                                    }
                                </div>
                            </div>
                        </ion-col>

                        <!-- Comentarios -->
                        <ion-col size="12">
                            <div class="input-group">
                                <label>Comentarios y Observaciones</label>
                                <div class="textarea-container">
                                    <ion-textarea [(ngModel)]="descripcionNovedad"
                                        placeholder="Escriba aquí los detalles..." [autoGrow]="true" rows="3"
                                        class="custom-textarea"></ion-textarea>
                                    <ion-note color="medium">
                                        <ion-icon name="information-circle-outline"></ion-icon>
                                        Estas notas serán visibles en el reporte detallado.
                                    </ion-note>
                                </div>
                            </div>
                        </ion-col>
                    </ion-row>
                </ion-grid>

                <div class="acciones-finales">
                    <ion-button expand="block" color="success" class="btn-confirmar-novedades"
                        [disabled]="tiposSeleccionados().size === 0 || seleccionadosIndices().size === 0"
                        (click)="confirmarNovedadesSeleccionadas()">
                        <ion-icon name="checkmark-done-circle" slot="start"></ion-icon>
                        Registrar Novedad Grupal ({{ seleccionadosIndices().size }} estudiantes)
                    </ion-button>
                    <ion-button expand="block" fill="clear" color="medium" (click)="limpiarFormulario()">
                        Limpiar Formulario
                    </ion-button>
                </div>
            </div>
        </section>
        }
    </div>

    <!-- FAB para móvil -->
    @if (!isDesktop()) {
    <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="registro-fab">
        <ion-fab-button color="primary" (click)="abrirDrawer()">
            <ion-icon name="add-outline"></ion-icon>
        </ion-fab-button>
    </ion-fab>
    }

    <!-- BOTTOM DRAWER (Móvil y Tablet) -->
    <div class="bottom-drawer" [class.visible]="drawerVisible()">
        <div class="drawer-handle" (click)="toggleDrawer()">
            <div class="handle-bar"></div>
        </div>

        <div class="drawer-header">
            <h3>Registrar Novedad</h3>
            <ion-button fill="clear" (click)="cerrarDrawer()">
                <ion-icon slot="icon-only" name="close-outline"></ion-icon>
            </ion-button>
        </div>

        <div class="drawer-content">
            <!-- Estudiantes seleccionados -->
            @if (estudiantesSeleccionados().length === 0) {
            <div class="drawer-empty">
                <ion-icon name="person-outline"></ion-icon>
                <p>Busca y selecciona estudiantes arriba</p>
            </div>
            } @else {
            <div class="drawer-section">
                <label>Estudiantes ({{ estudiantesSeleccionados().length }})</label>
                <div class="drawer-chips">
                    @for (est of estudiantesSeleccionados(); track est.correo) {
                    <ion-chip>
                        <ion-label>{{ est.nombre.split(' ')[0] }} ({{ getCodigoCorto(est.curso) }} G{{ est.grupo
                            }})</ion-label>
                        <ion-icon name="close-outline" (click)="removerEstudiante(est.correo)"></ion-icon>
                    </ion-chip>
                    }
                </div>
            </div>

            <!-- Tipo de novedad -->
            <div class="drawer-section">
                <label>Tipo de novedad</label>
                @if (isDesktop()) {
                <div class="tipo-chips">
                    @for (tipo of tiposNovedad(); track tipo.id) {
                    <ion-chip [class.selected]="tipoNovedadSeleccionado()?.id === tipo.id"
                        [style.--chip-color]="tipo.color" (click)="tipoNovedadSeleccionado.set(tipo)">
                        <ion-icon [name]="tipo.icono"></ion-icon>
                        <ion-label>{{ tipo.nombre }}</ion-label>
                    </ion-chip>
                    }
                </div>
                } @else {
                <ion-button expand="block" fill="outline" (click)="abrirMenuTipos()" class="tipo-selector-btn">
                    @if (tipoNovedadSeleccionado()) {
                    <ion-icon [name]="tipoNovedadSeleccionado()!.icono" slot="start"></ion-icon>
                    {{ tipoNovedadSeleccionado()!.nombre }}
                    } @else {
                    Seleccionar tipo...
                    }
                    <ion-icon name="chevron-down-outline" slot="end"></ion-icon>
                </ion-button>
                }
            </div>

            <!-- Origen -->
            <div class="drawer-section">
                <label>Origen del mensaje</label>
                <div class="origen-chips">
                    @for (origen of ['teams', 'canvas', 'foro', 'email', 'presencial']; track origen) {
                    <ion-chip [class.selected]="origenSeleccionado() === origen"
                        [style.--chip-color]="getOrigenColor(origen)" (click)="origenSeleccionado.set($any(origen))">
                        <ion-icon [name]="getOrigenIcon(origen)"></ion-icon>
                        @if (isDesktop()) {
                        <ion-label>{{ getOrigenLabel(origen) }}</ion-label>
                        }
                    </ion-chip>
                    }
                </div>
            </div>

            <!-- Botón registrar -->
            <ion-button expand="block" color="primary"
                [disabled]="!tipoNovedadSeleccionado() || estudiantesSeleccionados().length === 0"
                (click)="registrarNovedad()" class="registrar-btn">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Registrar Novedad
            </ion-button>
            }
        </div>
    </div>

    <!-- Overlay para drawer -->
    @if (drawerVisible()) {
    <div class="drawer-overlay" (click)="cerrarDrawer()"></div>
    }

</ion-content>