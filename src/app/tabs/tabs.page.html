<!-- Layout sin ion-split-pane - Usando ion-menu est치ndar de Ionic -->

<!-- Sidebar usando ion-menu - SOLO en m칩vil -->
<ion-menu *ngIf="!isDesktop" contentId="main-content" type="overlay" side="start" menuId="mainMenu" class="sidebar-menu">
  <ion-header>
    <ion-toolbar color="primary">
      <ion-avatar slot="start" class="sidebar-logo-avatar">
        <img
          src="https://is1-ssl.mzstatic.com/image/thumb/Purple126/v4/06/80/92/068092b2-333a-a2b3-9348-5a2f9a12eaff/source/60x60bb.jpg"
          alt="Logo Polit칠cnico Grancolombiano" />
      </ion-avatar>
      <ion-title class="sidebar-app-title">POLIProject</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-content>
    <ion-list lines="none" class="sidebar-nav-list">
      <ion-menu-toggle auto-hide="true">
        <ion-item button [routerLink]="['/tabs/inicio']" routerLinkActive="active-menu-item" detail="false">
          <ion-icon slot="start" name="home" color="tertiary"></ion-icon>
          <ion-label>Inicio</ion-label>
        </ion-item>
      </ion-menu-toggle>

      <ion-menu-toggle auto-hide="true">
        <ion-item button [routerLink]="['/tabs/cursos']" routerLinkActive="active-menu-item" detail="false">
          <ion-icon slot="start" name="school" color="primary"></ion-icon>
          <ion-label>Cursos</ion-label>
        </ion-item>
      </ion-menu-toggle>

      <ion-menu-toggle auto-hide="true">
        <ion-item button [routerLink]="['/tabs/rubricas']" routerLinkActive="active-menu-item" detail="false">
          <ion-icon slot="start" name="document-text" color="warning"></ion-icon>
          <ion-label>R칰bricas de Evaluaci칩n</ion-label>
        </ion-item>
      </ion-menu-toggle>

      <ion-menu-toggle auto-hide="true">
        <ion-item button [routerLink]="['/tabs/calificaciones']" routerLinkActive="active-menu-item" detail="false">
          <ion-icon slot="start" name="star" color="success"></ion-icon>
          <ion-label>Calificaciones</ion-label>
        </ion-item>
      </ion-menu-toggle>

      <ion-menu-toggle auto-hide="true">
        <ion-item button [routerLink]="['/tabs/sistema']" routerLinkActive="active-menu-item" detail="false">
          <ion-icon slot="start" name="cog" color="medium"></ion-icon>
          <ion-label>Sistema</ion-label>
        </ion-item>
      </ion-menu-toggle>
    </ion-list>
  </ion-content>

  <ion-footer class="sidebar-footer">
    <ion-toolbar>
      <div class="footer-actions">
        <ion-button fill="clear" expand="block" (click)="toggleFullscreen()" class="footer-btn">
          <ion-icon slot="start" name="expand-outline"></ion-icon>
          <ion-label>Pantalla completa</ion-label>
        </ion-button>
        <ion-button fill="clear" expand="block" (click)="toggleSearch()" class="footer-btn">
          <ion-icon slot="start" [name]="searchExpanded ? 'close-outline' : 'search-outline'"></ion-icon>
          <ion-label>{{ searchExpanded ? 'Cerrar' : 'Buscar' }}</ion-label>
        </ion-button>
      </div>
    </ion-toolbar>
  </ion-footer>
</ion-menu>

<!-- Sidebar permanente para desktop - sin ion-split-pane -->
<ion-card class="desktop-sidebar" [class.collapsed]="!sidebarExpanded" *ngIf="isDesktop">
  <ion-card-header>
    <ion-avatar class="sidebar-logo-avatar">
      <img
        src="https://is1-ssl.mzstatic.com/image/thumb/Purple126/v4/06/80/92/068092b2-333a-a2b3-9348-5a2f9a12eaff/source/60x60bb.jpg"
        alt="Logo Polit칠cnico Grancolombiano" />
    </ion-avatar>
    <span class="sidebar-title">POLIProject</span>
  </ion-card-header>

  <ion-card-content class="desktop-sidebar-content">
    <ion-list lines="none" class="desktop-nav-list">
      <ion-item button [routerLink]="['/tabs/inicio']" routerLinkActive="active-menu-item" detail="false" class="nav-item">
        <ion-icon slot="start" [name]="currentUrl.includes('/tabs/inicio') ? 'home' : 'home-outline'"></ion-icon>
        <ion-label>Inicio</ion-label>
      </ion-item>

      <ion-item button [routerLink]="['/tabs/cursos']" routerLinkActive="active-menu-item" detail="false" class="nav-item">
        <ion-icon slot="start" [name]="currentUrl.includes('/tabs/cursos') ? 'library' : 'library-outline'"></ion-icon>
        <ion-label>Cursos</ion-label>
      </ion-item>

      <ion-item button [routerLink]="['/tabs/rubricas']" routerLinkActive="active-menu-item" detail="false" class="nav-item">
        <ion-icon slot="start" [name]="currentUrl.includes('/tabs/rubricas') ? 'speedometer' : 'speedometer-outline'"></ion-icon>
        <ion-label>R칰bricas</ion-label>
      </ion-item>

      <ion-item button [routerLink]="['/tabs/calificaciones']" routerLinkActive="active-menu-item" detail="false" class="nav-item">
        <ion-icon slot="start" [name]="currentUrl.includes('/tabs/calificaciones') ? 'ribbon' : 'ribbon-outline'"></ion-icon>
        <ion-label>Calificaciones</ion-label>
      </ion-item>

      <ion-item button [routerLink]="['/tabs/sistema']" routerLinkActive="active-menu-item" detail="false" class="nav-item">
        <ion-icon slot="start" [name]="currentUrl.includes('/tabs/sistema') ? 'settings' : 'settings-outline'"></ion-icon>
        <ion-label>Sistema</ion-label>
      </ion-item>
    </ion-list>
  </ion-card-content>

  <ion-footer class="sidebar-footer-desktop">
    <ion-button fill="clear" class="expand-btn" (click)="toggleSidebar()">
      <ion-icon slot="icon-only" [name]="sidebarExpanded ? 'arrow-back-outline' : 'arrow-forward-outline'"></ion-icon>
    </ion-button>
  </ion-footer>
</ion-card>

<!-- Contenido principal - SOLO ion-router-outlet sin ion-tabs -->
<div id="main-content" class="main-content-area" [class.sidebar-collapsed]="!sidebarExpanded">
  <ion-router-outlet></ion-router-outlet>
</div>

<!-- FAB para abrir men칰 y panel de seguimiento en m칩vil -->
@if (!isDesktop) {
<div class="mobile-fab-container">
  <!-- FAB para abrir men칰 lateral -->
  <ion-fab vertical="bottom" horizontal="start" slot="fixed" class="menu-fab">
    <ion-fab-button size="small" color="primary" (click)="openMenu()">
      <ion-icon name="menu-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- FAB para abrir panel de seguimiento -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="seguimiento-fab">
    <ion-fab-button size="small" color="secondary" (click)="toggleMobileSeguimiento()">
      <ion-icon [name]="mobileSeguimientoVisible ? 'close-outline' : 'book-outline'"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</div>
}

<!-- Hidden navigation helper (para mantener compatibilidad con rutas) -->
<div class="hidden-navigation-helper">
  <ion-tab-bar class="hidden-tab-bar">
    <ion-tab-button tab="inicio" href="/tabs/inicio"></ion-tab-button>
    <ion-tab-button tab="cursos" href="/tabs/cursos"></ion-tab-button>
    <ion-tab-button tab="rubricas" href="/tabs/rubricas"></ion-tab-button>
    <ion-tab-button tab="calificaciones" href="/tabs/calificaciones"></ion-tab-button>
    <ion-tab-button tab="sistema" href="/tabs/sistema"></ion-tab-button>
  </ion-tab-bar>
</div>

<!-- Panel de Seguimiento - posici칩n fija a la derecha (Desktop) -->
<ion-card class="panel-seguimiento-global" *ngIf="isDesktop">
        <ion-card-header class="panel-seguimiento-header">
          <ion-card-title><ion-icon name="book"></ion-icon> Seguimiento</ion-card-title>
        </ion-card-header>
        <ion-card-content class="panel-seguimiento-content">

          <!-- Resultados de B칰squeda Global -->
          @if (searchTerm && searchResults.length > 0) {
          <div class="seguimiento-section search-results-section">
            <ion-label class="section-title">
              游댌 RESULTADOS ({{searchResults.length}})
            </ion-label>
            <ion-list class="search-results-list" lines="none">
              @for (result of searchResults; track result.estudiante.correo) {
              <ion-item button class="search-result-item">
                <ion-label>
                  <h3 class="student-name">{{result.estudiante.nombres}} {{result.estudiante.apellidos}}</h3>
                  <p class="student-email">{{result.estudiante.correo}}</p>
                  <div class="badges-container">
                    <ion-badge color="primary" class="curso-badge">{{result.cursoNombre}}</ion-badge>
                    @if (result.estudiante.grupo) {
                    <ion-badge color="secondary" class="grupo-badge">Grupo {{result.estudiante.grupo}}</ion-badge>
                    }
                  </div>
                </ion-label>
                <ion-icon slot="end" name="chevron-forward-outline" color="medium"></ion-icon>
              </ion-item>
              }
            </ion-list>
          </div>
          } @else if (searchTerm && searchResults.length === 0) {
          <div class="seguimiento-placeholder">
            <ion-icon name="search" size="large" color="medium"></ion-icon>
            <h4>Sin resultados</h4>
            <p>No se encontraron estudiantes con "{{searchTerm}}"</p>
          </div>
          }

          <!-- Mensaje cuando no hay curso activo -->
          @if (!mostrarGrupos && !searchTerm) {
          <div class="seguimiento-placeholder">
            <ion-icon name="school" size="large" color="medium"></ion-icon>
            <h4>Sin curso activo</h4>
            <p>Seleccione un curso en la pesta침a <strong>"Cursos"</strong> para ver el seguimiento de grupos.</p>
          </div>
          }

          <!-- Secci칩n de Puntos/R칰bricas - Visible cuando hay grupo visualizado -->
          @if (grupoVisualizado > 0) {
          <div class="seguimiento-section puntos-section">
            <!-- Barra unificada de selecci칩n de r칰brica -->
            <div class="rubrica-selector-bar">
              <!-- Toggle tipo de r칰brica con 칤conos -->
              <div class="tipo-rubrica-toggle">
                <button type="button"
                        class="tipo-btn"
                        [class.activo]="tipoRubricaSeleccionado === 'PG'"
                        (click)="tipoRubricaSeleccionado = 'PG'"
                        title="R칰brica Grupal">
                  <ion-icon name="people"></ion-icon>
                  <span>Grupal</span>
                </button>
                <button type="button"
                        class="tipo-btn"
                        [class.activo]="tipoRubricaSeleccionado === 'PI'"
                        (click)="tipoRubricaSeleccionado = 'PI'"
                        title="R칰brica Individual">
                  <ion-icon name="person"></ion-icon>
                  <span>Individual</span>
                </button>
              </div>

              <!-- Separador visual -->
              <div class="selector-divider"></div>

              <!-- Botones de entrega -->
              <div class="entrega-buttons">
                <button type="button"
                        class="entrega-btn"
                        (click)="abrirRubricaEntrega('E1', tipoRubricaSeleccionado)"
                        title="Entrega 1">
                  E1
                </button>
                <button type="button"
                        class="entrega-btn"
                        (click)="abrirRubricaEntrega('E2', tipoRubricaSeleccionado)"
                        title="Entrega 2">
                  E2
                </button>
                <button type="button"
                        class="entrega-btn"
                        (click)="abrirRubricaEntrega('EF', tipoRubricaSeleccionado)"
                        title="Entrega Final">
                  EF
                </button>
              </div>
            </div>
          </div>
          }

          <!-- Tabla de integrantes - Visible cuando hay grupo visualizado -->
          @if (grupoVisualizado > 0 && integrantesGrupoActual.length > 0) {
          <div class="seguimiento-section integrantes-section">
            <!-- Toolbar de estados - Siempre visible cuando hay integrantes -->
            <div class="estados-toolbar-panel">
              <ion-button
                [fill]="modoSeleccionEstado === 'ok' ? 'solid' : 'outline'"
                size="small"
                color="success"
                (click)="toggleModoSeleccionEstado('ok')"
                title="Marcar Ok">
                <ion-icon name="checkmark-circle" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button
                [fill]="modoSeleccionEstado === 'solo' ? 'solid' : 'outline'"
                size="small"
                color="warning"
                (click)="toggleModoSeleccionEstado('solo')"
                title="Marcar Solo">
                <ion-icon name="git-merge" slot="icon-only"></ion-icon>
              </ion-button>
              <ion-button
                [fill]="modoSeleccionEstado === 'ausente' ? 'solid' : 'outline'"
                size="small"
                color="danger"
                (click)="toggleModoSeleccionEstado('ausente')"
                title="Marcar Ausente">
                <ion-icon name="close-circle" slot="icon-only"></ion-icon>
              </ion-button>
              @if (modoSeleccionEstado) {
              <ion-button
                fill="clear"
                size="small"
                color="medium"
                (click)="salirModoSeleccion()"
                title="Salir del modo de selecci칩n">
                <ion-icon name="close-outline" slot="icon-only"></ion-icon>
              </ion-button>
              }
            </div>
            <div class="integrantes-table-container">
              <table class="integrantes-calificaciones-table responsive-table">
                <thead>
                  <tr>
                    <th class="col-check">
                      <ion-checkbox
                        [checked]="areAllIntegrantesSelected()"
                        [indeterminate]="selectedIntegrantes.size > 0 && !areAllIntegrantesSelected()"
                        (ionChange)="toggleSelectAllIntegrantes()"
                        mode="ios">
                      </ion-checkbox>
                    </th>
                    <th class="col-nombre">ESTUDIANTE</th>
                    <th class="col-entrega">E1</th>
                    <th class="col-entrega">E2</th>
                    <th class="col-entrega">EF</th>
                    <th class="col-total">
                      <ion-icon name="trophy"></ion-icon>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  @for (integrante of integrantesGrupoActual; track integrante.correo) {
                  <tr class="integrante-row"
                      [class.selected]="isIntegranteSelected(integrante.correo)"
                      [class.estado-ok]="getEstadoEstudiante(integrante.correo) === 'ok'"
                      [class.estado-solo]="getEstadoEstudiante(integrante.correo) === 'solo'"
                      [class.estado-ausente]="getEstadoEstudiante(integrante.correo) === 'ausente'">
                    <td class="col-check">
                      <ion-checkbox
                        [checked]="isIntegranteSelected(integrante.correo)"
                        (ionChange)="toggleIntegranteSelection(integrante.correo, $event)"
                        mode="ios">
                      </ion-checkbox>
                    </td>
                    <td class="col-nombre">
                      @if (getEstadoEstudiante(integrante.correo)) {
                        <ion-icon [name]="getIconoEstado(getEstadoEstudiante(integrante.correo))" [color]="getColorEstado(getEstadoEstudiante(integrante.correo))" class="estado-icono"></ion-icon>
                      }
                      <span class="nombre-estudiante" [title]="integrante.apellidos + ', ' + integrante.nombres">{{ integrante.apellidos }}, {{ integrante.nombres }}</span>
                    </td>
                    <td class="col-entrega editable-cell" (click)="iniciarEdicionCalificacion(integrante, 'E1', $event)">
                      @if (estaEditandoCalificacion(integrante, 'E1')) {
                        <input type="text"
                               class="edit-input-inline"
                               placeholder="Nota"
                               title="Editar E1"
                               [(ngModel)]="valorCalificacionEditando"
                               (blur)="guardarCalificacionInicio()"
                               (keydown)="onKeyDownCalificacion($event)"
                               autofocus />
                      } @else {
                        <span class="calificacion-badge"
                          [class.canvas]="tieneCalificacionCanvas(integrante, 'E1')"
                          [class.success]="obtenerCalificacionEstudiante(integrante, 'E1') >= 4.0"
                          [class.warning]="obtenerCalificacionEstudiante(integrante, 'E1') >= 3.0 && obtenerCalificacionEstudiante(integrante, 'E1') < 4.0"
                          [class.danger]="obtenerCalificacionEstudiante(integrante, 'E1') > 0 && obtenerCalificacionEstudiante(integrante, 'E1') < 3.0"
                          [class.empty]="obtenerCalificacionEstudiante(integrante, 'E1') === 0">
                          {{ obtenerCalificacionEstudiante(integrante, 'E1') || '-' }}
                        </span>
                      }
                    </td>
                    <td class="col-entrega editable-cell" (click)="iniciarEdicionCalificacion(integrante, 'E2', $event)">
                      @if (estaEditandoCalificacion(integrante, 'E2')) {
                        <input type="text"
                               class="edit-input-inline"
                               placeholder="Nota"
                               title="Editar E2"
                               [(ngModel)]="valorCalificacionEditando"
                               (blur)="guardarCalificacionInicio()"
                               (keydown)="onKeyDownCalificacion($event)"
                               autofocus />
                      } @else {
                        <span class="calificacion-badge"
                          [class.canvas]="tieneCalificacionCanvas(integrante, 'E2')"
                          [class.success]="obtenerCalificacionEstudiante(integrante, 'E2') >= 4.0"
                          [class.warning]="obtenerCalificacionEstudiante(integrante, 'E2') >= 3.0 && obtenerCalificacionEstudiante(integrante, 'E2') < 4.0"
                          [class.danger]="obtenerCalificacionEstudiante(integrante, 'E2') > 0 && obtenerCalificacionEstudiante(integrante, 'E2') < 3.0"
                          [class.empty]="obtenerCalificacionEstudiante(integrante, 'E2') === 0">
                          {{ obtenerCalificacionEstudiante(integrante, 'E2') || '-' }}
                        </span>
                      }
                    </td>
                    <td class="col-entrega editable-cell" (click)="iniciarEdicionCalificacion(integrante, 'EF', $event)">
                      @if (estaEditandoCalificacion(integrante, 'EF')) {
                        <input type="text"
                               class="edit-input-inline"
                               placeholder="Nota"
                               title="Editar EF"
                               [(ngModel)]="valorCalificacionEditando"
                               (blur)="guardarCalificacionInicio()"
                               (keydown)="onKeyDownCalificacion($event)"
                               autofocus />
                      } @else {
                        <span class="calificacion-badge"
                          [class.canvas]="tieneCalificacionCanvas(integrante, 'EF')"
                          [class.success]="obtenerCalificacionEstudiante(integrante, 'EF') >= 4.0"
                          [class.warning]="obtenerCalificacionEstudiante(integrante, 'EF') >= 3.0 && obtenerCalificacionEstudiante(integrante, 'EF') < 4.0"
                          [class.danger]="obtenerCalificacionEstudiante(integrante, 'EF') > 0 && obtenerCalificacionEstudiante(integrante, 'EF') < 3.0"
                          [class.empty]="obtenerCalificacionEstudiante(integrante, 'EF') === 0">
                          {{ obtenerCalificacionEstudiante(integrante, 'EF') || '-' }}
                        </span>
                      }
                    </td>
                    <td class="col-total">
                      <span class="total-badge">
                        {{ obtenerTotalEstudiante(integrante) || '-' }}
                      </span>
                    </td>
                  </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
          }

          <!-- Comentarios del grupo -->
          @if (mostrarGrupos) {
          <div class="seguimiento-section comentarios-section-wrapper">
            <div class="comentarios-section" [class.comentarios-fijados]="comentariosFijados">
              <ion-item class="comentarios-header" button (click)="toggleComentarios()" lines="none">
                <ion-icon name="chatbubble" slot="start"></ion-icon>
                <ion-label class="comentarios-label">Comentarios</ion-label>
                <div class="comentarios-controls" slot="end">
                  <ion-button fill="clear" size="small" (click)="toggleFijarComentarios(); $event.stopPropagation()"
                    [color]="comentariosFijados ? 'primary' : 'medium'">
                    <ion-icon slot="icon-only" name="pin-outline"></ion-icon>
                  </ion-button>
                  @if (!comentariosFijados) {
                  <ion-icon [name]="comentariosColapsado ? 'chevron-down-outline' : 'chevron-up-outline'"
                    class="collapse-icon">
                  </ion-icon>
                  }
                </div>
              </ion-item>

              @if (!comentariosColapsado || comentariosFijados) {
              <div class="comentarios-content" [@slideInOut]>
                @if (selectedGrupo === 0) {
                <p class="no-comentarios">Selecciona un grupo para ver los comentarios</p>
                } @else {
                  <!-- Input para agregar nuevo comentario -->
                  <div class="nuevo-comentario-form">
                    <ion-textarea
                      [(ngModel)]="nuevoComentarioTexto"
                      placeholder="Escribe un comentario sobre este grupo..."
                      [autoGrow]="true"
                      [rows]="2"
                      class="comentario-textarea"
                    ></ion-textarea>
                    <ion-button
                      size="small"
                      (click)="agregarComentario()"
                      [disabled]="!nuevoComentarioTexto.trim()"
                      class="btn-agregar-comentario"
                    >
                      <ion-icon slot="start" name="add-circle-outline"></ion-icon>
                      Agregar
                    </ion-button>
                  </div>

                  @if (comentariosGrupoActual.length === 0) {
                  <p class="no-comentarios">No hay comentarios registrados para este grupo</p>
                  } @else {
                  <ion-list class="comentarios-lista" lines="none">
                    @for (comentario of comentariosGrupoActual; track comentario.id) {
                    <ion-card class="comentario-card">
                      <ion-card-header>
                        <ion-badge color="medium">{{ comentario.fecha | date: 'dd/MM/yyyy HH:mm' }}</ion-badge>
                        <ion-badge color="primary">{{ comentario.autor }}</ion-badge>
                        <div class="comentario-acciones">
                          <ion-button fill="clear" size="small" (click)="iniciarEdicionComentario(comentario)">
                            <ion-icon slot="icon-only" name="pencil-outline" color="primary"></ion-icon>
                          </ion-button>
                          <ion-button fill="clear" size="small" (click)="eliminarComentario(comentario.id)">
                            <ion-icon slot="icon-only" name="trash-outline" color="danger"></ion-icon>
                          </ion-button>
                        </div>
                      </ion-card-header>
                      @if (editandoComentarioId === comentario.id) {
                      <ion-card-content class="comentario-edicion">
                        <ion-textarea
                          [(ngModel)]="editandoComentarioTexto"
                          [autoGrow]="true"
                          class="comentario-textarea edicion"
                        ></ion-textarea>
                        <div class="edicion-acciones">
                          <ion-button size="small" fill="outline" (click)="cancelarEdicionComentario()">
                            Cancelar
                          </ion-button>
                          <ion-button size="small" (click)="guardarEdicionComentario()">
                            <ion-icon slot="start" name="checkmark-outline"></ion-icon>
                            Guardar
                          </ion-button>
                        </div>
                      </ion-card-content>
                      } @else {
                      <ion-card-content class="comentario-texto">
                        {{ comentario.comentario }}
                      </ion-card-content>
                      }
                    </ion-card>
                    }
                  </ion-list>
                  }
                }
              </div>
              }
            </div>

            <!-- 츼rea de evaluaci칩n de r칰brica -->
            @if (tieneTextoRubrica || tieneEvaluacionRubrica) {
            <div class="rubrica-seguimiento-area">
              <div class="rubrica-header">
                <h3>游늵 Evaluaci칩n de R칰brica</h3>
                <ion-button fill="clear" size="small" (click)="copiarTextoSeguimiento()">
                  <ion-icon slot="icon-only" name="copy-outline"></ion-icon>
                  <span class="btn-label">Copiar Todo</span>
                </ion-button>
              </div>

              <!-- Evaluaci칩n Grupal (PG) -->
              @if (seguimientoActual?.evaluacionGrupal && seguimientoActual?.tipoEvaluacionActiva === 'PG') {
              <div class="texto-seguimiento-seccion">
                <h4>Calificaci칩n Grupal</h4>
                <div class="texto-contenido">
                  <p>Puntos Grupo: {{ seguimientoActual?.evaluacionGrupal?.puntosTotal || 0 }}</p>
                  @for (criterio of seguimientoActual?.evaluacionGrupal?.criterios || []; track $index) {
                  <div class="criterio-texto">
                    <p>游릭 [{{ criterio.nombreCriterio }}]</p>
                    <p>{{ getNivelesYRangos(criterio) }}</p>
                    <p [style.color]="getColorNivel(criterio.nivelSeleccionado, criterio.niveles)">
                      {{ criterio.nivelSeleccionado }} ({{ getIntervaloSeleccionado(criterio) }})
                    </p>
                    <p>Asignados: {{ criterio.puntosAsignados }} pts {{ criterio.comentario ? '+ ' + criterio.comentario : '' }}</p>
                    <p>{{ getDescripcionNivel(criterio) }}</p>
                  </div>
                  }
                </div>
              </div>
              }

              <!-- Evaluaci칩n Individual (PI) -->
              @if (seguimientoActual?.evaluacionIndividual && seguimientoActual?.tipoEvaluacionActiva === 'PI') {
              <div class="texto-seguimiento-seccion">
                <h4>Calificaci칩n Individual</h4>
                @if (integranteSeleccionado) {
                <p class="integrante-info">
                  <ion-icon name="person"></ion-icon>
                  {{ integranteSeleccionado.nombres }} {{ integranteSeleccionado.apellidos }}
                </p>
                }
                <div class="texto-contenido">
                  <p>Puntos Individuales: {{ seguimientoActual?.evaluacionIndividual?.puntosTotal || 0 }}</p>
                  @for (criterio of seguimientoActual?.evaluacionIndividual?.criterios || []; track $index) {
                  <div class="criterio-texto">
                    <p>游릭 [{{ criterio.nombreCriterio }}]</p>
                    <p>{{ getNivelesYRangos(criterio) }}</p>
                    <p [style.color]="getColorNivel(criterio.nivelSeleccionado, criterio.niveles)">
                      {{ criterio.nivelSeleccionado }} ({{ getIntervaloSeleccionado(criterio) }})
                    </p>
                    <p>Asignados: {{ criterio.puntosAsignados }} pts {{ criterio.comentario ? '+ ' + criterio.comentario : '' }}</p>
                    <p>{{ getDescripcionNivel(criterio) }}</p>
                  </div>
                  }
                </div>
              </div>
              }

              <!-- Total combinado -->
              @if (seguimientoActual?.evaluacionGrupal && seguimientoActual?.evaluacionIndividual && !seguimientoActual?.tipoEvaluacionActiva) {
              <div class="texto-seguimiento-seccion">
                <p><strong>Puntos Totales: {{ totalPuntos }} puntos</strong></p>
              </div>
              }
            </div>
            }
          </div>
          }
        </ion-card-content>
      </ion-card>

<!-- Panel de Seguimiento M칩vil - Deslizante desde abajo -->
@if (!isDesktop) {
<div class="mobile-seguimiento-panel" [class.visible]="mobileSeguimientoVisible">
  <div class="mobile-panel-header">
    <div class="panel-title">
      <ion-icon name="book"></ion-icon>
      <span>Seguimiento</span>
    </div>
    <ion-button fill="clear" size="small" (click)="toggleMobileSeguimiento()">
      <ion-icon name="close-outline" slot="icon-only"></ion-icon>
    </ion-button>
  </div>
  <div class="mobile-panel-content">
    <!-- Mensaje cuando no hay curso activo -->
    @if (!mostrarGrupos && !searchTerm) {
    <div class="seguimiento-placeholder-mobile">
      <ion-icon name="school" size="large" color="medium"></ion-icon>
      <h4>Sin curso activo</h4>
      <p>Seleccione un curso en la pesta침a <strong>"Cursos"</strong> para ver el seguimiento.</p>
    </div>
    }

    <!-- Secci칩n de Puntos Mobile -->
    @if (grupoVisualizado > 0) {
    <div class="mobile-puntos-section">
      <div class="puntos-header-mobile">
        <span class="section-title-mobile">PUNTOS</span>
        <ion-segment [(ngModel)]="tipoRubricaSeleccionado" mode="ios" class="puntos-toggle-mobile">
          <ion-segment-button value="PG"><ion-label>Grupal</ion-label></ion-segment-button>
          <ion-segment-button value="PI"><ion-label>Individual</ion-label></ion-segment-button>
        </ion-segment>
      </div>
      <div class="rubricas-grid-mobile">
        <ion-button size="small" fill="outline" (click)="abrirRubricaEntrega('E1', tipoRubricaSeleccionado)">E1</ion-button>
        <ion-button size="small" fill="outline" (click)="abrirRubricaEntrega('E2', tipoRubricaSeleccionado)">E2</ion-button>
        <ion-button size="small" fill="outline" (click)="abrirRubricaEntrega('EF', tipoRubricaSeleccionado)">EF</ion-button>
      </div>
    </div>

    <!-- Integrantes Mobile -->
    @if (integrantesGrupoActual.length > 0) {
    <div class="mobile-integrantes-section">
      <span class="section-title-mobile">INTEGRANTES ({{ integrantesGrupoActual.length }})</span>
      <div class="integrantes-list-mobile">
        @for (integrante of integrantesGrupoActual; track integrante.correo) {
        <div class="integrante-item-mobile" [class.estado-ok]="getEstadoEstudiante(integrante.correo) === 'ok'"
             [class.estado-solo]="getEstadoEstudiante(integrante.correo) === 'solo'"
             [class.estado-ausente]="getEstadoEstudiante(integrante.correo) === 'ausente'">
          @if (getEstadoEstudiante(integrante.correo)) {
          <ion-icon [name]="getIconoEstado(getEstadoEstudiante(integrante.correo))"
                    [color]="getColorEstado(getEstadoEstudiante(integrante.correo))" class="estado-icono-mobile"></ion-icon>
          }
          <span class="nombre-mobile">{{ integrante.apellidos }}, {{ integrante.nombres }}</span>
          <div class="calificaciones-mobile">
            <span class="cal-badge-mobile" [class.success]="obtenerCalificacionEstudiante(integrante, 'E1') >= 4.0">
              {{ obtenerCalificacionEstudiante(integrante, 'E1') || '-' }}
            </span>
            <span class="cal-badge-mobile" [class.success]="obtenerCalificacionEstudiante(integrante, 'E2') >= 4.0">
              {{ obtenerCalificacionEstudiante(integrante, 'E2') || '-' }}
            </span>
            <span class="cal-badge-mobile" [class.success]="obtenerCalificacionEstudiante(integrante, 'EF') >= 4.0">
              {{ obtenerCalificacionEstudiante(integrante, 'EF') || '-' }}
            </span>
          </div>
        </div>
        }
      </div>
    </div>
    }
    }
  </div>
</div>
}

<!-- Overlay para cerrar el panel m칩vil -->
@if (!isDesktop) {
<div class="mobile-seguimiento-overlay" [class.visible]="mobileSeguimientoVisible" (click)="toggleMobileSeguimiento()"></div>
}

<!-- Barra de b칰squeda flotante cuando se expande -->
@if (searchExpanded) {
<div class="floating-search-container">
  <ion-searchbar #searchBar class="floating-searchbar" [(ngModel)]="globalSearch" (ionInput)="onGlobalSearch($event)"
    (ionCancel)="closeSearch()" (ionBlur)="onSearchBlur()" placeholder="Buscar..." debounce="300"
    show-clear-button="focus" clear-icon="close-circle-outline">
  </ion-searchbar>
</div>
}
